# ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•  

è¿™äº›æ—¥å­ä½ æ˜¯è¢«åŠ¨çš„æ¥å—è¿™äº›çŸ¥è¯†è¿˜æ˜¯ç§¯æçš„æŠ•å…¥å®æˆ˜ï¼Ÿæˆ‘å¸Œæœ›ä½ ä¸€ç›´æ˜¯ç§¯æä¸»åŠ¨åœ°åœ¨ç»ƒä¹ ã€‚I really do:)  

è¿˜è®°å¾—å­”å­è¯´è¿‡çš„å—ï¼Ÿ(å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹)  
"I hear and I forget"(å¬è¿‡ï¼Œå¿˜äº†)  
![LSBAWS_confucius_hear.png](img/04/LSBAWS_confucius_hear.png)  
"I see and I remember"(è§è¿‡ï¼ŒçŸ¥é“)  
![LSBAWS_confucius_see.png](img/04/LSBAWS_confucius_see.png)  
"I do and I understand"(åšè¿‡ï¼Œå¦‚æ•°å®¶ç)  
![LSBAWS_confucius_do.png](img/04/LSBAWS_confucius_do.png)  

åœ¨å‰é¢çš„ç³»åˆ—ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº†å¦‚ä½•è§£æ(è¯†åˆ«)ã€è§£é‡Šä»»æ„é¡¹æ•°çš„åŠ å‡è¿ç®—ï¼Œåƒæ˜¯"7 - 3 + 2 - 1"ã€‚åŒæ—¶ä¹Ÿå­¦ä¹ äº†ä»€ä¹ˆæ˜¯è¯­æ³•å›¾ï¼Œä»¥åŠå¦‚ä½•è¯†åˆ«ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ã€‚  
ä»Šå¤©æˆ‘ä»¬å°±æ¥å­¦ä¹ å¦‚ä½•è§£æã€è§£é‡Šæ‰§è¡Œå¤šé¡¹ä¹˜é™¤æ³•è¿ç®—ï¼Œä¾‹å¦‚"7 * 4 / 2 * 3"ã€‚è¿™é‡Œçš„é™¤æ³•æ˜¯æŒ‡æ•´æ•°çš„é™¤æ³•ï¼š"9 / 4 = 2"(*è¯‘æ³¨ï¼šè¯‘è€…åœ¨Python 3.7 é‡Œé¢å®é™…ä¸Šå¾—åˆ°çš„ç»“æœæ˜¯2.25*)  

ä»Šå¤©æˆ‘ä»¬ä¹Ÿä¼šå¤šèŠ±ä¸€ç‚¹ç²¾åŠ›æ¥è®¨è®ºä¸€ä¸ªåœ¨è¯­æ³•åˆ†æä¸­å¹¿æ³›åº”ç”¨çš„çŸ¥è¯†ç‚¹ï¼š **ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•**(context-free grammars, ç®€ç§°grammars) æˆ–è€… **å·´ç§‘æ–¯èŒƒå¼**(Backus-Naur Form, BNF)ã€‚æœ¬æ–‡ä¸­ä½¿ç”¨çš„æ›´åƒæ˜¯ **æ‰©å±•å·´ç§‘æ–¯èŒƒå¼**(EBNF) è€Œä¸æ˜¯çº¯ç²¹çš„BNFã€‚  
ä¹‹æ‰€ä»¥é€‰æ‹©ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ï¼ŒåŸå› å¦‚ä¸‹ï¼š  

1. ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•èƒ½ä»¥éå¸¸ç®€æ´çš„æ–¹å¼æ¥è¡¨ç¤ºç¼–ç¨‹è¯­è¨€ã€‚ä¸è¯­æ³•å›¾ä¸åŒï¼Œä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ç»“æ„éå¸¸ç´§å‡‘ï¼Œåœ¨ä»¥åçš„æ–‡ç« ä¸­çš„åº”ç”¨ä¼šéå¸¸é¢‘ç¹ã€‚  
2. ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•å¯ä»¥ä½œä¸ºå¾ˆå¥½çš„æ–‡æ¡£(*åŸæ–‡ï¼šA grammar can serve as great documentation.*)  
3. å¦‚æœæˆ‘ä»¬è¦ä»å¤´å¼€å§‹æ„å»ºè§£æå™¨çš„è¯ï¼Œä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ä¼šæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ç»„éå¸¸ç®€æ´çš„è§„åˆ™å°†è¯­æ³•è½¬åŒ–ä¸ºä»£ç ã€‚  
4. ç°åœ¨æœ‰å¾ˆå¤š`è§£æå™¨ç”Ÿæˆå™¨(parser generators)`å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†è¾“å…¥çš„è¯­æ³•ç”Ÿæˆä¸ºä¸€ä¸ªè§£æå™¨ã€‚æˆ‘ä»¬åé¢ä¼šè®²åˆ°ã€‚  

ç°åœ¨ï¼Œå°±è®©æˆ‘ä»¬ä»æœºå™¨æ–¹é¢æ¥è®¨è®ºä¸€ä¸‹ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•å§ï¼š  
ä¸‹é¢ç®—æœ¯è¡¨è¾¾å¼"7 * 4 / 2 * 3(*è¯·å¿½ç•¥ç©ºæ ¼*)"(é€šè¿‡ä¸‹é¢çš„è¯­æ³•å¯ä»¥ç”Ÿæˆæ— æ•°æ¡è¡¨è¾¾å¼ï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ª)ï¼š  
![lsbasi_part4_bnf1.png](img/04/lsbasi_part4_bnf1.png)  

`ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•(grammar)`å¯ä»¥ç”±ä¸€ç³»åˆ—çš„`è§„åˆ™(rule, production)`ç»„æˆï¼Œåœ¨ä¸Šé¢çš„è¯­æ³•ä¸­ï¼Œå…±æœ‰ä¸¤æ¡è§„åˆ™ï¼š  
![lsbasi_part4_bnf2.png](img/04/lsbasi_part4_bnf2.png)  

ä¸€æ¡è§„åˆ™ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š`è§„åˆ™å¤´(header)`ã€`åˆ†å·(colon)`ã€`è§„åˆ™ä½“(body)`ã€‚å…¶ä¸­è§„åˆ™å¤´ä¹Ÿå«è§„åˆ™çš„å·¦è¾¹ï¼Œæ˜¯ä¸€ä¸ª`éç»ˆç»“ç¬¦(non-terminal)`ï¼›è§„åˆ™ä½“ä¹Ÿç§°ä½œè§„åˆ™çš„å³è¾¹ï¼Œæ˜¯ç”±ä¸€ç³»åˆ—çš„éç»ˆç»“ç¬¦å’Œ`ç»ˆç»“ç¬¦(terminal)`ç»„æˆçš„æ··åˆä½“ã€‚  
![lsbasi_part4_bnf3.png](img/04/lsbasi_part4_bnf3.png)  

åœ¨ä¸Šå›¾æ‰€ç¤ºçš„è¯­æ³•ä¸­ï¼ŒåƒDIVã€MULã€INTEGER è¿™ç±»çš„`è¯(token)`è¢«ç§°ä¸º`ç»ˆç»“ç¬¦(terminal)`(*è¯‘æ³¨ï¼šå…·æœ‰æ„ä¹‰çš„æœ€å°å•ä½ï¼Œæ— æ³•å†ç»§ç»­ç»†åˆ†*)ï¼Œè€Œåƒ*expr*ã€*factor* è¿™ç§å¯ä»¥åˆ†å‰²æˆä¸€ä¸ªæˆ–å¤šä¸ªç»ˆç»“ç¬¦æˆ–éç»ˆç»“ç¬¦çš„ï¼Œè¢«ç§°ä¸º`éç»ˆç»“ç¬¦(non-terminal)`(*æœ‰ä¸€ç§é€’å½’çš„æ„æ€åœ¨é‡Œé¢*)ã€‚  
![lsbasi_part4_bnf4.png](img/04/lsbasi_part4_bnf4.png)  

è‡ªä¸Šè€Œä¸‹ç¬¬ä¸€æ¡è§„åˆ™çš„å¤´éƒ¨è¢«ç§°ä¸º`èµ·å§‹ç¬¦(start symbol)`ï¼Œä¸Šå›¾æ‰€ç¤ºçš„è¯­æ³•çš„èµ·å§‹ç¬¦æ˜¯*expr*ã€‚  
![lsbasi_part4_bnf5.png](img/04/lsbasi_part4_bnf5.png)  

å…³äºæœ¬æ–‡ä¸­çš„è¯­æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è§£è¯»ï¼š  

- ä¸€ä¸ª`è¡¨è¾¾å¼(expr)`å¯ä»¥ç”±ä¸€ä¸ª`å› å­(factor)`åé¢è·Ÿç€0ä¸ªæˆ–å¤šä¸ªç”±MULæˆ–è€…DIVåŠ å¦ä¸€ä¸ªå› å­ç»„æˆçš„ç»„  
- ä¸€ä¸ª`å› å­(factor)`æ˜¯è¡¨ç¤ºä¸€ä¸ª`æ•´æ•°(INTEGER)`  

ä¸‹é¢æ˜¯ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•é‡Œçš„ä¸€äº›ç¬¦å·çš„æ„ä¹‰ï¼š  

- `|` æˆ–ã€‚(MUL|DIV) è¡¨ç¤ºMUL æˆ–è€…DIV  
- `(...)` ç»„ã€‚æ‹¬å·å†…çš„ç»ˆç»“ç¬¦æˆ–è€…éç»ˆç»“ç¬¦ç»„æˆä¸€ä¸ªæ•´ä½“ï¼Œæˆä¸ºç»„ã€‚  
- `*` åŒ¹é…æ˜Ÿå·å‰é¢çš„å†…å®¹0æ­¤æˆ–å¤šæ¬¡ï¼Œä¹Ÿå«åš`å…‹æ—é—­åŒ…(Kleene Closure)`  

å¦‚æœä¹‹å‰æ¥è§¦è¿‡æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‚£ä½ å¯¹ä»–ä»¬è‚¯å®šä¸ä¼šé™Œç”Ÿã€‚  

ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•é€šè¿‡è§£æå®ƒå¯ä»¥ç”Ÿæˆçš„å¥å­æ¥æè¿°è¯­è¨€ã€‚è¿™ä¹Ÿæ˜¯æœ¬æ–‡ä¸­å¦‚ä½•é€šè¿‡è¯­æ³•æ¥æ´¾ç”Ÿç®—æœ¯è¡¨è¾¾å¼çš„æ–¹æ³•ï¼šé¦–å…ˆä»èµ·å§‹ç¬¦`expr` å¼€å§‹ï¼Œä¾æ¬¡ç”¨ä¸‹ä¸€è¡Œçš„è§„åˆ™ä½“æ›¿æ¢æ‰ç¬¬ä¸€æ¡è§„åˆ™ä½“ä¸­çš„éç»ˆç»“ç¬¦ï¼Œç›´è‡³ç¬¬ä¸€æ¡è§„åˆ™ä½“ä¸­ä¸å†åŒ…å«æœ‰éç»ˆç»“ç¬¦ã€‚ç”±è¿™æ¡è§„åˆ™æ´¾ç”Ÿçš„å¥å­å°±æ„æˆäº†è¯­æ³•å®šä¹‰çš„è¯­è¨€ã€‚  

ä¸‹é¢åˆ—ä¸¾äº†ä¸€äº›ä¾‹å­ï¼Œä¾‹å¦‚è¡¨è¾¾å¼`3`ï¼š  
![lsbasi_part4_derive1.png](img/04/lsbasi_part4_derive1.png)  

è¡¨è¾¾å¼`3 * 7`ï¼š  
![lsbasi_part4_derive2.png](img/04/lsbasi_part4_derive2.png)  

è¡¨è¾¾å¼`3 * 7 / 2`ï¼š  
![lsbasi_part4_derive3.png](img/04/lsbasi_part4_derive3.png)  

åš¯ï¼Œç†è®ºæœ‰ç‚¹å¤šäº†å“ˆï¼  
åœ¨æˆ‘ç¬¬ä¸€æ¬¡å­¦ä¹ ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•å’Œç›¸å…³æœ¯è¯­æ—¶ï¼Œå°±åƒè¿™æ ·ï¼š  
![lsbasi_part4_bnf_hmm.png](img/04/lsbasi_part4_bnf_hmm.png)  

åæ­£ç»å¯¹ä¸æ˜¯è¿™æ ·ï¼š  
![lsbasi_part4_bnf_yes.png](img/04/lsbasi_part4_bnf_yes.png)  

æˆ‘èŠ±è´¹äº†å¥½äº›æ—¶é—´æ¥ç†Ÿæ‚‰ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ä¸­çš„ç¬¦å·ã€å®ƒä¸è¯æ³•åˆ†æå™¨å’Œè§£é‡Šå™¨çš„å…³ç³»ã€ä»¥åŠä»–æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ä½†æˆ‘è¦è¯´çš„æ˜¯ï¼Œä»é•¿è¿œæ¥çœ‹ï¼Œè¿™äº›ä»˜å‡ºéƒ½æ˜¯å€¼å¾—çš„ï¼šé‰´äºå®ƒåœ¨å®è·µå’Œç›¸å…³æ•™æä¸­è¢«å¹¿æ³›åº”ç”¨ï¼Œå†æ¬¡é‡ä¸Šæ˜¯è¿Ÿæ—©çš„äº‹ï¼Œæ‰€ä»¥ä¸ºä»€ä¹ˆä¸æ—©ç‚¹å­¦ä¹ å‘¢ï¼Ÿ(*æ˜¯ç¦ä¸æ˜¯ç¥¸ï¼Œæ˜¯ç¥¸èº²ä¸è¿‡ğŸ˜„*)  

ç°åœ¨ï¼Œæˆ‘ä»¬å°±å°†ä¸Šé¢çš„è¯­æ³•è½¬åŒ–ä¸ºæºç ï¼š  

å½“ç„¶ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›è§„åˆ™å¯å¾ªçš„ï¼Œåªè¦éµå®ˆè§„åˆ™ï¼Œå°±å¯ä»¥ **å¾ˆè½»æ¾** åœ°å°†è¯­æ³•è½¬åŒ–ä¸ºæºç ï¼  

1. å¯¹äºæ¯ä¸€æ¡è§„åˆ™ **R**ï¼šæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªåŒåçš„æ–¹æ³•ï¼Œæ–¹æ³•ä½“ä¸è§„åˆ™ä½“ç»“æ„ã€é¡ºåºéƒ½ç›¸åŒ  
2. æˆ–è¿ç®— **(a1 | a2 | aN)** æ›¿æ¢ä¸º`if-elif-else` è¯­å¥  
3. **æ˜Ÿå·(å…‹æ—é—­åŒ…)** å¯¹åº”ç€`while` å¾ªç¯  
4. æ¯ä¸€ä¸ªtokenï¼Œéƒ½ä¼šå¯¹åº”ä¸ªä¸€ä¸ªæ–¹æ³•`eat(token)`:eat æ–¹æ³•ç”¨æ¥æ¶ˆè´¹è¯æ³•åˆ†æäº§ç”Ÿçš„tokenï¼Œå¦‚æœå½“å‰çš„token ç¬¦åˆè¯­æ³•è§„åˆ™ï¼Œå°±ä¼šä»è¯­æ³•åˆ†æå™¨è·å–ä¸‹ä¸€ä¸ªtoken å¹¶è®¾ç½®ä¸ºè§£æå™¨çš„å½“å‰token `current_token`  

çœ‹èµ·æ¥å°±åƒä¸‹é¢è¿™æ ·ï¼š  
![lsbasi_part4_rules.png](img/04/lsbasi_part4_rules.png)  

ä¸‹é¢æˆ‘ä»¬æ ¹æ®è¿™äº›å‡†åˆ™ï¼Œæ¥è¯•ç€æ‰‹å·¥è½¬åŒ–ä¸€ä¸‹ã€‚  

æˆ‘ä»¬çš„è¯­æ³•ä¸­æœ‰ä¸¤æ¡è§„åˆ™ï¼šexpr å’Œfactorã€‚æˆ‘ä»¬å…ˆä»factor å¼€å§‹ï¼šæ ¹æ®å‡†åˆ™1ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª`factor()` æ–¹æ³•ï¼›æ ¹æ®å‡†åˆ™4ï¼Œè¯¥æ–¹æ³•åªéœ€è¦è°ƒç”¨`eat(token)` å°±å¥½äº†ã€‚(*è¯‘æ³¨ï¼šæœ‰æ²¡æœ‰å‘ç°è¯­æ³•çš„èµ·å§‹ç¬¦åœ¨æœ€å¤æ‚çš„è§„åˆ™ï¼Œè€Œæˆ‘ä»¬å®ç°è¯­æ³•åˆ™æ˜¯ä»æœ€ç®€å•çš„è§„åˆ™å…¥æ‰‹*)  
```python
def factor(self):
    self.eat(INTEGER)
```

å¾ˆç®€å•ï¼Œå¯¹ä¸å¯¹ï¼Ÿ  
ç»§ç»­ï¼  
ç”±å‡†åˆ™1ï¼Œè§„åˆ™expr å¯¹åº”ç€`expr()`ï¼Œæ–¹æ³•ä½“æ‰§è¡Œä¸€æ¬¡`factor()`ï¼›ç”±å‡†åˆ™3ï¼Œç´§è·Ÿç€ä¸€ä¸ª`while` å¾ªç¯ï¼›ç”±å‡†åˆ™2ï¼Œwhile å¾ªç¯å…ˆæ˜¯åŒ…å«ä¸€ä¸ª`if...else` ç„¶åå†æ‰§è¡Œä¾æ¬¡`factor()` åœ¨åˆ¤æ–­è¯­å¥ä¸­åŒæ ·ä¹Ÿéœ€è¦è°ƒç”¨`eat(token)`æ ¡éªŒtokenã€‚å°†ä»¥ä¸Šæ­¥éª¤ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†`expr()`æ–¹æ³•ã€‚  

```python
def expr(self):
    self.factor()

    while self.current_token.type in (MUL, DIV):
        token = self.current_token
        if token.type == MUL:
            self.eat(MUL)
            self.factor()
        elif token.type == DIV:
            self.eat(DIV)
            self.factor()
```

è¯·å¤šèŠ±äº›æ—¶é—´è¯•å‡ æ¬¡ï¼Œæœ€å¥½èƒ½çƒ‚ç†Ÿäºå¿ƒï¼Œç¨åå°±ä¼šæ´¾ä¸Šç”¨åœºã€‚  
ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘å°†ä¸Šé¢çš„ä»£ç æ”¾å…¥*parser.py*æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶åŒ…å«è¯æ³•åˆ†æå™¨å’Œä¸å¸¦è§£é‡Šå™¨çš„è§£æå™¨ã€‚ ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä»[GitHub](https://github.com/rspivak/lsbasi/blob/master/part4/parser.py)ä¸‹è½½è¿è¡Œã€‚ å®ƒæœ‰ä¸€ä¸ªäº¤äº’å¼æç¤ºç¬¦ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­è¾“å…¥è¡¨è¾¾å¼å¹¶æŸ¥çœ‹å®ƒä»¬æ˜¯å¦æœ‰æ•ˆï¼šå³ï¼Œæ ¹æ®è¯­æ³•æ„å»ºçš„è§£æå™¨æ˜¯å¦å¯ä»¥è¯†åˆ«è¡¨è¾¾å¼ã€‚  
ä¸‹é¢æ˜¯åœ¨ä½œè€…è®¡ç®—æœºä¸Šæ‰§è¡Œçš„ä¼šè¯è¿‡ç¨‹ï¼š  

```shell
$ python parser.py
calc> 3
calc> 3 * 7
calc> 3 * 7 / 2
calc> 3 *
Traceback (most recent call last):
  File "parser.py", line 155, in <module>
    main()
  File "parser.py", line 151, in main
    parser.parse()
  File "parser.py", line 136, in parse
    self.expr()
  File "parser.py", line 130, in expr
    self.factor()
  File "parser.py", line 114, in factor
    self.eat(INTEGER)
  File "parser.py", line 107, in eat
    self.error()
  File "parser.py", line 97, in error
    raise Exception('Invalid syntax')
Exception: Invalid syntax
```
åŠ¨æ‰‹è¯•è¯•ï¼  

æˆ‘å¿ä¸ä½æƒ³èµ·äº†è¯­æ³•å›¾ï¼Œä¸‹å›¾å°±æ˜¯æœ¬æ–‡ä¸­ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•æ‰€å¯¹åº”çš„è¯­æ³•å›¾ï¼š  
![lsbasi_part4_sd.png](img/04/lsbasi_part4_sd.png)  

è¶çƒ­æ‰“é“ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬è®¡ç®—å™¨çš„æºç ï¼Œå¯ä»¥å¤„ç†ä»»æ„é¡¹æ•´æ•°çš„ä¹˜é™¤æ³•(æ•´æ•°é™¤æ³•)ã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å°†è¯æ³•åˆ†æå™¨é‡æ„ä¸ºå•ç‹¬çš„`Lexer` ç±»ï¼Œå¹¶ä¸”æ›´æ–°äº†`Interpreter` æ¥å—`Lexer`å®ä¾‹ä½œä¸ºå‚æ•°ã€‚  

```python
# è¢«èšŠå­å’¬æ­»äº†ï¼Œæºç æ³¨é‡Šåé¢åœ¨ç¿»è¯‘

# Token ç±»å‹
#
# EOF è¡¨ç¤ºæ²¡æœ‰æ›´å¤šè¾“å…¥
INTEGER, MUL, DIV, EOF = 'INTEGER', 'MUL', 'DIV', 'EOF'


class Token(object):
    # token çš„æ„é€ å‡½æ•°
    def __init__(self, type, value):
        # token ç±»å‹: INTEGER, MUL, DIV, EOF
        self.type = type
        # token å€¼: éè´Ÿæ•´æ•°, '*', '/', æˆ–è€… None
        self.value = value

    def __str__(self):
        """å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤º

        ä¾‹å¦‚:
            Token(INTEGER, 3)
            Token(MUL, '*')
        """
        return 'Token({type}, {value})'.format(
            type=self.type,
            value=repr(self.value)
        )

    def __repr__(self):
        return self.__str__()


class Lexer(object):
    # è¯æ³•åˆ†æå™¨æ„é€ å‡½æ•°
    def __init__(self, text):
        # è·å–è¾“å…¥å­—ç¬¦ä¸², ä¾‹å¦‚ "3 * 5", "12 / 3 * 4", etc
        self.text = text
        # è¾“å…¥å­—ç¬¦ä¸²çš„å½“å‰å­—ç¬¦æŒ‡é’ˆ
        self.pos = 0
        self.current_char = self.text[self.pos]

    def error(self):
        raise Exception('æ— æ•ˆçš„å­—ç¬¦')

    def advance(self):
        """ç§»åŠ¨`pos` æŒ‡é’ˆ`current_char` å½“å‰å­—ç¬¦"""
        self.pos += 1
        if self.pos > len(self.text) - 1:
            self.current_char = None  # è¾“å…¥å­—ç¬¦ä¸²ç»“æŸ
        else:
            self.current_char = self.text[self.pos]

    def skip_whitespace(self):
        while self.current_char is not None and self.current_char.isspace():
            self.advance()

    # è§£ææ•´æ•°token
    def integer(self):
        """æ¶ˆè€—å½“å‰å­—ç¬¦ï¼Œç”Ÿæˆä¸€ä¸ª(å¤šä½)éè´Ÿæ•´æ•°"""
        result = ''
        while self.current_char is not None and self.current_char.isdigit():
            result += self.current_char
            self.advance()
        return int(result)

    def get_next_token(self):
        """è¯æ³•åˆ†æå™¨

        æ¯æ¬¡è°ƒç”¨ï¼Œä»è¾“å…¥å­—ç¬¦ä¸²ä¸­è·å–ä¸€ä¸ªtoken
        """
        while self.current_char is not None:

            if self.current_char.isspace():
                self.skip_whitespace()
                continue

            if self.current_char.isdigit():
                return Token(INTEGER, self.integer())

            if self.current_char == '*':
                self.advance()
                return Token(MUL, '*')

            if self.current_char == '/':
                self.advance()
                return Token(DIV, '/')

            self.error()

        return Token(EOF, None)


class Interpreter(object):
    # è§£é‡Šå™¨æ„é€ å‡½æ•°
    def __init__(self, lexer):
        self.lexer = lexer
        # è®¾ç½®å½“å‰token ä¸ºè¯æ³•åˆ†æäº§ç”Ÿçš„ç¬¬ä¸€ä¸ªtoken
        self.current_token = self.lexer.get_next_token()

    def error(self):
        raise Exception('æ— æ•ˆè¯­æ³•')

    def eat(self, token_type):
        # æ ¡éªŒå½“å‰çš„tokenï¼Œå¦‚æœç¬¦åˆæŒ‡å®šçš„ç±»å‹ï¼Œä¾¿å°†current_token æŒ‡å‘ä¸‹ä¸€ä¸ªtoken
        # å¦åˆ™æŠ›å‡ºè¯­æ³•è§£æå¼‚å¸¸
        if self.current_token.type == token_type:
            self.current_token = self.lexer.get_next_token()
        else:
            self.error()

    def factor(self):
        """å› å­ï¼šè¿”å›ä¸€ä¸ªæ•´å‹token

        factor : INTEGER
        """
        token = self.current_token
        self.eat(INTEGER)
        return token.value

    def expr(self):
        """ç®—å¼è§£æå™¨/è§£é‡Šå™¨

        expr   : factor ((MUL | DIV) factor)*
        factor : INTEGER
        """
        result = self.factor()

        while self.current_token.type in (MUL, DIV):
            token = self.current_token
            if token.type == MUL:
                self.eat(MUL)
                result = result * self.factor()
            elif token.type == DIV:
                self.eat(DIV)
                result = result / self.factor()

        return result


def main():
    while True:
        try:
            # Python3 ä¸‹è¿è¡Œéœ€è¦å°† 'raw_input' æ›¿æ¢ä¸º 'input'
            text = raw_input('calc> ')
        except EOFError:
            break
        if not text:
            continue
        lexer = Lexer(text)
        interpreter = Interpreter(lexer)
        result = interpreter.expr()
        print(result)


if __name__ == '__main__':
    main()
```

å°†ä¸Šé¢çš„æ–‡ä»¶ä¿å­˜ä¸º*calc4.py*æˆ–è€…ä»[GitHub](https://github.com/rspivak/lsbasi/blob/master/part4/calc4.py)ä¸‹è½½ï¼Œå¹¶æ‰§è¡Œï¼Œçœ‹æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚  
ä¸‹é¢æ˜¯ä½œè€…è®¡ç®—æœºçš„è¿è¡Œä¼šè¯ï¼š  

```shell
$ python calc4.py
calc> 7 * 4 / 2
14
calc> 7 * 4 / 2 * 3
42
calc> 10 * 4  * 2 * 3 / 8
30
```

æˆ‘çŸ¥é“ä½ å·²ç»ç­‰ä¸åŠä»Šå¤©çš„ç»ƒä¹ éƒ¨åˆ†äº†:)  
![lsbasi_part4_exercises.png](img/04/lsbasi_part4_exercises.png)  

- å†™å‡ºå¯ä»¥è¯†åˆ«åŠ å‡ä¹˜é™¤å››åˆ™è¿ç®—çš„ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ï¼Œä¾‹å¦‚ï¼š"2 + 7 * 4", "7 - 8 / 4", "14 + 2 * 3 - 6 / 2"(æ³¨æ„ä¼˜å…ˆçº§)  
- å°†å†™å‡ºçš„è½¬åŒ–æˆä»£ç   
- å¦‚æœéƒ½å®Œæˆäº†ï¼Œé‚£å°±æ”¾æ¾ä¸‹å§  


å°æµ‹éªŒï¼š  
å‚è€ƒä¸‹å›¾ï¼Œå®Œæˆä¸‹é¢çš„é—®é¢˜ï¼š
![lsbasi-part4/lsbasi_part4_bnf1.png](img/04/lsbasi-part4/lsbasi_part4_bnf1.png)  

1. ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•  
2. ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•çš„è§„åˆ™  
3. ä»€ä¹ˆæ˜¯ç»ˆç»“ç¬¦  
4. ä»€ä¹ˆæ˜¯éç»ˆç»“ç¬¦  
5. ä»€ä¹ˆæ˜¯è§„åˆ™å¤´  
6. ä»€ä¹ˆæ˜¯è§„åˆ™ä½“  
7. ä»€ä¹ˆæ˜¯èµ·å§‹ç¬¦  

ä»Šå¤©å°±åˆ°è¿™é‡Œï¼Œæœ¬æ–‡ä¸­çš„ç†è®ºçŸ¥è¯†æœ‰ç‚¹å¤šï¼Œæ‰€ä»¥ä¸è¦æ‹…å¿ƒï¼Œä½ å·²ç»å¾ˆå‰å®³äº†ï¼  
ä¸è¦å¿˜è®°ç»ƒä¹ ï¼š**åŠŸä¸å”æï¼Œç‰æ±äºæˆ**ã€‚ä¸‹æ¬¡è§ï¼

ä¸‹é¢æ˜¯ä¸€äº›æœ‰ç”¨çš„å‚è€ƒèµ„æ–™ï¼š  

1. [Language Implementation Patterns: Create Your Own Domain-Specific and General Programming Languages (Pragmatic Programmers)](http://www.amazon.com/gp/product/193435645X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=193435645X&linkCode=as2&tag=russblo0b-20&linkId=MP4DCXDV6DJMEJBL)  
2. [Writing Compilers and Interpreters: A Software Engineering Approach](http://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0470177071&linkCode=as2&tag=russblo0b-20&linkId=UCLGQTPIYSWYKRRM)  
3. [Modern Compiler Implementation in Java](http://www.amazon.com/gp/product/052182060X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=052182060X&linkCode=as2&tag=russblo0b-20&linkId=ZSKKZMV7YWR22NMW)  
4. [Modern Compiler Design](http://www.amazon.com/gp/product/1461446988/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1461446988&linkCode=as2&tag=russblo0b-20&linkId=PAXWJP5WCPZ7RKRD)  
5. [Compilers: Principles, Techniques, and Tools (2nd Edition)](http://www.amazon.com/gp/product/0321486811/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0321486811&linkCode=as2&tag=russblo0b-20&linkId=GOEGDQG4HIHU56FQ)  

-----  

[é˜…è¯»åŸæ–‡](https://ruslanspivak.com/lsbasi-part4/)  
ç¬¬å››ç« å¾ˆé‡è¦ä¹Ÿå¯èƒ½æœ‰äº›ç»•ï¼Œä½œè€…æä¾›äº†å¤§é‡çš„å›¾ç¤ºï¼Œ(à¸‡ â€¢_â€¢)à¸‡  
