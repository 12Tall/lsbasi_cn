12_è¿‡ç¨‹å£°æ˜    

ğŸ“… 2016-12-01  

> â€œä¸æ€•æ…¢ï¼Œåªæ€•ç«™â€  â€”â€”ä¸­å›½ä¿—è¯­  

Helloï¼Œæ¬¢è¿å›æ¥~ã€‚ä»Šå¤©æˆ‘ä»¬åªå­¦ä¸€ç‚¹ç‚¹è¿‡ç¨‹å£°æ˜ï¼ˆProcedure Declarationï¼‰çš„çŸ¥è¯†ï¼Œä¸ºåé¢çš„çŸ¥è¯†ç‚¹æ‰“åŸºç¡€ã€‚  
![](../_resources/lsbasi_part12_babysteps.png)  

ä»€ä¹ˆæ˜¯**è¿‡ç¨‹å£°æ˜**å‘¢ï¼Ÿè¿‡ç¨‹å£°æ˜å°±æ˜¯ä¸€ä¸ªè¯­æ³•ç»“æ„ï¼šå®šä¹‰ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼ˆè¿‡ç¨‹åï¼‰ï¼Œå¹¶ä¸”å°†å®ƒä¸æŸä¸ªPascal ä»£ç å—ç›¸å…³è”ã€‚åœ¨æ·±å…¥å­¦ä¹ ä¹‹å‰ï¼Œå…ˆç®€å•çœ‹ä¸€ä¸‹Pascal è¿‡ç¨‹çš„ï¼ˆä¸å®Œå…¨ï¼‰å®šä¹‰ï¼š  
- Pascal è¿‡ç¨‹æ²¡æœ‰è¿”å›å€¼ï¼Œåœ¨åˆ°è¾¾ä»£ç å—çš„ç»“å°¾åè‡ªåŠ¨é€€å‡ºï¼›  
- Pascal è¿‡ç¨‹å¯ä»¥äº’ç›¸åµŒå¥—ï¼›  
- ç®€å•èµ·è§ï¼Œæœ¬æ–‡ä¸­çš„Pascal è¿‡ç¨‹ä¸æ¥å—ä»»ä½•å‚æ•°ã€‚åé¢çš„æ–‡ç« æ‰ä¼šæ¶‰åŠã€‚  

ä¸‹é¢æ˜¯æˆ‘ä»¬ä»Šå¤©çš„æµ‹è¯•ç”¨ä¾‹ï¼š  
```pascal
PROGRAM Part12;
VAR
   a : INTEGER;

PROCEDURE P1;
VAR
   a : REAL;
   k : INTEGER;

   PROCEDURE P2;
   VAR
      a, z : INTEGER;
   BEGIN {P2}
      z := 777;
   END;  {P2}

BEGIN {P1}

END;  {P1}

BEGIN {Part12}
   a := 10;
END.  {Part12}

{ç–‘é—®ï¼šè¿‡ç¨‹ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Œé€€å‡ºæ—¶åˆåšäº†å“ªäº›å·¥ä½œå‘¢ï¼Ÿ}
```

å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªPascal è¿‡ç¨‹P1 å’ŒP2ï¼Œå¹¶ä¸”P2 æ˜¯åµŒå¥—åœ¨P1 å†…éƒ¨çš„ã€‚åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ³¨é‡Šè¯´æ˜è¿‡ç¨‹ä½“ä»£ç å±äºå“ªä¸ªè¿‡ç¨‹ã€‚  

ä»Šå¤©æˆ‘ä»¬çš„ç›®æ ‡ä¹Ÿå¾ˆç®€å•ï¼šå­¦ä¹ å¦‚ä½•è§£æä¸Šé¢çš„Pascal ä»£ç ã€‚  

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ ä¸€æ¡è¯­æ³•è§„åˆ™ã€‚è¯´å¹²å°±å¹²ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬æ›´æ–°åçš„`declarations` è¯­æ³•ï¼š  
![](../_resources/lsbasi_part12_grammar.png)  

> è¯‘æ³¨ï¼šè¿‡ç¨‹çš„å£°æ˜åœ¨VAR å˜é‡å£°æ˜ä¹‹åï¼Œåœ¨ç¨‹åºä½“å¼€å§‹ä¹‹å‰ï¼Œä¼¼ä¹~  

Pascal è¿‡ç¨‹çš„å£°æ˜ç”±ä¿ç•™å­—`PROCEDURE` å¼€å§‹ï¼Œåé¢ä¾æ¬¡è·Ÿç€è¿‡ç¨‹åæ ‡è¯†ç¬¦ã€åˆ†å·ã€è¿‡ç¨‹ä½“ä»£ç å—ã€åˆ†å·ã€‚å¬èµ·æ¥å¾ˆå¤æ‚ï¼Œé€šè¿‡è¯­æ³•å›¾çœ‹èµ·æ¥å°±ç®€å•æ˜äº†äº†ï¼š  
![](../_resources/lsbasi_part12_syntaxdiagram.png)

ä»è¯­æ³•å’Œè¯­æ³•å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€å±‚çº§å®šä¹‰å¥½å¤šPascal è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å£°æ˜ä¸¤ä¸ªè¿‡ç¨‹ï¼šP1 å’ŒP1Aï¼š  
```pascal
PROGRAM Test;
VAR
   a : INTEGER;

PROCEDURE P1;
BEGIN {P1}

END;  {P1}

PROCEDURE P1A;
BEGIN {P1A}

END;  {P1A}

BEGIN {Test}
   a := 10;
END.  {Test}
```

åŒæ ·ä»è¯­æ³•å’Œè¯­æ³•å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿‡ç¨‹çš„å£°æ˜å¯ä»¥åµŒå¥—ï¼Œå› ä¸ºè¿‡ç¨‹å£°æ˜æ˜¯ä»¥`block` ä½œä¸ºå­è§„åˆ™çš„ï¼Œè€Œ`block` åˆåŒ…å«äº†`declarations` è§„åˆ™ã€‚å¦‚æœè®°ä¸æ¸…äº†ï¼Œè¿™é‡Œå±•ç¤ºä¸€ä¸‹æˆ‘ä»¬åœ¨ç¬¬10 ç« çš„è¯­æ³•å›¾éƒ¨åˆ†ï¼š   
![](../_resources/lsbasi_part12_block_rule_from_part10.png)

OKï¼Œç°åœ¨æˆ‘ä»¬æŠŠæ³¨æ„åŠ›æ”¾åˆ°è§£é‡Šå™¨ç»„ä»¶çš„æ›´æ–°ä¸Šæ¥ã€‚  

## è¯æ³•åˆ†æå™¨  
è¯æ³•åˆ†æå™¨ä¸­éœ€è¦æ–°å¢ä¸€ä¸ªå…³é”®å­—`PROCEDURE`ï¼š
```python
PROCEDURE = 'PROCEDURE'
```

å°†å…³é”®å­—æ·»åŠ åˆ°ä¿ç•™å­—åˆ—è¡¨ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  
```python
RESERVED_KEYWORDS = {
    'PROGRAM': Token('PROGRAM', 'PROGRAM'),
    'VAR': Token('VAR', 'VAR'),
    'DIV': Token('INTEGER_DIV', 'DIV'),
    'INTEGER': Token('INTEGER', 'INTEGER'),
    'REAL': Token('REAL', 'REAL'),
    'BEGIN': Token('BEGIN', 'BEGIN'),
    'END': Token('END', 'END'),
    'PROCEDURE': Token('PROCEDURE', 'PROCEDURE'),
}
```  

## è¯­æ³•åˆ†æå™¨  
è¯­æ³•åˆ†æå™¨éœ€è¦æ›´æ–°ä¸¤å¤„ï¼š  
1. æ–°å¢`ProcedureDecl` æŠ½è±¡è¯­æ³•æ ‘èŠ‚ç‚¹ï¼›  
2. æ›´æ–°`declarations` æ–¹æ³•ã€‚  

ä»¥ä¸‹æ˜¯è¯¦ç»†å†…å®¹ï¼š  
1. `ProcedureDecl` èŠ‚ç‚¹è¡¨ç¤ºè¿‡ç¨‹å£°æ˜ã€‚å…¶æ„é€ å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šè¿‡ç¨‹å`proc_name` å’Œè¿‡ç¨‹ä½“`block_node`  
    ```python
    class ProcedureDecl(AST):
        def __init__(self, proc_name, block_node):
            self.proc_name = proc_name
            self.block_node = block_node
    ```
2. ä¸‹é¢æ˜¯æ›´æ–°åçš„`declaratons` æ–¹æ³•ï¼š   
    ```python
    def declarations(self):
        """declarations : VAR (variable_declaration SEMI)+
                        | (PROCEDURE ID SEMI block SEMI)*
                        | empty
        """
        declarations = []  # å£°æ˜è¯­å¥å¯ä»¥å¤šæ¡å¹¶å­˜ï¼Œæ‰€ä»¥ç”¨æ•°ç»„

        if self.current_token.type == VAR:
            self.eat(VAR)
            while self.current_token.type == ID:
                var_decl = self.variable_declaration()
                declarations.extend(var_decl)
                self.eat(SEMI)

        while self.current_token.type == PROCEDURE:
            self.eat(PROCEDURE)
            proc_name = self.current_token.value
            self.eat(ID)
            self.eat(SEMI)
            block_node = self.block()
            proc_decl = ProcedureDecl(proc_name, block_node)
            declarations.append(proc_decl)
            self.eat(SEMI)

        return declarations
    ```

å¸Œæœ›ä¸Šé¢çš„ä»£ç ä¸ç”¨è¿‡å¤šçš„è§£é‡Šã€‚å®ƒåªæ˜¯å‰é¢è¯­æ³•å’Œè¯­æ³•å›¾çš„ç®€å•ç¿»è¯‘ã€‚   

## æ„é€ ç¬¦å·è¡¨

å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰è®¡åˆ’åŒºå¤„ç†åµŒå¥—è¿‡ç¨‹çš„ä½œç”¨åŸŸï¼Œæ‰€ä»¥è¿™ä¸€æ­¥å…ˆç›´æ¥è·³è¿‡ï¼Œä¸‹ç¯‡æ–‡ç« å†è¡¥å……ï¼š   
```python
def visit_ProcedureDecl(self, node):
    pass
```  

## è§£é‡Šå™¨  
åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿç•™ç©º`visit_ProcedureDecl` æ–¹æ³•ï¼Œç›´æ¥å¿½ç•¥æ‰è¿‡ç¨‹å£°æ˜éƒ¨åˆ†çš„è§£é‡Šã€‚ç›®å‰æ¥è¯´ï¼Œè¿˜ä¸é”™ã€‚  

ä»¥ä¸Šå°±æ˜¯æ‰€æœ‰å˜åŠ¨ï¼Œä¸‹é¢å°±çœ‹ä¸€çœ‹æ›´æ–°åçš„æŠ½è±¡è¯­æ³•æ ‘é•¿ä»€ä¹ˆæ ·å§ï¼ŒåŒæ ·æ˜¯ä»¥æœ€å¼€å§‹çš„Pascal ä»£ç åšæµ‹è¯•ï¼Œä½ ä¹Ÿå¯ä»¥ä»Github ä¸Š[ä¸‹è½½](https://github.com/rspivak/lsbasi/blob/master/part12/python/part12.pas)ã€‚  
```pascal
PROGRAM Part12;
VAR
   a : INTEGER;

PROCEDURE P1;
VAR
   a : REAL;
   k : INTEGER;

   PROCEDURE P2;
   VAR
      a, z : INTEGER;
   BEGIN {P2}
      z := 777;
   END;  {P2}

BEGIN {P1}

END;  {P1}

BEGIN {Part12}
   a := 10;
END.  {Part12}
```

é€šè¿‡[genastdot.py](https://github.com/rspivak/lsbasi/blob/master/part12/python/genastdot.py) å·¥å…·å¯ä»¥ç”Ÿæˆå¯è§†åŒ–çš„æŠ½è±¡è¯­æ³•æ ‘ï¼š  
```shell-session
$ python genastdot.py part12.pas > ast.dot && dot -Tpng -o ast.png ast.dot
```
![](../_resources/lsbasi_part12_procdecl_ast.png)  

ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ª`ProcedureDecl` èŠ‚ç‚¹ï¼šP1 å’ŒP2ã€‚ä»»åŠ¡ç»“æŸ:)  

ä»Šå¤©æœ€åä¸€é¡¹å†…å®¹ï¼šæ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬çš„ç¨‹åºè¿˜èƒ½ä¸èƒ½è·‘å‘¢ï¼Ÿä¸‹è½½[è§£é‡Šå™¨ä»£ç ](https://github.com/rspivak/lsbasi/blob/master/part12/python/spi.py)å’Œ[Pascal ç¨‹åº](https://github.com/rspivak/lsbasi/blob/master/part12/python/part12.pas)å°è¯•è¿è¡Œï¼š   
```shell-session
$ python spi.py part12.pas
Define: INTEGER
Define: REAL
Lookup: INTEGER
Define: <a:INTEGER>
Lookup: a

Symbol Table contents:
Symbols: [INTEGER, REAL, <a:INTEGER>]

Run-time GLOBAL_MEMORY contents:
a = 10
```

OKï¼ŒæŒæ¡äº†ä»¥ä¸Šæ‰€æœ‰çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹å¤„ç†åµŒå¥—ä½œç”¨åŸŸäº†ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨åˆ†æåµŒå¥—è¿‡ç¨‹è°ƒç”¨å’Œå‡½æ•°è°ƒç”¨æ‰€å¿…é¡»æŒæ¡ã€ç†è§£çš„ã€‚æˆ‘ä»¬å°†ä¼šåœ¨ä¸‹ä¸€ç« ä¸­é‡ç‚¹åˆ†æå®ƒï¼Œä½†æ˜¯ä¹Ÿè¦åšå¥½å¿ƒç†å‡†å¤‡ï¼ˆä¸‹ä¸€ç¯‡æ–‡ç« å·¨é•¿ï¼ï¼‰ã€‚å†è§å’¯~  

-----  
2022-06-27 21:11