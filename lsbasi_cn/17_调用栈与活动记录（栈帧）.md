17_è°ƒç”¨æ ˆä¸æ´»åŠ¨è®°å½•ï¼ˆæ ˆå¸§ï¼‰  

ğŸ“… 2019-08-28  

> â€œä½ ä¹Ÿè®¸éœ€è¦æˆ˜æ–—å¾ˆå¤šæ¬¡æ‰èƒ½å–å¾—èƒœåˆ©â€ â€”â€” ç›æ ¼ä¸½ç‰¹Â·æ’’åˆ‡å°”  

1968 å¹´å¢¨è¥¿å“¥å¥¥è¿ä¼šé©¬æ‹‰æ¾é¡¹ç›®ï¼Œå¦æ¡‘å°¼äºšè¿åŠ¨å‘˜çº¦ç¿°Â·å²è’‚èŠ¬Â·é˜¿èµ«ç“¦é‡Œï¼ˆJohn Stephen Akhwariï¼‰åœ¨æ¯”èµ›æ—¶ï¼Œå› å…¶ä»–è¿åŠ¨å‘˜äº‰æŠ¢ä½ç½®ä¸æ…è·Œå€’å¯¼è‡´è†ç›–å—ä¼¤è„±è‡¼ã€‚åœ¨æ¥å—åŒ…æ‰æ²»ç–—åä»–å´æ²¡æœ‰é€‰æ‹©ä¸­é—´é€€åœºï¼Œè€Œæ˜¯ç»§ç»­åšæŒæ¯”èµ›ã€‚æœ€åæ¯”èµ›çš„å† å†›æ˜¯æ¥è‡ªåŸƒå¡ä¿„æ¯”äºšçš„é€‰æ‰‹Mamo Woldeï¼Œç”¨æ—¶2:20:26ï¼Œè€Œé˜¿èµ«ç“¦é‡Œå´ç”¨äº†3:25:27 æ‰è·‘å®Œå…¨ç¨‹ã€‚å¤•é˜³ä¸‹é˜¿èµ«ç“¦é‡Œæ­¥å±¥è¹’è·šã€è…¿ä¸Šè¡€è¿¹æ–‘æ–‘ã€ç»·å¸¦åœ¨é£ä¸­æ™ƒåŠ¨ï¼Œä»¥æœ€åä¸€åï¼ˆå®Œæˆæ¯”èµ›çš„é€‰æ‰‹ï¼‰çš„æˆç»©è·‘å®Œäº†å…¨ç¨‹ã€‚  
å½“äººä»¬çœ‹åˆ°é˜¿èµ«ç“¦é‡Œæ—¶ï¼Œå‘å‡ºæ¥ä¸å¯æ€è®®çš„æ¬¢å‘¼ï¼Œèµ›åè®°è€…é—®ä»–ä¸ºä»€ä¹ˆå—ä¼¤ä¹‹åå´ä¾ç„¶åšæŒå®Œæˆäº†æ¯”èµ›ã€‚ä»–çš„å›ç­”è¢«å†™è¿›äº†å¥¥è¿ä¼šçš„å†å²ï¼šâ€œæˆ‘çš„å›½å®¶ä»5000 è‹±é‡Œå¤–é€æˆ‘æ¥æ˜¯ä¸ºäº†å®Œæˆæ¯”èµ›ï¼Œä¸æ˜¯ä¸ºäº†å¼€å§‹æ¯”èµ›â€ã€‚  

ä¸€ç›´ä»¥æ¥ï¼Œè¿™åˆ™æ•…äº‹æ¿€åŠ±äº†å¾ˆå¤šè¿åŠ¨å‘˜æˆ–å…¶ä»–äººã€‚ä½ ä¹Ÿä¼šæƒ³ï¼šâ€œè¿™ä¸ªæ•…äº‹å¾ˆåŠ±å¿—ï¼Œç„¶è€Œå’Œæˆ‘æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿâ€ã€‚æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œæ¥ä¸‹æ¥å°†ä¼šæœ‰ä¸€æ®µæ¼«é•¿ä¸”è‰°éš¾çš„æ—…ç¨‹ï¼Œæœ‰äº›çŸ¥è¯†ä¹Ÿè®¸ä¼šè®©äººæœ›è€Œç”Ÿç•ï¼Œä½†æ˜¯æ— è®ºå¦‚ä½•æˆ‘ä»¬éƒ½è¦ä¿æŒå‰è¿›ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨æ¥è¿‘æœ¬ç³»åˆ—ä¸­ä¸€ä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘äº†ã€‚  
![](../_resources/lsbasi_part17_keepgoing.png)


Okayï¼Œç°åœ¨å¼€å§‹ï¼ä»¥ä¸‹æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ç›®æ ‡ï¼š  
1. å®ç°ä¸€ä¸ªæ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œç”¨äºæ”¯æŒç¨‹åºã€è¿‡ç¨‹è°ƒç”¨å’Œå‡½æ•°è°ƒç”¨  
2. ç”¨æ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿæ›¿æ¢æ‰ç°æœ‰çš„`GLOBAL_MEMORY` å­—å…¸  

è®©æˆ‘ä»¬ä»ä»¥ä¸‹å››ä¸ªé—®é¢˜å…¥æ‰‹ï¼š  
1. ä»€ä¹ˆæ˜¯å†…å­˜ç®¡ç†ç³»ç»Ÿ  
2. ä¸ºä»€ä¹ˆéœ€è¦æ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿ  
3. æ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿé•¿ä»€ä¹ˆæ ·å­  
4. ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦æ›¿æ¢æ‰`GLOBAL_MEMORY`  

## ä»€ä¹ˆæ˜¯å†…å­˜ç®¡ç†ç³»ç»Ÿ  
ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ§åˆ¶ç¨‹åºåœ¨å†…å­˜ä¸­å­˜å‚¨å’Œè®¿é—®æ•°æ®çš„ç³»ç»Ÿã€‚åœ¨ç¡¬ä»¶å±‚é¢ï¼Œå°±æ˜¯æˆ‘ä»¬çš„RAM å­˜å‚¨å™¨ï¼Œå…¶ä¸­çš„æ•°æ®æ˜¯æ ¹æ®ç‰©ç†åœ°å€å­˜æ”¾çš„ï¼›è€Œåœ¨è§£é‡Šå™¨çš„å±‚é¢ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥è¯»å†™ç‰©ç†åœ°å€ï¼Œè€Œæ˜¯ç”¨å­—å…¸è¿™ä¸€æ•°æ®ç»“æ„æ¥è¡¨ç¤ºå†…å­˜ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬é€šè¿‡å˜é‡å`y` ä¿å­˜äº†ä¸€ä¸ªæ•´æ•°`7`ï¼Œéšååˆä»å­—å…¸ä¸­è¯»å–äº†å®ƒï¼š   
```shell-session  
>>> GLOBAL_MEMORY = {}
>>>
>>> GLOBAL_MEMORY['y'] = 7   # store value by name
>>>
>>> GLOBAL_MEMORY['y']       # access value by name
7
>>>
```  

ä¸€ç›´ä»¥æ¥ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç”¨å­—å…¸è¡¨ç¤ºå…¨å±€å†…å­˜çš„ã€‚æˆ‘ä»¬é€šè¿‡`GLOBAL_MEMORY` å­—å…¸å®ç°ç¨‹åºå…¨å±€å±‚é¢çš„å˜é‡å‚¨å­˜å’Œè¯»å–ã€‚ä¸‹é¢æ˜¯è§£é‡Šå™¨æœ‰å…³å†…å­˜ä¸­å˜é‡çš„åˆ›å»ºã€èµ‹å€¼ã€å’Œè¯»å–çš„éƒ¨åˆ†ï¼š  
```python  
class Interpreter(NodeVisitor):
    def __init__(self, tree):
        self.tree = tree
        self.GLOBAL_MEMORY = {}

    def visit_Assign(self, node):
        var_name = node.left.value
        var_value = self.visit(node.right)
        self.GLOBAL_MEMORY[var_name] = var_value

    def visit_Var(self, node):
        var_name = node.value
        var_value = self.GLOBAL_MEMORY.get(var_name)
        return var_value
```  
è¿™å°±æ˜¯æˆ‘ä»¬å½“å‰è¡¨ç¤ºç¨‹åºå†…å­˜çš„æ–¹æ³•ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚  

## ä¸ºä»€ä¹ˆéœ€è¦æ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿ  
äº‹å®è¯æ˜ï¼Œä»…é ä¸€ä¸ªå…¨å±€å­—å…¸ï¼Œä¸è¶³ä»¥æ”¯æŒè¿‡ç¨‹è°ƒç”¨ã€å‡½æ•°è°ƒç”¨ã€‚ä¸ºäº†æ”¯æŒåµŒå¥—çš„è°ƒç”¨ï¼Œå°¤å…¶æ˜¯é€’å½’è°ƒç”¨ã€‚æˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸ªè¿‡ç¨‹æˆ–è€…å‡½æ•°çš„è°ƒç”¨éƒ½åˆ›å»ºä¸€ä¸ªå­—å…¸ã€‚å¹¶ä¸”å°†å®ƒä»¬ä»¥æŸç§ç‰¹æ®Šçš„æ–¹å¼ç»„ç»‡èµ·æ¥ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªæ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿçš„åŸå› ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åé¢æ‰§è¡Œè¿‡ç¨‹è°ƒç”¨å‰çš„ä¸€å—å«è„šçŸ³ã€‚  

## æ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿæ¶æ„  
æ ¸å¿ƒæ¦‚å¿µï¼šæ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿé€šè¿‡æ ˆçš„æ–¹å¼ä¿å­˜ç±»ä¼¼äºå­—å…¸çš„å¯¹è±¡ä½œä¸ºå…ƒç´ ã€‚è¿™ä¸ªæ ˆè¢«ç§°ä¸ºâ€œè°ƒç”¨æ ˆâ€ï¼ˆCall Stackï¼‰ï¼Œå› ä¸ºå®ƒæ€»æ˜¯è®°å½•å½“å‰è¿‡ç¨‹ã€å‡½æ•°è¢«è°ƒç”¨æ—¶æ‰€éœ€çš„ä¿¡æ¯ã€‚è°ƒç”¨æ ˆä¹Ÿä¼šè¢«ç§°ä¸ºè¿è¡Œæ—¶æ ˆã€æ‰§è¡Œæ ˆç­‰ã€‚è€Œè°ƒç”¨æ ˆä¸­ç±»ä¼¼äºå­—å…¸çš„å…ƒç´ åˆ™è¢«ç§°ä¸ºæ´»åŠ¨è®°å½•ï¼ˆActivation Recordï¼‰ï¼Œåœ¨å›½å†…å¸¸è¢«å«åšæ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚åé¢çš„è¯‘æ–‡ä¸­ä¹Ÿå°†ç§°å‘¼ä¸ºæ ˆå¸§ã€æˆ–è€…å¸§ã€‚  

ç»§ç»­çœ‹è°ƒç”¨æ ˆå’Œæ ˆå¸§çš„ç»†èŠ‚éƒ¨åˆ†ã€‚  
ä»€ä¹ˆæ˜¯æ ˆï¼Ÿæ ˆæ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œéµå¾ªåå…¥å…ˆå‡ºï¼ˆLIFOï¼‰çš„è§„åˆ™ã€‚ä¸ä¹‹ç›¸å¯¹çš„å«é˜Ÿåˆ—ï¼Œéµå¾ªå…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„è§„åˆ™ã€‚å¯ä»¥æŠŠæ ˆæƒ³è±¡æˆä¸€æ‘ç›˜å­ï¼Œæ¯æ¬¡æ”¾ç›˜å­ï¼ˆpushï¼Œå‹æ•°æ®å…¥æ ˆï¼‰æ€»æ˜¯æ”¾åœ¨æœ€ä¸Šé¢ï¼Œå–ç›˜å­ï¼ˆpopï¼Œå¼¹æ•°æ®å‡ºæ ˆï¼‰çš„æ—¶å€™ä¹Ÿæ˜¯ä»æœ€ä¸Šé¢å–ï¼š  
![](../_resources/lsbasi_part17_stackofplates.png)  

é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬çš„æ ˆéœ€è¦å®ç°ä»¥ä¸‹æ–¹æ³•ï¼š  
- `push`  
- `pop`  
- `peek`ï¼šåœ¨ä¸å¼¹å‡ºå…ƒç´ çš„æƒ…å†µä¸‹è®¿é—®æ ˆé¡¶å¸§ï¼ˆè°ƒç”¨æ ˆé¡¶ç«¯çš„æ ˆå¸§ï¼‰  

æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬çš„æ ˆæ˜¯å‘ä¸Šå¢é•¿çš„ï¼š  
> è¯‘æ³¨ï¼šè€Œç‰©ç†æ ˆä¸€èˆ¬æ˜¯å‘ä¸‹å¢é•¿çš„  

![](../_resources/lsbasi_part17_stackgrowth.png)

å¦‚ä½•åœ¨ä»£ç ä¸­å®ç°æ ˆå‘¢ï¼ŸåŸºæœ¬ä¸Šæˆ‘ä»¬å¯ä»¥åŸºäºä¸€ä¸ªæ•°ç»„æ¥å°è£…æˆä¸€ä¸ªæ ˆçš„æ ·å­ï¼š  
```python
class Stack:
    def __init__(self):
        self.items = []

    def push(self, item):
        self.items.append(item)

    def pop(self):
        return self.items.pop()

    def peek(self):  # peek æ–¹æ³•ä¸ä¼šæ”¹å˜æ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°
        return self.items[-1]
```  
è¿™å·®ä¸å¤šä¹Ÿæ˜¯è°ƒç”¨æ ˆçš„å®ç°ã€‚æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä¸€ä¸‹`push` æ–¹æ³•æ¥å—çš„å‚æ•°åï¼Œç”¨äºæ˜æ˜¾è¡¨ç¤ºå‹å…¥çš„æ˜¯æ ˆå¸§ï¼ˆæ´»åŠ¨è®°å½•ï¼Œ`Activation Record`ï¼‰ï¼Œå¹¶ä¸”å¢åŠ `__str__()` æ–¹æ³•æ‰“å°æ ˆçš„å†…å®¹ï¼š  
```python  
class CallStack:
    def __init__(self):
        self._records = []

    def push(self, ar):
        self._records.append(ar)

    def pop(self):
        return self._records.pop()

    def peek(self):
        return self._records[-1]

    def __str__(self):
        s = '\n'.join(repr(ar) for ar in reversed(self._records))
        s = f'CALL STACK\n{s}\n'
        return s

    def __repr__(self):
        return self.__str__()
```  

`__str()__` æ–¹æ³•ä¼šé€†åºéå†æ ˆå¸§ï¼Œå°†æ‰€æœ‰æ ˆå¸§çš„å†…å®¹é‡æ–°æ‹¼æ¥ä¸ºè°ƒç”¨æ ˆçš„å†…å®¹è¿”å›ã€‚é€šè¿‡è¯¥æ–¹æ³•å¯ä»¥çœ‹å‡ºæ ˆçš„å¢é•¿æ–¹å‘ã€‚  

ç„¶åä»€ä¹ˆæ˜¯æ ˆå¸§å‘¢ï¼Ÿå¯¹äºæˆ‘ä»¬è€Œè¨€ï¼Œæ ˆå¸§å°±æ˜¯ä¸€ä¸ªç±»ä¼¼äºå­—å…¸çš„å¯¹è±¡ï¼Œå…¶ç»´æŠ¤ç€å½“å‰è¢«è°ƒç”¨çš„è¿‡ç¨‹æˆ–å‡½æ•°ï¼ŒæŠ‘æˆ–æ˜¯ç¨‹åºæœ¬èº«æ‰€éœ€è¦çš„å„ç§ä¿¡æ¯ï¼Œå¦‚å½¢å‚ã€å±€éƒ¨å˜é‡ç­‰ã€‚è¯·çœ‹åœ¨ä»£ç ä¸­çš„å®ç°ï¼š  
```python
class ARType(Enum):
    PROGRAM   = 'PROGRAM'


class ActivationRecord:
    def __init__(self, name, type, nesting_level):
        self.name = name
        self.type = type
        self.nesting_level = nesting_level
        self.members = {}

    def __setitem__(self, key, value):
        self.members[key] = value

    def __getitem__(self, key):
        return self.members[key]

    def get(self, key):
        return self.members.get(key)

    def __str__(self):
        lines = [
            '{level}: {type} {name}'.format(
                level=self.nesting_level,
                type=self.type.value,
                name=self.name,
            )
        ]
        for name, val in self.members.items():
            lines.append(f'   {name:<20}: {val}')

        s = '\n'.join(lines)
        return s

    def __repr__(self):
        return self.__str__()
```  

æœ‰äº›äº‹æƒ…éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š  
1. æ ˆå¸§ç±»çš„æ„é€ å‡½æ•°æ¥å—3 ä¸ªå‚æ•°ï¼š  
   - `name`ï¼šæ ˆå¸§åï¼Œä¹Ÿæ˜¯è¢«è°ƒç”¨çš„è¿‡ç¨‹ã€å‡½æ•°æˆ–è€…ç¨‹åºå  
   - `type`ï¼šæ ˆå¸§ç±»å‹ï¼Œæšä¸¾ç±»å‹ï¼Œæœ¬æ–‡åªç”¨åˆ°äº†`PROGRAM`  
   - `nesting_level`ï¼šåµŒå¥—æ·±åº¦ï¼Œæ€»æ˜¯æ¯”ç›¸åº”çš„è¿‡ç¨‹ã€å‡½æ•°çš„å£°æ˜æ·±åº¦å¤§1  
2. å­—å…¸çš„æˆå‘˜ç”¨äºå­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°è°ƒç”¨æ—¶çš„ä¿¡æ¯ï¼Œåœ¨ä¸‹ä¸€ç« ä¸­å°†ä¼šè¯¦ç»†ä»‹ç»  
3. æ ˆå¸§ç±»å®ç°äº†`__setitem__()` å’Œ`__getitem__()` æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨å­—å…¸ä¸€æ ·ä½¿ç”¨æ ˆå¸§å¯¹è±¡ï¼Œä¾‹å¦‚`ar['x'] = 7` æˆ–è€…`ar['x']`  
4. `get()` æ–¹æ³•å¯ä»¥åœ¨æ‰¾ä¸åˆ°æˆå‘˜æ—¶è¿”å›`None`ï¼Œè€Œä¸æ˜¯æŠ›å¼‚å¸¸  
5. `__str()__` æ–¹æ³•ç”¨äºæ‰“å°å½“å‰æ ˆå¸§çš„å†…å®¹  

ä¸‹é¢æˆ‘ä»¬æ‰‹å·¥åœ¨Python shell ä¸­æ„å»ºè°ƒç”¨æ ˆå’Œæ ˆå¸§ï¼š  
```shell-session  
>>> from spi import CallStack, ActivationRecord, ARType
>>> stack = CallStack()
>>> stack
CALL STACK


>>> ar = ActivationRecord(name='Main', type=ARType.PROGRAM, nesting_level=1)
>>>
>>> ar
1: PROGRAM Main
>>>
>>> ar['y'] = 7
>>>
>>> ar
1: PROGRAM Main
   y                   : 7
>>>
>>> stack
CALL STACK


>>> stack.push(ar)
>>>
>>> stack
CALL STACK
1: PROGRAM Main
   y                   : 7

>>>
```  
ä¸‹é¢å›¾ç‰‡ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°æ ˆå¸§å„éƒ¨åˆ†çš„è¯¦ç»†è¡¨è¿°ï¼š  
![](../_resources/lsbasi_part17_arcontents.png)  
`AR:Main1` è¡¨ç¤ºåµŒå¥—æ·±åº¦ä¸º1 çš„ï¼Œåç§°ä¸º`Main` çš„ç¨‹åºçš„æ ˆå¸§ã€‚  

ä¸‹é¢ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚  

## ä¸ºä»€ä¹ˆè¦ç”¨è°ƒç”¨æ ˆæ›¿æ¢GLOBAL_MEMORY  

åŸå› æ˜¯ä¸ºäº†ç®€åŒ–æˆ‘ä»¬çš„è§£é‡Šå™¨å®ç°ï¼Œå¹¶ä¸”ä¸ºè®¿é—®å…¨å±€ã€æˆ–è€…å±€éƒ¨å˜é‡æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ã€‚ä¸‹ä¸€ç« ä¸­æˆ‘ä»¬å°†ä¼šçœ‹åˆ°è¿™äº›æ˜¯å¦‚ä½•ç»“åˆåœ¨ä¸€èµ·çš„ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹æ€ä¹ˆåˆ©ç”¨æ ˆå¸§å’Œè°ƒç”¨æ ˆæ”¹é€ æˆ‘ä»¬çš„è§£é‡Šå™¨ã€‚  

## æ”¹è¿›è§£é‡Šå™¨  
å¯¹äºè§£é‡Šå™¨çš„æ”¹åŠ¨ä¸»è¦æœ‰5 å¤„ï¼š  
1. ä½¿ç”¨è°ƒç”¨æ ˆæ›¿æ¢`GLOBAL_MEMORY`  
2. æ›´æ–°`visit_Program` æ–¹æ³•åœ¨è°ƒç”¨æ ˆä¸­å‹å…¥/å¼¹å‡ºå…¨å±€æ ˆå¸§  
3. æ›´æ–°`visit_Assign` æ–¹æ³•ç”¨äºå‘æ ˆå¸§ä¸­æ·»åŠ å˜é‡  
4. æ›´æ–°`visit_Var` æ–¹æ³•ç”¨äºä»æ ˆå¸§ä¸­è·å–å˜é‡  
5. å¢åŠ `log` æ–¹æ³•ï¼Œå¹¶åœ¨`visit_Program` æ–¹æ³•ä¸­è°ƒç”¨ä»¥æ‰“å°è°ƒè¯•ä¿¡æ¯  

é¦–å…ˆä»æ›¿æ¢`GLOBAL_MEMORY` å­—å…¸å¼€å§‹ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬ä»¥å‰çš„ä»£ç ï¼š  
```python
class Interpreter(NodeVisitor):
    def __init__(self, tree):
        self.tree = tree
        self.GLOBAL_MEMORY = {}
```  

éœ€è¦æ›¿æ¢ä¸ºï¼š  
```python  
class Interpreter(NodeVisitor):
    def __init__(self, tree):
        self.tree = tree
        self.call_stack = CallStack()
```  

æ¥ä¸‹æ¥æ˜¯æ›´æ–°`visit_Program` æ–¹æ³•åœ¨è°ƒç”¨æ ˆä¸­å‹å…¥/å¼¹å‡ºå…¨å±€æ ˆå¸§ã€‚ä¹‹å‰çš„ä»£ç ï¼š  
```python  
def visit_Program(self, node):
    self.visit(node.block)
``` 
éœ€è¦æ›´æ–°ä¸ºï¼š  
```python  
def visit_Program(self, node):
    program_name = node.name

    # é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªPROGRAM ç±»å‹ï¼Œæ·±åº¦ä¸º1 çš„æ ˆå¸§  
    ar = ActivationRecord(
        name=program_name,
        type=ARType.PROGRAM,
        nesting_level=1,
    )
    # ç„¶åï¼Œå°†æ ˆå¸§å‹å…¥è°ƒç”¨æ ˆï¼Œè§£é‡Šå™¨å¯ä»¥ä½¿ç”¨æ ˆé¡¶å¸§æ¥è®¿é—®å…¨å±€å˜é‡
    self.call_stack.push(ar)

    # æ‰§è¡Œç¨‹åºä½“ã€‚è§£é‡Šå™¨å¯ä»¥ä½¿ç”¨æ ˆé¡¶å¸§è®¿é—®å…¨å±€å˜é‡
    self.visit(node.block)
    
    # åœ¨ç¦»å¼€æ–¹æ³•ä¹‹å‰ï¼Œè¯¥æ ˆå¸§çš„æ•°æ®éƒ½æ²¡æœ‰ç”¨äº†ï¼Œéœ€è¦åŠæ—¶æ¸…ç†æ‰  
    self.call_stack.pop()

    # è¯‘æ³¨ï¼š
    # å¿½ç„¶æƒ³åˆ°å‡½æ•°çš„è¿”å›å€¼åº”è¯¥æ˜¯ä½œä¸ºå¤–éƒ¨å‡½æ•°çš„ä¸€ä¸ªå±€éƒ¨å˜é‡å­˜åœ¨çš„å§ï¼ˆè¯·å¿½ç•¥
```

æ¥ç€æ˜¯æ›´æ–°`visit_Assign` æ–¹æ³•ç”¨äºå‘æ ˆå¸§ä¸­æ·»åŠ å˜é‡ã€‚ä»¥å‰çš„ä»£ç å¦‚ä¸‹ï¼š  
```python
def visit_Assign(self, node):
    var_name = node.left.value
    var_value = self.visit(node.right)
    self.GLOBAL_MEMORY[var_name] = var_value
```  
æ–°çš„ä»£ç ï¼š  
```python  
def visit_Assign(self, node):
    var_name = node.left.value
    var_value = self.visit(node.right)

    # å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œç”¨peek æ–¹æ³•ï¼Œå¹¶ä¸ä¼šä»è°ƒç”¨æ ˆä¸­ç§»é™¤è¯¥æ ˆå¸§  
    # å› ä¸ºæˆ‘ä»¬åªéœ€è¦æ ˆé¡¶å¸§çš„å¼•ç”¨å³å¯  
    ar = self.call_stack.peek()
    ar[var_name] = var_value
```
ç»§ç»­ï¼Œæˆ‘ä»¬å°†æ›´æ–°`visit_Var` æ–¹æ³•ç”¨äºä»æ ˆå¸§ä¸­è·å–å˜é‡ã€‚ä»¥ä¸‹æ˜¯åŸå…ˆçš„ä»£ç ï¼š  
```python  
def visit_Var(self, node):
    var_name = node.value
    var_value = self.GLOBAL_MEMORY.get(var_name)
    return var_value
```  
æ”¹åŠ¨åçš„ä»£ç ï¼š  
```python
def visit_Var(self, node):
    var_name = node.value

    # åŒæ ·ï¼Œè¿™é‡Œä¹Ÿæ˜¯ä½¿ç”¨äº†peek æ–¹æ³•ï¼Œè€Œä¸æ˜¯pop
    ar = self.call_stack.peek()
    var_value = ar.get(var_name)

    return var_value
```
æœ€åå¢åŠ `log` æ–¹æ³•ï¼Œå¹¶åœ¨`visit_Program` æ–¹æ³•ä¸­è°ƒç”¨ä»¥æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼š  
```python
def log(self, msg):
    if _SHOULD_LOG_STACK:
        print(msg)

def visit_Program(self, node):
    program_name = node.name
    self.log(f'ENTER: PROGRAM {program_name}')

    ar = ActivationRecord(
        name=program_name,
        type=ARType.PROGRAM,
        nesting_level=1,
    )
    self.call_stack.push(ar)

    self.log(str(self.call_stack))

    self.visit(node.block)

    self.log(f'LEAVE: PROGRAM {program_name}')
    self.log(str(self.call_stack))

    self.call_stack.pop()
```  

ä¸ä¸Šä¸€ç« ç›¸ä¼¼ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿæ˜¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°`--stack`ï¼Œæ¥æ§åˆ¶å…¨å±€å˜é‡`_SHOULD_LOG_STACK`ï¼Œè¿›ä¸€æ­¥æ§åˆ¶æ—¥å¿—æ‰“å°çš„å¼€å…³çš„ã€‚æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¿˜éœ€è¦è§£æå‘½ä»¤è¡Œå‚æ•°ï¼š  
```python
def main():
    parser = argparse.ArgumentParser(
        description='SPI - Simple Pascal Interpreter'
    )
    parser.add_argument('inputfile', help='Pascal source file')
    parser.add_argument(
        '--scope',
        help='Print scope information',
        action='store_true',
    )
    parser.add_argument(
        '--stack',
        help='Print call stack',
        action='store_true',
    )
    args = parser.parse_args()

    global _SHOULD_LOG_SCOPE, _SHOULD_LOG_STACK

    _SHOULD_LOG_SCOPE, _SHOULD_LOG_STACK = args.scope, args.stack
```  

ç°åœ¨æˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç äº†ã€‚å¯ä»¥ä»[GitHub](https://github.com/rspivak/lsbasi/tree/master/part17) ä¸‹è½½æœ€æ–°çš„è§£é‡Šå™¨æºç ï¼Œé€šè¿‡`-h` å‘½ä»¤å¯ä»¥è·å–ä½¿ç”¨å¸®åŠ©ï¼š  
```shell-session
$ python spi.py -h
usage: spi.py [-h] [--scope] [--stack] inputfile

SPI - Simple Pascal Interpreter

positional arguments:
  inputfile   Pascal source file

optional arguments:
  -h, --help  show this help message and exit
  --scope     Print scope information
  --stack     Print call stack
```  

åœ¨ä»“åº“ä¸­ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°æµ‹è¯•ç”¨çš„Pascal ä»£ç part17.pasï¼š  
```pascal
program Main;
var x, y : integer;
begin { Main }
   y := 7;
   x := (y + 3) * 3;
end.  { Main }
```  

å¯ä»¥æ‰“å¼€`--stack` å¼€å…³ï¼Œè¿è¡Œä¸€ä¸‹å¹¶æŸ¥çœ‹ç¨‹åºçš„è¾“å‡ºï¼š  
```shell-session
$ python spi.py part17.pas --stack
ENTER: PROGRAM Main
CALL STACK
1: PROGRAM Main


LEAVE: PROGRAM Main
CALL STACK
1: PROGRAM Main
   y                   : 7
   x                   : 30
```  

ä»»åŠ¡å®Œæˆï¼æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæ”¯æŒç¨‹åºã€è¿‡ç¨‹ã€å‡½æ•°è°ƒç”¨çš„æ–°çš„å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œè°ƒç”¨æ ˆã€‚å¹¶ç”¨å®ƒæ›¿æ¢æ‰äº†è€æ—§çš„`GLOBAL_MEMORY` å…¨å±€å­—å…¸ã€‚  

ä»¥ä¸Šå°±æ˜¯ä»Šå¤©çš„å…¨éƒ¨å†…å®¹ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†ä¼šæ‰©å±•æˆ‘ä»¬çš„è§£é‡Šå™¨å»æ‰§è¡Œè¿‡ç¨‹è°ƒç”¨ã€‚å¯¹æˆ‘ä»¬æ¥è¯´å°†ä¼šæ˜¯ä¸€ä¸ªå·¨å¤§çš„é‡Œç¨‹ç¢‘ã€‚å°½æƒ…æœŸå¾…ï¼Œå†è§ï¼  

## å‚è€ƒèµ„æ–™  
æœ‰å…´è¶£çš„è¯å¯ä»¥é˜…è¯»ä»¥ä¸‹ä¹¦ç±ï¼Œæ–‡ä¸­æœ‰å¤šå¤„å¯¹å®ƒä»¬çš„å¼•ç”¨ä¸å‚è€ƒï¼š  
1. [Language Implementation Patterns: Create Your Own Domain-Specific and General Programming Languages (Pragmatic Programmers)](http://www.amazon.com/gp/product/193435645X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=193435645X&linkCode=as2&tag=russblo0b-20&linkId=MP4DCXDV6DJMEJBL)  
2. [Writing Compilers and Interpreters: A Software Engineering Approach](https://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0470177071&linkCode=as2&tag=russblo0b-20&linkId=542d1267e34a529e0f69027af20e27f3)  
3. [Programming Language Pragmatics, Fourth Edition](https://www.amazon.com/gp/product/0124104096/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0124104096&linkCode=as2&tag=russblo0b-20&linkId=8db1da254b12fe6da1379957dda717fc)   
4. [Lead with a Story](https://www.amazon.com/gp/product/0814420303/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0814420303&linkCode=as2&tag=russblo0b-20&linkId=bee8bb0ac4fa2fb1ce587e093b6cfe6c)  
5. [A Wikipedia article on John Stephen Akhwari](https://en.wikipedia.org/wiki/John_Stephen_Akhwari)   


-----  
2022-07-13 22:29