13_è¯­ä¹‰åˆ†æ     

ğŸ“… 2017-04-27  

> ä»»ä½•å€¼å¾—åšçš„äº‹æƒ…ï¼Œéƒ½å€¼å¾—åšåˆ°æè‡´ã€‚  

åœ¨æˆ‘ä»¬æ·±å…¥æ¢è®¨ä½œç”¨åŸŸï¼ˆscopeï¼‰çš„è¯é¢˜ä¹‹å‰ï¼Œæˆ‘æƒ³æ›´è¯¦ç»†ã€æ›´ç³»ç»Ÿåœ°å›é¡¾ä¸€ä¸‹ç¬¦å·ã€ç¬¦å·è¡¨ã€å’Œè¯­ä¹‰åˆ†æçš„çŸ¥è¯†ã€‚æ­£å¦‚â€œä»»ä½•å€¼å¾—åšçš„äº‹æƒ…ï¼Œéƒ½å€¼å¾—åšåˆ°æè‡´â€ï¼Œæˆ‘å¸Œæœ›åœ¨å­¦ä¹ ä½œç”¨åŸŸæ—¶ï¼Œä½ ä¼šæ„Ÿè§‰åˆ°æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹ä¼¼ç»•äº†è¿œè·¯ï¼Œå…¶å®æ˜¯æ‰“ä¸‹äº†æ›´åŠ åšå®çš„åŸºç¡€ã€‚ä»Šå¤©æˆ‘ä»¬çš„ç›®æ ‡ä¾ç„¶æ˜¯å†™ç¼–è¯‘å™¨å’Œè§£é‡Šå™¨ï¼Œç›¸æ¯”äºç¬¬11 ç« ä¸­ç¬¬ä¸€æ¬¡æ¶‰åŠç¬¦å·å’Œç¬¦å·è¡¨æ—¶ï¼Œä½ ä¼šå‘ç°æœ¬æ–‡ä¸­çš„ææ–™æœ‰äº›éƒ¨åˆ†è¢«æå¤§åœ°æ‰©å……äº†ã€‚  
![](../_resources/lsbasi_part13_img01.png)  

Ok, è¯´å¹²å°±å¹²ï¼  

## å…³äºè¯­ä¹‰åˆ†æ  
> è¯‘æ³¨ï¼šæƒ³ä¸€æƒ³è¯­æ³•åˆ†ææ—¶ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šç”¨åˆ°ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•çš„æ¦‚å¿µï¼Œä¸Šä¸‹æ–‡æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ä¸Šä¸‹æ–‡æ— å…³ï¼Ÿä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ç›¸å…³ï¼Ÿ  
> æƒ³ä¸€æƒ³ï¼šå°æ˜æ—©ä¸Šåƒäº†ä¸€æ£µè‹¹æœæ ‘ã€‚è¿™å¥è¯åœ¨ä¸»è°“å®¾å®šçŠ¶è¡¥çš„è¯­æ³•ä¸‹æœ‰é”™è¯¯å—ï¼Ÿé‚£ä¹ˆåœ¨è¯­ä¹‰ä¸Šå‘¢ï¼Ÿ  

å°½ç®¡æˆ‘ä»¬çš„Pascal ç¨‹åºåœ¨è¯­æ³•ä¸Šæ²¡æœ‰é”™è¯¯ï¼Œå¹¶ä¸”å¯ä»¥è¢«è¯­æ³•åˆ†æå™¨æ‰€è¯†åˆ«ã€æˆåŠŸæ„å»ºæŠ½è±¡è¯­æ³•æ ‘ASTï¼Œä½†æ˜¯ç¨‹åºä»ç„¶å¯èƒ½åŒ…å«ç€ä¸¥é‡çš„é”™è¯¯ã€‚ä¸ºäº†æå‰æ•è·è¿™äº›é”™è¯¯ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°æŠ½è±¡è¯­æ³•æ ‘å’Œç¬¦å·è¡¨çš„ä¿¡æ¯ã€‚  

ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸åœ¨è¯­æ³•åˆ†æçš„æ—¶å€™å°±å»å°è¯•æ•è·è¿™äº›é”™è¯¯ï¼Ÿä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ„å»ºæŠ½è±¡è¯­æ³•æ ‘å’Œç¬¦å·è¡¨å»åšè¿™äº›äº‹æƒ…å‘¢ï¼Ÿ  

> è¯‘æ³¨ï¼šè½¯ä»¶è®¾è®¡ä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŸåˆ™ï¼Œå«åšå•ä¸€èŒè´£åŸåˆ™ã€‚å°±æ˜¯ä¸€ä¸ªæ–¹æ³•å†ç‰›ï¼Œä¹Ÿä¸è¦è®©å®ƒåŒæ—¶å¤„ç†å¾ˆå¤šäº‹æƒ…ã€‚å› ä¸ºè¿™ä¼šè®©ç¨‹åºè¶Šæ¥è¶Šéš¾ä»¥ç»´æŠ¤ã€‚  

ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯å¤„äºä¾¿åˆ©æ€§å’Œç¨‹åºè§£è€¦çš„è€ƒé‡ã€‚é€šè¿‡å°†è¿™äº›å·¥ä½œæå–åˆ°å•ç‹¬çš„ç¯èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥è®©è¯­æ³•åˆ†æå™¨å’Œè§£é‡Šå™¨åªä¸“æ³¨äºæœ¬èŒå·¥ä½œã€‚å½“ç¨‹åºé€šè¿‡è¯­æ³•åˆ†æå™¨åï¼Œæˆ‘ä»¬å°±çŸ¥é“ç¨‹åºåœ¨è¯­æ³•ä¸Šæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ã€‚ä¸‹ä¸€æ­¥å°±æ˜¯æ ¹æ®ç¨‹åºä¸Šä¸‹æ–‡å’Œå…¶ä»–ä¿¡æ¯å»æ£€æŸ¥è¯­æ³•åˆ†æå™¨è¦†ç›–èŒƒå›´ä¹‹å¤–çš„é”™è¯¯äº†ã€‚æˆ‘ä»¬ä»¥ä¸‹é¢èµ‹å€¼è¯­å¥æ¥å…·ä½“è¯´æ˜ä¸€ä¸‹ï¼š  
```pascal
x := x + y;
```

ä¸Šé¢è¿™æ¡è¯­å¥å¯ä»¥é€šè¿‡è¯­æ³•åˆ†æå™¨ï¼Œå› ä¸ºå®ƒç¬¦åˆæˆ‘ä»¬`å˜é‡ èµ‹å€¼è¿ç®—ç¬¦ è¡¨è¾¾å¼;` çš„è¯­æ³•è§„åˆ™ã€‚ä½†æ˜¯ç”±äºPascal è¯­è¨€çš„å˜é‡éœ€è¦å…ˆå£°æ˜æ‰èƒ½è¢«ä½¿ç”¨ï¼Œå¹¶ä¸”å‚ä¸è¿ç®—çš„æ•°æ®ç±»å‹ä¹Ÿè¦ä¿æŒä¸€è‡´ï¼Œæ‰€ä»¥åˆ°è¿™é‡Œæˆ‘ä»¬çš„æ•…äº‹è¿œæœªç»“æŸã€‚å¦‚ä½•è®©è¯­æ³•åˆ†æå™¨çŸ¥é“å˜é‡`x,y` å·²ç»è¢«æ­£ç¡®åœ°å£°æ˜äº†å‘¢ï¼Ÿ  
äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•åˆ†æå™¨å¹¶ä¸çŸ¥é“ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦ä¸“é—¨çš„è¯­ä¹‰åˆ†æç¯èŠ‚å»å¤„ç†è¯¸å¦‚ï¼šå˜é‡å£°æ˜æ£€æŸ¥ã€å˜é‡ç±»å‹æ£€æŸ¥çš„é—®é¢˜ã€‚  

ä»€ä¹ˆæ˜¯â€œè¯­ä¹‰åˆ†æâ€ï¼Œç®€å•æ¥è¯´è¯­ä¹‰åˆ†æï¼ˆsemantic analysisï¼‰å°±æ˜¯ä¸€ä¸ªå¤„ç†è¿‡ç¨‹ï¼Œç”¨äºæ£€æŸ¥æˆ‘ä»¬çš„ä»£ç åœ¨æŸä¸ªè¯­è¨€ç¯å¢ƒä¸­æ˜¯å¦æœ‰æ„ä¹‰ï¼ˆmake senseï¼‰ã€‚é‚£ä»€ä¹ˆæ˜¯æœ‰æ„ä¹‰å‘¢ï¼Ÿè¿™éœ€è¦æ ¹æ®è¯­è¨€çš„è¦æ±‚å’Œå®šä¹‰å…·ä½“è¯´æ˜ï¼Œä¾‹å¦‚ï¼šè‹¹æœæ ‘ä¸€èˆ¬æ¥è¯´æ˜¯ä¸èƒ½è¢«äººåƒçš„:(  

Pascal è¯­è¨€ï¼Œå°¤å…¶æ˜¯Free Pascal ç¼–è¯‘å™¨ï¼Œå¯¹æˆ‘ä»¬çš„ä»£ç æœ‰ä¸€äº›è¦æ±‚ï¼Œå³ä½¿è¯­æ³•æ˜¯æ­£ç¡®çš„ï¼Œä½†åœ¨ä»ä¸èƒ½é€šè¿‡è¯­ä¹‰åˆ†æï¼š  
- ä½¿ç”¨æœªç»å£°æ˜çš„å˜é‡ï¼›  
- ç®—æœ¯è¿ç®—ä¸­ä½¿ç”¨äº†ç±»å‹ä¸ä¸€è‡´çš„å˜é‡ï¼ˆç±»å‹æ£€æŸ¥ï¼Œåé¢ä¼šæœ‰ä¸“é¢˜è®²è§£ï¼‰ï¼›  
- å˜é‡ã€è¿‡ç¨‹ç¬¦å·çš„é‡å¤å£°æ˜ï¼›  
- è¿‡ç¨‹åå¿…é¡»æŒ‡å‘å·²ç»è¢«å®šä¹‰çš„è¿‡ç¨‹ï¼›
- è¿‡ç¨‹è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å‚æ•°çš„æ•°é‡å’Œç±»å‹éƒ½æ»¡è¶³è¦æ±‚ã€‚  

> è¯‘æ³¨ï¼šæƒ³æƒ³ä¸ºä»€ä¹ˆæœ‰äº›è¯­è¨€ä¼šæœ‰å˜é‡æå‡çš„æ¦‚å¿µï¼Ÿä¸ºä»€ä¹ˆC è¯­è¨€å¤šåœ¨.c æ–‡ä»¶ä¸­å®ç°äº†å‡½æ•°ï¼Œå´è¿˜è¦åœ¨.h æ–‡ä»¶ä¸­å£°æ˜ä¸€ä¸‹ã€‚è¿™ä¸AST çš„éå†é¡ºåºæœ‰å…³å—ï¼Ÿ  

åœ¨æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„ç¨‹åºä¸Šä¸‹æ–‡ä¿¡æ¯æ—¶ï¼Œå¾ˆå®¹æ˜“æ‰§è¡Œä¸Šè¿°çš„è¦æ±‚ã€‚ä¸Šä¸‹æ–‡å³æŠ½è±¡è¯­æ³•æ ‘AST çš„ä¸€ç§ä¸­é—´è¡¨ç¤ºå’Œç¬¦å·è¡¨ä¸­å…³äºä¸é€šå®ä½“çš„ä¿¡æ¯ï¼Œå¦‚å˜é‡ã€è¿‡ç¨‹å’Œå‡½æ•°ã€‚  

åœ¨å®ç°äº†è¯­ä¹‰åˆ†æç¯èŠ‚ä¹‹åï¼Œæˆ‘ä»¬çš„è§£é‡Šå™¨ç»“æ„åº”å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![](../_resources/lsbasi_part13_img03.png)  

ä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯æ³•åˆ†æå™¨Lexer å°†æºç åˆ†è§£æˆä¸€äº›åˆ—çš„è¯ç´ Tokenï¼›è¯­æ³•åˆ†æå™¨Parser é€šè¿‡è¯»å–Token åŒ¹é…ç›¸åº”çš„è¯­æ³•è§„åˆ™åç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ASTï¼›è¯­ä¹‰åˆ†æå™¨Semantic Analyser é€šè¿‡éå†AST æ£€æŸ¥ç¨‹åºæ˜¯å¦åˆæƒ…åˆç†ã€‚åœ¨é€šè¿‡äº†è¯­ä¹‰æ£€æŸ¥åï¼Œè§£é‡Šå™¨Interpreter ä¼šéå†AST è§£é‡Šæ‰§è¡Œã€‚  

ä¸‹é¢å¼€å§‹è®²ä¸€ä¸‹è¯­ä¹‰åˆ†æçš„ç»†èŠ‚ï¼š  

## ç¬¦å·å’Œç¬¦å·è¡¨  
æœ¬èŠ‚æˆ‘ä»¬å°†è®¨è®ºç¬¦å·è¡¨çš„å®ç°å’Œè¯­ä¹‰æ£€æŸ¥çš„å®ç°ï¼šå¦‚ä½•å¯¹æˆ‘ä»¬çš„Pascal ä»£ç è¿ç”¨è¯­ä¹‰åˆ†æã€‚å°½ç®¡è¿™äº›æ¦‚å¿µå¬èµ·æ¥å¾ˆæ·±å¥¥ï¼Œä½†æ˜¯åªè¦ä¿æŒç”¨å¿ƒï¼Œå®ƒä»¬ä¹Ÿåªæ˜¯åœ¨åˆ›å»ºAST ä¹‹åçš„ä¸€ä¸ªç¯èŠ‚è€Œå·²ã€‚åªä¸è¿‡è´Ÿè´£å¤„ç†ä¸€äº›è¯­æ³•åˆ†æå™¨æ— æ³•çŸ¥é“çš„ä¸Šä¸‹æ–‡ç›¸å…³çš„é”™è¯¯ç½¢äº†ã€‚  

ä»Šå¤©æˆ‘ä»¬ä¸»è¦èšç„¦äºé™æ€è¯­ä¹‰åˆ†æï¼š  
1. ä½¿ç”¨æœªç»å£°æ˜çš„å˜é‡ï¼›  
2. å˜é‡è¢«é‡å¤å£°æ˜ã€‚  

> æ³¨ï¼š  
> é™æ€è¯­ä¹‰æ£€æŸ¥æ˜¯åœ¨ç¨‹åºæ‰§è¡Œå‰çš„å®Œæˆçš„ã€‚é€šè¿‡éå†AST å’Œç¬¦å·è¡¨ä¿¡æ¯å°±èƒ½å®ç°ï¼›  
> åŠ¨æ€è¯­ä¹‰æ£€æŸ¥æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œçš„ï¼Œä¾‹å¦‚é™¤æ•°ä¸º0 çš„æ£€æŸ¥å’Œæ•°ç»„çš„è¶Šç•Œè®¿é—®ç­‰ã€‚  

é¦–å…ˆï¼Œæˆ‘ä»¬å­¦ä¹ æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä½¿ç”¨æœªç»å£°æ˜çš„å˜é‡çš„è¡Œä¸ºã€‚çœ‹ä¸‹é¢çš„Pascal ä»£ç ï¼Œå®ƒåœ¨è¯­æ³•ä¸Šæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯æ— æ³•é€šè¿‡è¯­ä¹‰åˆ†æï¼š  
```Pascal
program Main;
   var x : integer;

begin
    x := y;
end.
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¨‹åºå£°æ˜äº†ä¸€ä¸ªå˜é‡ï¼Œå´å¼•ç”¨äº†ä¸¤ä¸ªå˜é‡ï¼š  
![](../_resources/lsbasi_part13_img04.png)

æˆ‘ä»¬å®æ“æ£€æŸ¥ä¸€ä¸‹ç¨‹åºèƒ½å¦é€šè¿‡è¯­æ³•åˆ†æå™¨ã€‚ä¸‹è½½[spi.py](https://github.com/rspivak/lsbasi/blob/master/part13/spi.py)ã€‚å¹¶åœ¨Python Shell ä¸­æ‰§è¡Œï¼š  
```shel-session
>>> from spi import Lexer, Parser
>>> text = """
program Main;
   var x : integer;

begin
    x := y;
end.
"""
>>>
>>> lexer = Lexer(text)
>>> parser = Parser(lexer)
>>> tree = parser.parse()
>>>
```

çœ‹å§ï¼Œæ²¡é”™è€¶ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥é€šè¿‡[gendotast.py](https://github.com/rspivak/lsbasi/blob/master/part13/genastdot.py) ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼šå°†ä¸Šè¾¹ä»£ç ä¿å­˜ä¸º`semanticerror01.pas` å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š  
```shell-session
$ python genastdot.py semanticerror01.pas > semanticerror01.dot
$ dot -Tpng -o ast.png semanticerror01.dot
```

ä¸‹é¢æ˜¯æŠ½è±¡è¯­æ³•æ ‘çš„ç»“æ„å›¾ï¼š  
![](../_resources/lsbasi_part13_img05.png)

æ‰€ä»¥ï¼Œä¸Šé¢çš„ç¨‹åºè¯­æ³•ä¸Šæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯ç¨‹åºå´æ²¡æœ‰æ„ä¹‰ã€‚å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å˜é‡`y` åœ¨å“ªé‡Œï¼Œæ›´åˆ«æèµ‹å€¼è¯­å¥æ˜¯å¦å­˜åœ¨æ„ä¹‰äº†ã€‚å¦‚æœå˜é‡æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæ€ä¹ˆèƒ½è®²å­—ç¬¦ä¸²èµ‹å€¼ç»™æ•´æ•°å˜é‡å‘¢ï¼Ÿè‡³å°‘åœ¨Pascal ä¸­è¿™æ ·åšæ˜¯ä¸è¢«å…è®¸çš„ã€‚  

ä¸‹é¢åœ¨çœ‹ä¸€ä¸ªæ²¡æœ‰é”™è¯¯çš„ä¾‹å­ï¼š  
```Pascal
program Main;
   var x, y : integer;

begin
    x := x + y;
end.
```
- å£°æ˜äº†ä¸¤ä¸ªå˜é‡`x` å’Œ`y`  
- åœ¨èµ‹å€¼è¯­å¥ä¸­å¼•ç”¨äº†ä¸‰æ¬¡å˜é‡ï¼š`x`ï¼Œ`x` å’Œ`y`  

![](../_resources/lsbasi_part13_img06.png)

ä¸Šé¢è¿™æ®µä»£ç å¯ä»¥é€šè¿‡è¯­æ³•åˆ†æä¹Ÿå¯ä»¥é€šè¿‡è¯­ä¹‰åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å°†ä¸¤ä¸ªæ•´æ•°ç›¸åŠ èµ‹å€¼ç»™å¦ä¸€ä¸ªæ•´æ•°å˜é‡ä¹Ÿæ˜¯æœ‰æ„ä¹‰çš„ã€‚ä½†æ˜¯å¦‚ä½•è®©ä»£ç èƒ½å¤Ÿæ£€æŸ¥å˜é‡`x,y` åœ¨ä½¿ç”¨å‰å·²ç»è¢«æ­£ç¡®åœ°å£°æ˜äº†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ç®—æ³•æ¥å®ç°ï¼š  
1. è¿‡ä¸€éæ‰€æœ‰çš„å˜é‡å£°æ˜çš„éƒ¨åˆ†  
2. é‡åˆ°å˜é‡å£°æ˜è¯­å¥ï¼Œå°±æ”¶é›†å¿…è¦çš„ä¿¡æ¯  
3. å­˜å‚¨æ”¶é›†åˆ°çš„ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å˜é‡ååšKey è¿›è¡ŒæŸ¥æ‰¾  
4. å½“é‡åˆ°å¼•ç”¨å˜é‡æ—¶ï¼Œå°±å»æ£€æŸ¥ä¸€ä¸‹è¯¥å˜é‡æ˜¯å¦å·²ç»å­˜åœ¨äº†ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¯æ˜å˜é‡å·²è¢«å£°æ˜ï¼›å¦åˆ™ï¼Œå°±æ˜¯ä¸€ä¸ªè¯­ä¹‰ä¸Šçš„é”™è¯¯ã€‚

ä¹Ÿè®¸é€šè¿‡æµç¨‹å›¾çœ‹å¾—ä¼šæ›´æ¸…æ™°ä¸€äº›ï¼š  
![](../_resources/lsbasi_part13_img07.png)

åœ¨å®ç°ä¸Šè¿°ç®—æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å›ç­”ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š  
- A. æˆ‘ä»¬éœ€è¦æ”¶é›†å“ªäº›å˜é‡ä¿¡æ¯  
- B. æˆ‘ä»¬è¯¥å¦‚ä½•å­˜å‚¨è¿™äº›ä¿¡æ¯  
- C. å¦‚ä½•å»è¿‡ä¸€éæ‰€æœ‰çš„å˜é‡å£°æ˜

è€Œæˆ‘ä»¬ä¸‹ä¸€æ­¥çš„è®¡åˆ’ä¹Ÿå¾ˆç®€å•ï¼š  
1. å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼›
2. å¯¹ç…§ç­”æ¡ˆå»å®ç°ç¬¬ä¸€ä¸ªé™æ€è¯­ä¹‰æ£€æŸ¥ï¼šæ£€æŸ¥å˜é‡æ˜¯å¦æœªç»å£°æ˜å°±è¢«ä½¿ç”¨  

### éœ€è¦æ”¶é›†çš„å˜é‡ä¿¡æ¯  
æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¶é›†å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿä¸‹é¢æ˜¯æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼š  
- å˜é‡åï¼Œç”¨äºæ£€ç´¢å˜é‡  
- ç±»åˆ«ï¼Œç”¨äºè¡¨æ˜æ ‡è¯†ç¬¦æ˜¯å˜é‡ã€è¿˜æ˜¯ç±»å‹ã€æŠ‘æˆ–æ˜¯è¿‡ç¨‹ç­‰  
- ç±»å‹ï¼Œç”¨äºç±»å‹æ£€æŸ¥  

ç¬¦å·Symbol æœ¬èº«åŒ…å«ä»¥ä¸Šè¿™äº›ä¿¡æ¯ã€‚ç¬¦å·å°±æ˜¯ä¸€ä¸ªç¨‹åºå®ä½“ï¼Œä¾‹å¦‚å˜é‡ã€å­ç¨‹åºã€ç±»å‹ç­‰ã€‚ä¸‹é¢çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡å˜é‡å£°æ˜åˆ›å»ºä¸¤ä¸ªç¬¦å·`x` å’Œ`y`ï¼š  
![](../_resources/lsbasi_part13_img08.png)  

ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`Symbol` ç±»æ¥è¡¨ç¤ºç¬¦å·ï¼š   
```python
class Symbol(object):
    def __init__(self, name, type=None):
        self.name = name
        self.type = type
```

å¯ä»¥çœ‹åˆ°ï¼Œæ„é€ å‡½æ•°æ¥æ”¶`name` ä½œä¸ºå‚æ•°ï¼Œè¿˜æœ‰å¯é€‰çš„å‚æ•°`type`ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¬¦å·éƒ½éœ€è¦æŒ‡å®šç±»å‹ã€‚é‚£ä¹ˆç±»åˆ«å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ç±»åè¡¨ç¤ºç¬¦å·çš„ç±»åˆ«ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ï¼š  
```python
class Symbol(object):
    def __init__(self, name, type=None, category):
        self.name = name
        self.type = type
        self.category = category
```

ç„¶è€Œï¼Œä»¥Symbol ç±»åä½œä¸ºç¬¦å·ç±»åˆ«ï¼Œå°†ä¼šä½¿ç±»class çš„å±‚çº§å…³ç³»æ›´æ˜ç¡®ã€‚  

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘å·²ç»ç»•è¿‡äº†ä¸€ä¸ªè¯é¢˜ï¼Œé‚£å°±æ˜¯å†…ç½®ç±»å‹ã€‚å¦‚æœä½ å†çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„ç¤ºä¾‹ç¨‹åºï¼š  
```pascal
program Main;
   var x, y : integer;

begin
    x := x + y;
end.
```  

å¯ä»¥çœ‹åˆ°å˜é‡`x,y` è¢«å£°æ˜ä¸ºæ•´æ•°ç±»å‹ã€‚ä»€ä¹ˆæ˜¯æ•´æ•°ç±»å‹ï¼Ÿè¿™æ˜¯ä¸€ç§å†…ç½®çš„ç±»å‹ç¬¦å·ï¼Œä¹‹æ‰€ä»¥ç§°ä¸ºå†…ç½®ï¼Œæ˜¯å› ä¸ºå®ƒä¸éœ€è¦å£°æ˜å°±å¯ä»¥ä½¿ç”¨ã€‚æˆ–è€…è¯´å®ƒæ˜¯ç”±æˆ‘ä»¬çš„ç¼–è¯‘å™¨æå‰å£°æ˜çš„ï¼š   
![](../_resources/lsbasi_part13_img09.png)  

æˆ‘ä»¬é€šè¿‡æ„å»ºä¸€ä¸ªä¸“é—¨çš„ç±»æ¥è¡¨ç¤ºå†…ç½®ç±»å‹ï¼Œ`BuiltinTypeSymbol`ï¼š  
```python
class BuiltinTypeSymbol(Symbol):
    def __init__(self, name):
        super().__init__(name)

    def __str__(self):
        return self.name

    def __repr__(self):
        return "<{class_name}(name='{name}')>".format(
            class_name=self.__class__.__name__,
            name=self.name,
        )
```

è¯¥ç±»ç»§æ‰¿è‡ª`Symbol`ï¼Œå…¶æ„é€ å‡½æ•°åªéœ€è¦`name` å‚æ•°ç”¨äºè¡¨ç¤ºç¬¦å·ç±»å‹ï¼Œå¦‚ï¼šæ•´æ•°integerã€å®æ•°realã€‚å¯ä»¥çœ‹åˆ°ç±»åˆ«é€šè¿‡ç±»å`self.__class__.__name__`è¡¨ç¤ºã€‚ç±»å‹ç•™ç©ºä¸º`None`ã€‚  

> æ³¨ï¼š  
> åŒä¸‹åˆ’çº¿çš„æ–¹æ³•ï¼š`__str__` å’Œ`__repr__` åªæ˜¯ä¸ºäº†è®©æ‰“å°æ›´ç¾è§‚è€Œå·²  

é¡ºä¾¿ä¸€æï¼Œå†…ç½®ç±»å‹å°±æ˜¯ä¸ºä»€ä¹ˆSymbol ç±»çš„æ„é€ å‡½æ•°ä¸­type å‚æ•°æ˜¯å¯é€‰å‚æ•°çš„åŸå› ã€‚  

ä»¥ä¸‹æ˜¯ç¬¦å·ç±»çš„å±‚çº§å…³ç³»ï¼š  
![](../_resources/lsbasi_part13_img10.png)  

ä¸‹è½½[spi.py](https://github.com/rspivak/lsbasi/blob/master/part13/spi.py) å¹¶åœ¨Python Shell ä¸­æ‰§è¡Œï¼Œå¯ä»¥éªŒè¯å®šä¹‰å†…ç½®ç±»å‹ï¼š
```shell-session
$ python
>>> from spi import BuiltinTypeSymbol
>>> int_type = BuiltinTypeSymbol('integer')
>>> int_type
<BuiltinTypeSymbol(name='integer')>
>>>
>>> real_type = BuiltinTypeSymbol('real')
>>> real_type
<BuiltinTypeSymbol(name='real')>
```  

ä»¥ä¸Šæ˜¯ç›®å‰ä¸ºæ­¢æ‰€æœ‰å†…ç½®ç±»å‹ç›¸å…³çš„çŸ¥è¯†ï¼Œç°åœ¨å›åˆ°å˜é‡ç¬¦å·ã€‚åœ¨ä»£ç ä¸­å¦‚ä½•è¡¨ç¤ºå˜é‡ç¬¦å·ï¼Ÿæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»`VarSymbol`ï¼š  
```python
class VarSymbol(Symbol):
    def __init__(self, name, type):
        super().__init__(name, type)

    def __str__(self):
        return "<{class_name}(name='{name}', type='{type}')>".format(
            class_name=self.__class__.__name__,
            name=self.name,
            type=self.type,
        )

    __repr__ = __str__
```

åœ¨`VarSymbol` ç±»ä¸­ï¼Œæ„é€ å‡½æ•°éœ€è¦æ¥æ”¶ç±»å‹åname å’Œç±»å‹typeï¼ˆç›®å‰ä¸ºæ­¢åªæœ‰ä¸¤ç§å†…ç½®ç±»å‹çš„å®ä¾‹å¯¹è±¡æ‰å¯ä»¥ï¼‰ä½œä¸ºå‚æ•°ã€‚

å›åˆ°Python Shellï¼Œæ‰‹åŠ¨æ„é€ å˜é‡ç¬¦å·ï¼š  
```shell-session
$ python
>>> from spi import BuiltinTypeSymbol, VarSymbol
>>> int_type = BuiltinTypeSymbol('integer')
>>> real_type = BuiltinTypeSymbol('real')
>>>
>>> var_x_symbol = VarSymbol('x', int_type)
>>> var_x_symbol
<VarSymbol(name='x', type='integer')>
>>>
>>> var_y_symbol = VarSymbol('y', real_type)
>>> var_y_symbol
<VarSymbol(name='y', type='real')>
>>>
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å†…ç½®ç±»å‹çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ å…¥å˜é‡ç¬¦å·çš„æ„é€ å‡½æ•°ã€‚å¦‚`var x:integer`ï¼Œå˜é‡ç¬¦å·å¿…é¡»åŒæ—¶å…·å¤‡å˜é‡åå’Œç›¸å…³çš„æ•°æ®ç±»å‹æ–¹å¯ã€‚ä¸‹å›¾æ˜¯ç›®å‰æ‰€æœ‰ç¬¦å·çš„å±‚çº§å…³ç³»ï¼š  
![](../_resources/lsbasi_part13_img11.png)

### å­˜å‚¨ç¬¦å·ä¿¡æ¯
ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†å˜é‡å£°æ˜æ—¶çš„ç¬¦å·ä¿¡æ¯ï¼Œé‚£åº”è¯¥å¦‚ä½•å­˜å‚¨å¯ä»¥è®©æˆ‘ä»¬åœ¨é‡åˆ°å˜é‡å¼•ç”¨æ—¶èƒ½å¤Ÿæ ¹æ®ç¬¦å·åæ£€ç´¢å‘¢ï¼Ÿ  
ç­”æ¡ˆæˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œå°±æ˜¯ä½¿ç”¨ç¬¦å·è¡¨ã€‚ç¬¦å·è¡¨ç¤ºä¸€ç§ç”¨äºè¿½è¸ªå¤šç§ç¬¦å·çš„æŠ½è±¡æ•°æ®ç»“æ„ã€‚å¯ä»¥æƒ³è±¡ä¸ºä¸€ä¸ªå­—å…¸ï¼ŒKey æ˜¯ç¬¦å·åï¼Œvalue å°±æ˜¯ç¬¦å·å¯¹è±¡å®ä¾‹ã€‚ä¸ºäº†è¡¨ç¤ºç¬¦å·è¡¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªç±»`SymbolTable` ç±»ï¼Œè¯¥ç±»çš„å®ä¾‹å¯¹è±¡å¯ä»¥é€šè¿‡`insert` æ–¹æ³•æ·»åŠ ç¬¦å·åˆ°å†…éƒ¨çš„æœ‰åºå­—å…¸`_symbols`ã€‚  
```python
class SymbolTable(object):
    def __init__(self):
        self._symbols = {}

    def __str__(self):
        symtab_header = 'Symbol table contents'
        lines = ['\n', symtab_header, '_' * len(symtab_header)]
        lines.extend(
            ('%7s: %r' % (key, value))
            for key, value in self._symbols.items()
        )
        lines.append('\n')
        s = '\n'.join(lines)
        return s

    __repr__ = __str__

    def insert(self, symbol):
        print('Insert: %s' % symbol.name)
        self._symbols[symbol.name] = symbol
```

é€šè¿‡ä¸‹é¢ä¾‹ç¨‹ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ç”Ÿæˆç¬¦å·è¡¨ã€‚å› ä¸ºç›®å‰è¿˜æ²¡æœ‰å®šä¹‰æ£€ç´¢çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä»£ç ä¸­åªæœ‰å˜é‡çš„å£°æ˜ï¼š  
```pascal
program SymTab1;
   var x, y : integer;

begin

end.
```

ä¸‹è½½[symtab01.py](https://github.com/rspivak/lsbasi/blob/master/part13/symtab01.py) å¹¶è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„è¾“å‡ºå¦‚ä¸‹ï¼š  
```shell-session
$ python symtab01.py
Insert: INTEGER
Insert: x
Insert: y


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
      x: <VarSymbol(name='x', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>
```  

æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨Python Shell ä¸­æ‰‹å·¥æ„é€ ç¬¦å·è¡¨ï¼š  
```shell-session
$ python
>>> from symtab01 import SymbolTable, BuiltinTypeSymbol, VarSymbol
>>> symtab = SymbolTable()
>>> int_type = BuiltinTypeSymbol('INTEGER')
>>> # now let's store the built-in type symbol in the symbol table
...
>>> symtab.insert(int_type)
Insert: INTEGER
>>>
>>> symtab


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>


>>> var_x_symbol = VarSymbol('x', int_type)
>>> symtab.insert(var_x_symbol)
Insert: x
>>> symtab


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
      x: <VarSymbol(name='x', type='INTEGER')>


>>> var_y_symbol = VarSymbol('y', int_type)
>>> symtab.insert(var_y_symbol)
Insert: y
>>> symtab


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
      x: <VarSymbol(name='x', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>


>>>
```

åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å›ç­”äº†ä¸¤ä¸ªé—®é¢˜ï¼š  
- A. æˆ‘ä»¬éœ€è¦æ”¶é›†å˜é‡çš„é‚£äº›ä¿¡æ¯ï¼Ÿå˜é‡åã€ç±»åˆ«ä»¥åŠå˜é‡çš„ç±»å‹  
- B. å¦‚ä½•å­˜å‚¨è¿™äº›ä¿¡æ¯ï¼Ÿå­˜åˆ°ç¬¦å·è¡¨ä¸­  

### å¦‚ä½•éå†å˜é‡çš„å£°æ˜  
å› ä¸ºæˆ‘ä»¬å·²ç»æœ‰äº†ASTï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ã€‚åªéœ€è¦åˆ›å»ºæ–°çš„AST visitor ç±»è´Ÿè´£éå†å°±å¥½äº†ï¼Œé‡åˆ°`VarDecl` èŠ‚ç‚¹å°±é‡‡å–æªæ–½ã€‚æ‰€ä»¥ç¬¬ä¸‰ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯ï¼š  
- C. å¦‚ä½•éå†å˜é‡å£°æ˜ï¼Ÿé€šè¿‡æ„é€ æ€§çš„AST visitor ç±»ï¼Œé‡åˆ°`VarDecl` å°±å­˜å‚¨å˜é‡

äºæ˜¯æˆ‘ä»¬åˆ›å»º`SemanticAnalyzer` ç±»æ¥éå†ASTï¼Œä»¥ä¸‹é¢ç¨‹åºä¸ºä¾‹ï¼š  
```pascal
program SymTab2;
   var x, y : integer;

begin

end.
```

ä¸ºäº†åˆ†æä¸Šé¢ç¨‹åºä»£ç ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å®ç°å…¨éƒ¨çš„`visit_xxx` æ–¹æ³•ã€‚ä¸‹é¢çš„ä»£ç éª¨æ¶ä¸­åŒ…å«äº†æˆ‘ä»¬æ‰€éœ€çš„æ‰€æœ‰visit æ–¹æ³•ï¼š  
```python
class SemanticAnalyzer(NodeVisitor):
    def __init__(self):
        self.symtab = SymbolTable()

    def visit_Block(self, node):
        for declaration in node.declarations:
            self.visit(declaration)
        self.visit(node.compound_statement)

    def visit_Program(self, node):
        self.visit(node.block)

    def visit_Compound(self, node):
        for child in node.children:
            self.visit(child)

    def visit_NoOp(self, node):
        pass

    def visit_VarDecl(self, node):
        #  Actions go here
        pass
```

ç°åœ¨æˆ‘ä»¬æœ‰äº†ç¬¬ä¸€ä¸ªé™æ€è¯­ä¹‰æ£€æŸ¥çš„æ‰€æœ‰æ­¥éª¤ï¼Œå®ƒå°†ä¼šåœ¨å˜é‡è¢«ä½¿ç”¨å‰æ£€æŸ¥è¯¥å˜é‡æ˜¯å¦å·²ç»è¢«å£°æ˜ã€‚ä¸‹é¢é‡å¤ä¸€ä¸‹ç®—æ³•çš„é€»è¾‘ï¼š  
1. è¿‡ä¸€éæ‰€æœ‰çš„å˜é‡å£°æ˜çš„éƒ¨åˆ†  
2. é‡åˆ°å˜é‡å£°æ˜è¯­å¥ï¼Œå°±æ”¶é›†å¿…è¦çš„ä¿¡æ¯  
3. å­˜å‚¨æ”¶é›†åˆ°çš„ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å˜é‡ååšKey è¿›è¡ŒæŸ¥æ‰¾  
4. å½“é‡åˆ°å¼•ç”¨å˜é‡æ—¶ï¼Œå°±å»æ£€æŸ¥ä¸€ä¸‹è¯¥å˜é‡æ˜¯å¦å·²ç»å­˜åœ¨äº†ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¯æ˜å˜é‡å·²è¢«å£°æ˜ï¼›å¦åˆ™ï¼Œå°±æ˜¯ä¸€ä¸ªè¯­ä¹‰ä¸Šçš„é”™è¯¯ã€‚

ä¸‹é¢å»å®ç°è¿™äº›æ­¥éª¤ï¼Œå®é™…ä¸Šåªéœ€è¦å‘`visit_VarDecl` æ–¹æ³•å¡«å……æ–°çš„å†…å®¹å°±å¥½äº†ï¼š  
```python
def visit_VarDecl(self, node):
    # For now, manually create a symbol for the INTEGER built-in type
    # and insert the type symbol in the symbol table.
    type_symbol = BuiltinTypeSymbol('INTEGER')
    self.symtab.insert(type_symbol)

    # We have all the information we need to create a variable symbol.
    # Create the symbol and insert it into the symbol table.
    var_name = node.var_node.value
    var_symbol = VarSymbol(var_name, type_symbol)
    self.symtab.insert(var_symbol)
```

ä»”ç»†è§‚å¯Ÿè¯¥æ–¹æ³•ï¼Œä½ ä¼šå‘ç°å®ƒå®é™…å·²ç»åŒ…å«äº†å‰ä¸‰ä¸ªæ­¥éª¤ï¼š  
1. è¯¥æ–¹æ³•ä¼šåœ¨æ¯ä¸ªå˜é‡å£°æ˜ä¸­è¢«è°ƒç”¨ã€‚  
2. å¯¹äºæ¯ä¸€ä¸ªå˜é‡è°ƒç”¨ï¼Œè¯¥æ–¹æ³•éƒ½ä¼šæ”¶é›†å˜é‡åã€å˜é‡ç±»å‹ç­‰ä¿¡æ¯ã€‚  
3. è¯¥æ–¹æ³•ä¼šå°†å˜é‡ä¿¡æ¯å­˜å…¥ç¬¦å·è¡¨ä¸­ï¼Œä»¥å˜é‡åä¸ºKeyã€‚  

å¯ä»¥é€šè¿‡ä¸‹è½½[symtab02.py](https://github.com/rspivak/lsbasi/blob/master/part13/symtab02.py)ï¼Œå¹¶åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œï¼Œè¿›ä¸€æ­¥è§‚å¯Ÿå…¶å·¥ä½œæ­¥éª¤ï¼š  
```shell-session
$ python symtab02.py
Insert: INTEGER
Insert: x
Insert: INTEGER
Insert: y


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
      x: <VarSymbol(name='x', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>
```

ä¹Ÿè®¸ä½ å·²æ³¨æ„åˆ°ä¸Šé¢æœ‰ä¸¤è¡Œè¾“å‡º`Insert: INTEGER`ã€‚æˆ‘ä»¬å°†ä¼šåœ¨æœ¬èŠ‚è®¨è®ºæ­¥éª¤4 çš„æ—¶å€™ä¿®å¤å®ƒã€‚  

æ­¥éª¤4ï¼šå½“é‡åˆ°å¼•ç”¨å˜é‡æ—¶ï¼Œå°±å»æ£€æŸ¥ä¸€ä¸‹è¯¥å˜é‡æ˜¯å¦å·²ç»å­˜åœ¨äº†ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¯æ˜å˜é‡å·²è¢«å£°æ˜ï¼›å¦åˆ™ï¼Œå°±æ˜¯ä¸€ä¸ªè¯­ä¹‰ä¸Šçš„é”™è¯¯ã€‚ä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°ç¬¦å·è¡¨å’Œè¯­ä¹‰åˆ†æå™¨ï¼š  
1. ç¬¦å·è¡¨åº”å½“æ”¯æŒç¬¦å·æ£€ç´¢çš„åŠŸèƒ½ï¼›  
2. è¯­ä¹‰åˆ†æå™¨åº”å½“åœ¨æ¯æ¬¡é‡åˆ°ç¬¦å·å¼•ç”¨æ—¶éƒ½èƒ½å»æ£€ç´¢ç¬¦å·è¡¨çœ‹ç¬¦å·æ˜¯å¦å·²ç»å£°æ˜ã€‚  

é¦–å…ˆï¼Œæˆ‘ä»¬å‡çº§ç¬¦å·è¡¨ï¼Œæ·»åŠ æ”¯æŒæ£€ç´¢åŠŸèƒ½çš„æ–¹æ³•`lookup`ã€‚æ¢è€Œè¨€ä¹‹ï¼Œ`lookup` æ–¹æ³•è´Ÿè´£æ ¹æ®ç¬¦å·åæ£€ç´¢ç¬¦å·çš„å£°æ˜æƒ…å†µã€‚è¿™ä¸ªè¿‡ç¨‹ä¸€èˆ¬è¢«ç§°ä¸ºç¬¦å·åç§°è§£æï¼š  
```python
def lookup(self, name):
    print('Lookup: %s' % name)
    symbol = self._symbols.get(name)
    # 'symbol' is either an instance of the Symbol class or None
    return symbol
```

è¯¥æ–¹æ³•ä»¥ç¬¦å·åä¸ºå‚æ•°ï¼Œå¦‚æœç¬¦å·è¡¨ä¸­æœ‰ç›¸å…³ä¿¡æ¯ï¼Œåˆ™è¿”å›è¯¥ç¬¦å·ï¼Œå¦åˆ™è¿”å›Noneã€‚  

æ¥ä¸‹æ¥å‡çº§ç¬¦å·è¡¨ç±»ï¼Œæ·»åŠ `_init_builtins` æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ã€‚è¿™æ ·å°±èƒ½æå‰å£°æ˜æ‰€æœ‰å†…ç½®ç±»å‹çš„ç¬¦å·ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°ç¬¦å·è¡¨ä¸­ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç ï¼š  
```python
class SymbolTable(object):
    def __init__(self):
        self._symbols = {}
        self._init_builtins()

    def _init_builtins(self):
        self.insert(BuiltinTypeSymbol('INTEGER'))
        self.insert(BuiltinTypeSymbol('REAL'))

    def __str__(self):
        symtab_header = 'Symbol table contents'
        lines = ['\n', symtab_header, '_' * len(symtab_header)]
        lines.extend(
            ('%7s: %r' % (key, value))
            for key, value in self._symbols.items()
        )
        lines.append('\n')
        s = '\n'.join(lines)
        return s

    __repr__ = __str__

    def insert(self, symbol):
        print('Insert: %s' % symbol.name)
        self._symbols[symbol.name] = symbol

    def lookup(self, name):
        print('Lookup: %s' % name)
        symbol = self._symbols.get(name)
        # 'symbol' is either an instance of the Symbol class or None
        return symbol
```

ç°åœ¨æˆ‘ä»¬æœ‰äº†å†…ç½®å˜é‡ç±»å‹å’Œæ£€ç´¢ç¬¦å·è¡¨çš„æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ›´æ–°è¯­ä¹‰åˆ†æå™¨çš„`visit_VarDecl` æ–¹æ³•æ›¿æ¢æ‰æ‰‹å·¥åˆ›å»ºç¬¦å·è¡¨çš„ä»£ç ã€‚äºæ˜¯ä¸Šä¾‹ä¸­å¤šä½™çš„æ‰“å°æ“ä½œå°†ä¼šè¢«ä¿®æ­£ï¼Œä»¥ä¸‹æ˜¯å˜æ›´ï¼š  
```python
# æœ€åˆç‰ˆæœ¬çš„visit_VarDeclï¼š  
def visit_VarDecl(self, node):
    # For now, manually create a symbol for the INTEGER built-in type
    # and insert the type symbol in the symbol table.
    type_symbol = BuiltinTypeSymbol('INTEGER')
    self.symtab.insert(type_symbol)

    # We have all the information we need to create a variable symbol.
    # Create the symbol and insert it into the symbol table.
    var_name = node.var_node.value
    var_symbol = VarSymbol(var_name, type_symbol)
    self.symtab.insert(var_symbol)

# æ›´æ–°åçš„visit_VarDeclï¼š  
def visit_VarDecl(self, node):
    type_name = node.type_node.value
    type_symbol = self.symtab.lookup(type_name)

    # We have all the information we need to create a variable symbol.
    # Create the symbol and insert it into the symbol table.
    var_name = node.var_node.value
    var_symbol = VarSymbol(var_name, type_symbol)
    self.symtab.insert(var_symbol)
```

å°†ä¸Šè¿°æ”¹å˜åº”ç”¨è‡³Pascal ç¨‹åºï¼š  
```pascal
program SymTab3;
   var x, y : integer;

begin

end.
```

ä¸‹è½½[Symtab03.py](https://github.com/rspivak/lsbasi/blob/master/part13/symtab03.py) å¹¶è¿è¡Œï¼Œä½ ä¼šå‘ç°å¤šä½™çš„ï¼ˆå†…ç½®å˜é‡å£°æ˜ï¼‰æ‰“å°æ“ä½œå·²ç»ä¸å¤å­˜åœ¨äº†ï¼š
```shel-session
$ python symtab03.py
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: x
Lookup: INTEGER
Insert: y


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>
```

å¹¶ä¸”å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„è¯­ä¹‰åˆ†æå™¨æŸ¥æ‰¾äº†ä¸¤æ¬¡`INTEGER` å†…ç½®ç±»å‹ï¼šç¬¬ä¸€æ¬¡ç”¨äºå£°æ˜å˜é‡xï¼Œç¬¬äºŒæ¬¡ç”¨äºå£°æ˜å˜é‡yã€‚  

æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­è®¨è®ºå˜é‡çš„å¼•ç”¨ï¼Œä»¥åŠå¦‚ä½•è§£æå˜é‡åã€‚ä»¥èµ‹å€¼è¯­å¥`x:=x+y` ä¸ºä¾‹ï¼Œè¿™é‡Œå¼•ç”¨äº†ä¸‰æ¬¡å˜é‡ï¼š`x,x,y`ï¼š  
```pascal
program SymTab4;
    var x, y : integer;

begin
    x := x + y;
end.
```

åœ¨ç¬¦å·è¡¨ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†`looup` æ–¹æ³•ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•æ‰©å±•æˆ‘ä»¬çš„è¯­ä¹‰åˆ†æå™¨å‘¢ï¼Ÿä¸çŸ¥é“ä½ æ˜¯å¦è¿˜è®°å¾—åœ¨éå†AST æ—¶ï¼Œå“ªä¸ªæ–¹æ³•è¡¨ç¤ºå¯¹å˜é‡çš„å¼•ç”¨å‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯`visit_Var`ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨æ­¤æ–¹æ³•ä¸­æ·»åŠ è°ƒç”¨`lookup` çš„ä»£ç å°±å¥½äº†ï¼š  
```python
def visit_Var(self, node):
    var_name = node.value
    var_symbol = self.symtab.lookup(var_name)
```

å› ä¸ºSymtab04 ç¨‹åºä¸­çš„èµ‹å€¼è¯­å¥åŒ…å«åŠ æ³•æ“ä½œï¼Œå®ƒæ˜¯ä¸€ä¸ªäºŒå…ƒè¿ç®—ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸ºè¯­ä¹‰åˆ†æå™¨å¢åŠ èµ‹å€¼æ“ä½œä¸äºŒå…ƒè¿ç®—ç›¸å…³çš„æ–¹æ³•ï¼š`visit_Assign` å’Œ`visit_BinOp`ã€‚å¹¶æ²¡æœ‰æ–°çš„å†…å®¹ï¼Œå®Œå…¨å¯ä»¥ç…§æŠ„ä¹‹å‰çš„ï¼š  
```python
def visit_Assign(self, node):
    # right-hand side
    self.visit(node.right)
    # left-hand side
    self.visit(node.left)

def visit_BinOp(self, node):
    self.visit(node.left)
    self.visit(node.right)
```

ä½ å¯ä»¥åœ¨[symtab04.py](https://github.com/rspivak/lsbasi/blob/master/part13/symtab04.py) ä¸­å‘ç°å®Œæ•´çš„ä»£ç ã€‚ä¹Ÿå¯ä»¥ä¸‹è½½ååœ¨æœ¬åœ°åŠ¨æ‰‹éªŒè¯ï¼š  
```shell-session
$ python symtab04.py
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: x
Lookup: INTEGER
Insert: y
Lookup: x
Lookup: y
Lookup: x


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>
```

ä»”ç»†è§‚å¯Ÿä¸€ä¸‹è¾“å‡ºï¼Œç¡®ä¿è‡ªå·±ç†è§£äº†ä¸ºä»€ä¹ˆç¨‹åºä¼šæŒ‰è¿™ä¸ªé¡ºåºè¾“å‡ºç»“æœã€‚  
è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªé™æ€è¯­ä¹‰åˆ†æçš„æ‰€æœ‰ç®—æ³•æ­¥éª¤ï¼Œèƒ½å¤Ÿæ£€æŸ¥å˜é‡æ˜¯å¦åœ¨ä½¿ç”¨å‰è¢«å£°æ˜ï¼  

## è¯­ä¹‰é”™è¯¯  
ç›®å‰æˆ‘ä»¬å·²ç»èƒ½æŸ¥æ‰¾ç¨‹åºä¸­çš„å˜é‡æ˜¯å¦å·²ç»è¢«å£°æ˜ï¼Œé‚£å¦‚æœå¼•ç”¨æœªç»å£°æ˜çš„å˜é‡æˆ‘ä»¬è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦è¯­ä¹‰åˆ†æå™¨èƒ½å¤ŸæŠ¥å‘Šä¸€ä¸ªè¯­ä¹‰é”™è¯¯ã€‚ä»¥ä¸‹é¢ç¨‹åºä¸ºä¾‹ï¼Œä½¿ç”¨äº†æœªç»å£°æ˜çš„å˜é‡`y`ï¼š  
```pascal
program SymTab5;
    var x : integer;

begin
    x := y;
end.
```  

ä¸ºäº†èƒ½äº§ç”Ÿä¸€ä¸ªè¯­ä¹‰åˆ†æçš„é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ£€ç´¢ç¬¦å·è¡¨æ—¶ï¼Œå¦‚æœè¿”å›Noneï¼Œå°±è¡¨ç¤ºç¬¦å·æœªå®šä¹‰ï¼Œåº”è¯¥æŠ¥å‘Šé”™è¯¯ï¼š   
```python
def visit_Var(self, node):
    var_name = node.value
    var_symbol = self.symtab.lookup(var_name)
    if var_symbol is None:
        raise Exception(
            "Error: Symbol(identifier) not found '%s'" % var_name
        )
```

ä¸‹è½½[symtab05.py](https://github.com/rspivak/lsbasi/blob/master/part13/symtab05.py) åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œï¼Œçœ‹ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼š  
```shell-session
$ python symtab05.py
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: x
Lookup: y
Error: Symbol(identifier) not found 'y'


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='INTEGER')>
```

å¯ä»¥çœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼š**Error: Symbol(identifier) not found â€˜yâ€™** å’Œç¬¦å·è¡¨çš„å†…å®¹è¢«æ‰“å°å‡ºæ¥ã€‚ç°åœ¨æˆ‘ä»¬çš„è¯­ä¹‰åˆ†æå™¨å¯ä»¥åœ¨é‡åˆ°ä½¿ç”¨æœªç»å£°æ˜çš„å˜é‡æ—¶ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸äº†ï¼Œå¯å–œå¯è´º:)  

è¿™æ˜¯ä¸€ä¸ªé‡Œç¨‹ç¢‘å¼åœ°è·¨è¶Šã€‚å–œæ‚¦ä¹‹ä½™ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å®ç°ç¬¬äºŒæ¡é™æ€è¯­ä¹‰æ£€æŸ¥ï¼šæ˜¯å¦å­˜åœ¨é‡å¤å£°æ˜å˜é‡çš„é—®é¢˜ï¼Œå¦‚ä¸‹é¢ä¾‹ç¨‹æ‰€ç¤ºï¼š  
```pascal
program SymTab6;
   var x, y : integer;
   var y : real;
begin
   x := x + y;
end.
```

å˜é‡`y` è¢«å£°æ˜äº†ä¸¤æ¬¡ï¼šä¸€æ¬¡æ˜¯æ•´æ•°ï¼Œç´§æ¥ç€æœ‰è¢«å£°æ˜ä¸ºå®æ•°ç±»å‹ã€‚ä¸ºäº†æ•è·è¿™ç§é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦ç»§ç»­æ›´æ–°`visit_VarDecl` æ–¹æ³•ï¼Œåœ¨æ·»åŠ ç¬¦å·ä¹‹å‰å…ˆå»æ£€æŸ¥ç¬¦å·æ˜¯å¦å·²å­˜åœ¨ã€‚å¦‚æœæ˜¯ï¼Œåˆ™æŠ¥é‡å¤å£°æ˜çš„é”™è¯¯ï¼š  
```python
def visit_VarDecl(self, node):
    type_name = node.type_node.value
    type_symbol = self.symtab.lookup(type_name)

    # We have all the information we need to create a variable symbol.
    # Create the symbol and insert it into the symbol table.
    var_name = node.var_node.value
    var_symbol = VarSymbol(var_name, type_symbol)

    # Signal an error if the table alrady has a symbol
    # with the same name
    if self.symtab.lookup(var_name) is not None:
        raise Exception(
            "Error: Duplicate identifier '%s' found" % var_name
        )

    self.symtab.insert(var_symbol)
```

å¯ä»¥ä¸‹è½½[symtab06.py](https://github.com/rspivak/lsbasi/blob/master/part13/symtab06.py) å¹¶è¿è¡Œä»¥è§‚å¯Ÿè¿™äº›æ”¹å˜ï¼š  
```shell-session
$ python symtab06.py
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Lookup: x
Insert: x
Lookup: INTEGER
Lookup: y
Insert: y
Lookup: REAL
Lookup: y
Error: Duplicate identifier 'y' found


Symbol table contents
_____________________
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>
```  

ä»”ç»†å­¦ä¹ è¾“å‡ºå’Œç¬¦å·è¡¨çš„å†…å®¹ï¼Œç¡®ä¿å°†è¯­ä¹‰åˆ†æçš„æµç¨‹äº†ç„¶äºèƒ¸ã€‚  

## æ€»ç»“  
å¿«é€Ÿå›é¡¾ä¸€ä¸‹ä»Šæ—¥æ‰€å­¦çš„å†…å®¹ï¼š  
- å­¦ä¹ äº†æ›´å¤šå…³äºç¬¦å·ã€ç¬¦å·è¡¨å’Œè¯­ä¹‰åˆ†æçš„çŸ¥è¯†  
- å¦‚ä½•ä»ç¬¦å·è¡¨ä¸­è§£æç¬¦å·çš„å£°æ˜  
- å¦‚ä½•é€šè¿‡ä»£ç å®ç°è¯­ä¹‰åˆ†æå™¨ã€éå†ASTã€æ„å»ºç¬¦å·è¡¨ï¼Œä»¥åŠåŸºæœ¬çš„è¯­ä¹‰æ£€æŸ¥  

å†æä¸€å¥ï¼Œç°åœ¨æˆ‘ä»¬çš„è§£é‡Šå™¨ç»“æ„å¦‚ä¸‹ï¼š  
![](../_resources/lsbasi_part13_img03.png)  

ä»¥ä¸Šå°±æ˜¯ä»Šå¤©çš„å…¨éƒ¨å†…å®¹ï¼Œè‡³æ­¤æˆ‘ä»¬ä¹Ÿåšå¥½äº†å­¦ä¹ ä½œç”¨åŸŸï¼Œä½œç”¨åŸŸä¸ç¬¦å·è¡¨çš„å…³ç³»ï¼Œåœ¨åµŒå¥—ä½œç”¨åŸŸä¸‹çš„è¯­ä¹‰åˆ†æç­‰å†…å®¹çš„å‡†å¤‡å·¥ä½œã€‚è¿™äº›å°†æ˜¯ä¸‹ä¸€èŠ‚çš„æ ¸å¿ƒå†…å®¹ã€‚å†è§ï¼

-----  
2022-07-04 00:43