11_ç¬¦å·è¡¨ç®¡ç†   

ğŸ“… 2016-09-20  

æŸå¤©ï¼Œæˆ‘åœ¨æƒ³æˆ‘ä»¬å·²ç»å®Œæˆäº†å¤šå°‘å†…å®¹äº†ï¼Œæˆ‘ä»¬åº”è¯¥å›é¡¾ä¸€ä¸‹ä¹‹å‰æ‰€å­¦ï¼Œä¹Ÿçœ‹ä¸€ä¸‹å°†æ¥è¿˜éœ€è¦å­¦ä¹ å“ªäº›å†…å®¹äº†ã€‚  
![](../_resources/lsbasi_part11_recap.png)  

è¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š  
- è¯æ³•åˆ†æï¼Œä»¥åŠåœ¨ä¸å€ŸåŠ©æ­£åˆ™è¡¨è¾¾å¼æˆ–å¤–éƒ¨å·¥å…·ï¼ˆå¦‚[Lex](https://en.wikipedia.org/wiki/Lex_(software))ï¼‰çš„æƒ…å†µä¸‹åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„è¯æ³•åˆ†æå™¨ã€‚  
- è¯­æ³•åˆ†æï¼Œé€šè¿‡è¯­æ³•è§„åˆ™è§£ætoken æµã€‚æ„é€ æˆ‘ä»¬è‡ªå·±çš„è¯­æ³•åˆ†æå™¨ã€‚  
- é€šè¿‡è¯­æ³•å›¾è¡¨ç¤ºè¯­æ³•è§„åˆ™ã€‚è¯­æ³•å›¾å¯ä»¥å½¢è±¡åœ°å‘æˆ‘ä»¬å±•ç¤ºè¯­å¥çš„æ­£ç¡®ä¸å¦ã€‚  
- ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ã€‚  
- ç¼–å†™ä¸€ä¸ªåŸºæœ¬çš„è§£é‡Šå™¨ã€‚  
- è¿ç®—ç¬¦çš„å…³è”æ€§å’Œä¼˜å…ˆçº§ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ä¼˜å…ˆçº§è¡¨æ„é€ è¯­æ³•è§„åˆ™ã€‚  
- å¦‚ä½•æ„é€ æŠ½è±¡è¯­æ³•æ ‘ï¼Œä»¥åŠå¦‚ä½•ç”¨ä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘è¡¨ç¤ºPascal ç¨‹åºã€‚  
- å¦‚ä½•éå†æŠ½è±¡è¯­æ³•æ ‘æ¥å®ç°è§£é‡Šå™¨ã€‚  

é€šè¿‡ä¹‹å‰çš„å­¦ä¹ å’Œå®è·µï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªè§£é‡Šå™¨ï¼Œå®ƒå¯ä»¥å®ç°è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€æ„å»ºASTå¹¶é€šè¿‡éå†AST èŠ‚ç‚¹æ¥è§£é‡Šç¨‹åºä»£ç ã€‚è€å®è¯´ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œä½ åº”è¯¥å¾—åˆ°è¡¨æ‰¬ï¼Œä½†æ˜¯è¯·ä¸è¦è¢«èƒœåˆ©å†²æ˜äº†å¤´è„‘ã€‚å°½ç®¡æˆ‘ä»¬å·²ç»èµ°è¿‡äº†å¾ˆè¿œçš„è·¯ï¼Œä½†å‰æ–¹ä»ç„¶æœ‰ç€ä»¤äººå…´å¥‹çš„æœªçŸ¥ï¼Œè¯¸å›ï¼Œå‰è¿›å§ï¼   

æœ‰äº†ä»¥å‰çŸ¥è¯†çš„é“ºå«ï¼Œç°åœ¨æˆ‘ä»¬è¦ä¸»å¤‡å¤„ç†ä»¥ä¸‹è¯¾é¢˜äº†ï¼š  
- åµŒå¥—è¿‡ç¨‹ä¸å‡½æ•°ï¼ˆå®šä¹‰ï¼‰  
- è¿‡ç¨‹å’Œå‡½æ•°çš„è°ƒç”¨  
- è¯­ä¹‰åˆ†æï¼ˆç±»å‹æ£€æŸ¥ã€å˜é‡å£°æ˜ç¡®è®¤ï¼‰  
- æ§åˆ¶æµï¼ˆä¾‹å¦‚IF è¯­å¥ï¼‰  
- èšåˆæ•°æ®ç±»å‹ï¼ˆç›²çŒœæ˜¯ç±»ä¼¼äºç»“æ„ä½“çš„è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼‰  
- æ›´å¤šå†…ç½®æ•°æ®ç±»å‹  
- æºç çº§åˆ«çš„è°ƒè¯•å™¨  
- æ‚é¡¹

ä½†æ˜¯åœ¨å¼€å§‹è¿™äº›è¯¾é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ‰“å¥½åŸºç¡€ï¼Œå®Œæˆå‡†å¤‡å·¥ä½œï¼š  
![](../_resources/lsbasi_part11_foundation.png)  

è¿™é‡Œæˆ‘ä»¬å¼€å§‹æ·±å…¥ç ”ç©¶ç¬¦å·ã€ç¬¦å·è¡¨å’Œä½œç”¨åŸŸè¿™äº›è¶…çº§é‡è¦çš„æ¦‚å¿µã€‚è¿™äº›æ¦‚å¿µå°†ä¼šè·¨è¶Šå¥½å‡ ç« å†…å®¹ï¼Œæ‰€ä»¥è¯·åšå¥½å¿ƒç†å‡†å¤‡ï¼Œåé¢ä½ ä¼šçŸ¥é“æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è¿™æ ·åšã€‚ç°åœ¨å°±å¼€å§‹å§ã€‚  

## ç¬¦å·Symbol  
é¦–å…ˆæ˜¯ç¬¦å·ï¼Œä»¥åŠæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ç”¨åˆ°ç¬¦å·ã€‚è¿™é‡Œæˆ‘ä»¬å®šä¹‰ç¬¦å·å°±æ˜¯ä¸€äº›ç¨‹åºå†…å®¹çš„æ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚ï¼šå˜é‡ã€å­ç¨‹åºæˆ–è€…ç±»å‹ç­‰éƒ½å±äºç¬¦å·ã€‚åŸºäºä½¿ç”¨éœ€è¦ï¼Œç¬¦å·è‡³å°‘åº”å…·å¤‡ä»¥ä¸‹å†…å®¹ï¼š  
- ç¬¦å·å  
- ç¬¦å·ç±»åˆ«ï¼ˆå˜é‡ã€ç±»å‹ã€å­ç¨‹åºç­‰ï¼‰  
- ç¬¦å·ç±»å‹ï¼ˆæ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰  

ä»Šå¤©æˆ‘ä»¬ä¸»è¦å¤„ç†å˜é‡ç¬¦å·å’Œå†…ç½®ç±»å‹çš„ç¬¦å·ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰å·²ç»ä½¿ç”¨è¿‡ç›¸å…³çš„æ¦‚å¿µäº†ã€‚é¡ºä¾¿æä¸€å¥ï¼Œâ€œå†…ç½®ç±»å‹â€æ˜¯ç¼–è¯‘å™¨æˆ–ç¿»è¯‘å™¨å·²ç»æå‰å£°æ˜å¥½çš„ç¬¦å·ï¼Œä¸éœ€è¦åœ¨ç”¨æˆ·ç¨‹åºä¸­åˆ›å»ºå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚  

ä¸‹é¢çš„Pascal ä¾‹ç¨‹ä¸€å…±ä½¿ç”¨äº†å››ä¸ªç¬¦å·æ¥å£°æ˜å˜é‡ï¼šä¸¤ä¸ªå˜é‡å’Œä¸¤ä¸ªç±»å‹ï¼š  
![](./../_resources/lsbasi_part11_prog_symbols.png)  


åœ¨ä»£ç ä¸­åº”è¯¥å¦‚ä½•è¡¨ç¤ºç¬¦å·çš„æ¦‚å¿µå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª`Symbol` ç±»ï¼š  
```python
class Symbol(object):
    def __init__(self, name, type=None):
        self.name = name
        self.type = type
```

å¯ä»¥çœ‹åˆ°ï¼Œæ„é€ æ–¹æ³•ä¸­`type` å‚æ•°æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¬¦å·éƒ½éœ€è¦æŒ‡å®šç±»å‹ã€‚é‚£ä¹ˆå¦‚ä½•ç¡®å®šç¬¦å·çš„ç±»åˆ«å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ç±»åæ¥å¯¹ç¬¦å·çš„ç±»åˆ«è¿›è¡Œç¼–ç ã€‚ä¹Ÿå°±æ˜¯å¯¹äºä¸åŒçš„ç¬¦å·ç±»åˆ«ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå¯¹åº”çš„å­ç±»ã€‚  

ç›®å‰æˆ‘ä»¬å·²ç»æœ‰æ•´æ•°å’Œå®æ•°ä¸¤ç§å†…ç½®ç±»å‹äº†ï¼Œæ‰€ä»¥ä»Šå¤©å°±ä»¥å®ƒä»¬ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹å¦‚ä½•åˆ›å»ºå†…ç½®ç¬¦å·ï¼š  
```python
class BuiltinTypeSymbol(Symbol):
    def __init__(self, name):
        super().__init__(name)

    def __str__(self):
        return self.name

    __repr__ = __str__
```

`BuiltinTypeSymbol` ç±»é›†æˆè‡ª`Symbol` ç±»ï¼Œä½†æ˜¯æ„é€ å‡½æ•°åªéœ€è¦ä¼ å…¥ç¬¦å·åå³å¯ã€‚è€ŒåŒä¸‹åˆ’çº¿çš„`__repr__` å’Œ`__str__()` çš„ç›®çš„æ˜¯ä¸ºäº†è®©æˆ‘ä»¬è°ƒè¯•ç¨‹åºæ—¶çš„è¾“å‡ºæ›´ç¾è§‚ã€‚  

ä¸‹è½½è§£é‡Šå™¨[spi.py](https://github.com/rspivak/lsbasi/blob/master/part11/python/spi.py)ï¼Œå¹¶åœ¨å‘½ä»¤è¡Œæ•å£ä¸ä¹‹äº¤äº’ä»¥å¢å¼ºç†è§£ï¼š  
```shell-session
$ python
>>> from spi import BuiltinTypeSymbol
>>> int_type = BuiltinTypeSymbol('INTEGER')
>>> int_type
INTEGER
>>> real_type = BuiltinTypeSymbol('REAL')
>>> real_type
REAL
```
 
å¦‚ä½•åˆ›å»ºå˜é‡ç¬¦å·å‘¢ï¼ŸåŒæ ·æˆ‘ä»¬ä¹Ÿéœ€è¦åˆ›å»ºä¸€ä¸ª`VarSymbol` çš„å­ç±»ï¼š  
```python
class VarSymbol(Symbol):
    def __init__(self, name, type):
        super().__init__(name, type)

    def __str__(self):
        return '<{name}:{type}>'.format(name=self.name, type=self.type)

    __repr__ = __str__
```

å˜é‡ç¬¦å·ä¸­æˆ‘ä»¬éœ€è¦ä¼ å…¥ç¬¦å·åå’Œå˜é‡ç±»å‹ï¼Œè¯¥ç±»çš„å®ä¾‹å¯¹è±¡è¡¨ç¤ºä¸€ä¸ªå˜é‡ç¬¦å·ï¼Œå¦‚`a`ï¼Œ`b`ç­‰ã€‚  

é€šè¿‡ä¸Šé¢çš„å‘½ä»¤çª—å£ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å˜é‡ç¬¦å·æ˜¯å¦‚ä½•æ„é€ çš„ï¼š  
```python
$ python
>>> from spi import BuiltinTypeSymbol, VarSymbol
>>> int_type = BuiltinTypeSymbol('INTEGER')
>>> real_type = BuiltinTypeSymbol('REAL')
>>>
>>> var_x_symbol = VarSymbol('x', int_type)
>>> var_x_symbol
<x:INTEGER>
>>> var_y_symbol = VarSymbol('y', real_type)
>>> var_y_symbol
<y:REAL>
```  

å¦‚ä½ æ‰€è§ï¼Œåœ¨æ„å»ºå˜é‡ç¬¦å·ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å£°æ˜ç±»å‹çš„ç¬¦å·ï¼Œè¿™æ ·æ‰èƒ½ä¼ å…¥å˜é‡ç¬¦å·çš„æ„é€ å‡½æ•°ä¸­å»ã€‚ï¼ˆåé¢æˆ‘ä»¬å°†æ›´æ–°è§£é‡Šå™¨ï¼Œå†…ç½®ç±»å‹ç¬¦å·å°±ä¸éœ€è¦äººå·¥å£°æ˜äº†ï¼‰  

ä¸‹é¢æ˜¯ä¸‰ç§ç¬¦å·ç±»å‹çš„ç»§æ‰¿å…³ç³»ï¼š  
![](./../_resources/lsbasi_part11_symbol_hierarchy.png)  

çœ‹èµ·æ¥è¿˜ä¸é”™ï¼Œä½†æ˜¯ç›®å‰æˆ‘ä»¬è¿˜æœªæ˜è¯´ä¸ºå•¥ä¼šç”¨åˆ°è¿™äº›ç¬¦å·å‘¢ï¼ŸåŸå› ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š  
- æˆ‘ä»¬éœ€è¦åœ¨å˜é‡èµ‹å€¼æ—¶åšç±»å‹æ£€æŸ¥ï¼Œä»¥ç¡®ä¿ä¸ä¼šè¯¯æ“ä½œ  
- å˜é‡åº”å½“å…ˆå£°æ˜å†ä½¿ç”¨ï¼  

ä»¥ä¸‹é¢çš„Pascal ç¨‹åºä¸ºä¾‹ï¼š  
![](../_resources/lsbasi_part11_symtracking.png)  

ä»¥ä¹‹å‰æåˆ°çš„[Free Pascal Compiler](http://www.freepascal.org/) ç¼–è¯‘å¯ä»¥çŸ¥é“ï¼š  
- `x := 2 + y;` è¡¨è¾¾å¼ä¼šæŠ¥ç±»å‹ä¸å…¼å®¹çš„é”™è¯¯ï¼›  
- `x := a;` å› ä¸ºä½¿ç”¨æ²¡æœ‰å£°æ˜çš„å˜é‡`a`ï¼Œä¹Ÿä¼šå¯¼è‡´å˜é‡å¼‚å¸¸ã€‚  


ä¸ºäº†èƒ½åœ¨ç¨‹åºè¿è¡Œå‰å®šä½åˆ°é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬æ‰éœ€è¦è·Ÿè¸ªç¨‹åºä¸­çš„ç¬¦å·ã€‚ä¹‹å‰ä¹Ÿæåˆ°è¿‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¬¦å·è¡¨ä¸­æš‚å­˜ç¨‹åºä¸­éœ€è¦ç”¨åˆ°çš„ç¬¦å·ï¼   

## ç¬¦å·è¡¨  
ç¬¦å·è¡¨æ˜¯ä¸€ç§æŠ½è±¡æ•°æ®ç»“æ„ï¼Œç”¨äºè¿½è¸ªPascal ç¨‹åºä¸­å„ç§ç¬¦å·ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¼šé€šè¿‡å•ç‹¬çš„`SymbolTable` ç±»æ¥ç®¡ç†ç¬¦å·è¡¨åŠå…¶å†…å®¹ï¼š  
```python
class SymbolTable(object):
    def __init__(self):
        self._symbols = {}

    def __str__(self):
        s = 'Symbols: {symbols}'.format(
            symbols=[value for value in self._symbols.values()]
        )
        return s

    __repr__ = __str__

    def define(self, symbol):
        print('Define: %s' % symbol)
        self._symbols[symbol.name] = symbol

    def lookup(self, name):
        print('Lookup: %s' % name)
        symbol = self._symbols.get(name)
        # 'symbol' is either an instance of the Symbol class or 'None'
        return symbol
```

ç¬¦å·è¡¨ç±»ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼šå®šä¹‰ç¬¦å·`define`ï¼Œç”¨äºå­˜å‚¨ç¬¦å·åˆ°å†…éƒ¨çš„å­—å…¸ï¼›æŸ¥æ‰¾ç¬¦å·`lookup`ï¼Œä»å†…éƒ¨å­—å…¸ä¸­æŸ¥æ‰¾ç¬¦å·æ˜¯å¦å·²å®šä¹‰ã€‚  

ä¸‹é¢æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç¬¦å·è¡¨ï¼š  
```Pascal
PROGRAM Part11;
VAR
   x : INTEGER;
   y : REAL;

BEGIN

END.
```  

å¯åŠ¨ä¹‹å‰ä¸‹è½½çš„`spi.py` æ–‡ä»¶ï¼š  
```shell-session
$ python
>>> from spi import SymbolTable, BuiltinTypeSymbol, VarSymbol
>>> symtab = SymbolTable()
>>> int_type = BuiltinTypeSymbol('INTEGER')
>>> symtab.define(int_type)
Define: INTEGER
>>> symtab
Symbols: [INTEGER]
>>>
>>> var_x_symbol = VarSymbol('x', int_type)
>>> symtab.define(var_x_symbol)
Define: <x:INTEGER>
>>> symtab
Symbols: [INTEGER, <x:INTEGER>]
>>>
>>> real_type = BuiltinTypeSymbol('REAL')
>>> symtab.define(real_type)
Define: REAL
>>> symtab
Symbols: [INTEGER, <x:INTEGER>, REAL]
>>>
>>> var_y_symbol = VarSymbol('y', real_type)
>>> symtab.define(var_y_symbol)
Define: <y:REAL>
>>> symtab
Symbols: [INTEGER, <x:INTEGER>, REAL, <y:REAL>]
```

ç¬¦å·è¡¨å†…éƒ¨å­—å…¸`_symbols` å†…å®¹å¦‚ä¸‹ï¼ˆæ³¨æ„çœ‹ç¬¦å·è¡¨æ˜¯ä¸åŒ…å«å˜é‡å€¼çš„ï¼‰ï¼š  
![](../_resources/lsbasi_part11_symtab.png)

é‚£ä¹ˆå¦‚ä½•è®©ç¨‹åºè‡ªåŠ¨åˆ›å»ºç¬¦å·è¡¨å‘¢ï¼Ÿå¯ä»¥é€šè¿‡éå†æŠ½è±¡è¯­æ³•æ ‘è®©ä»£ç è‡ªåŠ¨ç®¡ç†ç¬¦å·è¡¨ï¼Œåªä¸è¿‡éœ€è¦é‡æ–°å†™ä¸€å¥—éå†çš„æ–¹æ³•ã€‚  

åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆæ‰©å±•ä¸‹ç¬¦å·è¡¨ç±»`SymbolTable`ï¼Œä¸ç”¨æ¯æ¬¡éƒ½éœ€è¦æ‰‹åŠ¨æ·»åŠ å†…ç½®ç±»å‹äº†ï¼š   
```python
class SymbolTable(object):
    def __init__(self):
        self._symbols = OrderedDict()
        self._init_builtins()

    def _init_builtins(self):
        self.define(BuiltinTypeSymbol('INTEGER'))
        self.define(BuiltinTypeSymbol('REAL'))

    def __str__(self):
        s = 'Symbols: {symbols}'.format(
            symbols=[value for value in self._symbols.values()]
        )
        return s

    __repr__ = __str__

    def define(self, symbol):
        print('Define: %s' % symbol)
        self._symbols[symbol.name] = symbol

    def lookup(self, name):
        print('Lookup: %s' % name)
        symbol = self._symbols.get(name)
        # 'symbol' is either an instance of the Symbol class or 'None'
        return symbol
```

ç„¶ååˆ›å»º`SymbolTableBuilder` ç±»ï¼Œåœ¨éå†AST çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºç¬¦å·è¡¨ï¼š  
```python
class SymbolTableBuilder(NodeVisitor):
    def __init__(self):
        self.symtab = SymbolTable()

    def visit_Block(self, node):
        for declaration in node.declarations:
            self.visit(declaration)
        self.visit(node.compound_statement)

    def visit_Program(self, node):
        self.visit(node.block)

    def visit_BinOp(self, node):
        self.visit(node.left)
        self.visit(node.right)

    def visit_Num(self, node):
        pass

    def visit_UnaryOp(self, node):
        self.visit(node.expr)

    def visit_Compound(self, node):
        for child in node.children:
            self.visit(child)

    def visit_NoOp(self, node):
        pass

    def visit_VarDecl(self, node):
        type_name = node.type_node.value
        type_symbol = self.symtab.lookup(type_name)
        var_name = node.var_node.value
        var_symbol = VarSymbol(var_name, type_symbol)
        self.symtab.define(var_symbol)
```

`SymbolTableBuilder` ç±»ä¸­çš„å¾ˆå¤šæ–¹æ³•åä¸è§£é‡Šå™¨ç±»`Interpreter` ä¸­çš„ç›¸åŒï¼Œæ¯•ç«ŸäºŒè€…éƒ½ä¼šéå†ASTã€‚ä½†æ˜¯`visit_VarDecl` å£°æ˜å˜é‡çš„èŠ‚ç‚¹éœ€è¦å•ç‹¬è¯´æ˜ï¼š  
```python
def visit_VarDecl(self, node):
    type_name = node.type_node.value
    type_symbol = self.symtab.lookup(type_name)
    var_name = node.var_node.value
    var_symbol = VarSymbol(var_name, type_symbol)
    self.symtab.define(var_symbol)
```  

è¯¥æ–¹æ³•è´Ÿè´£å£°æ˜å˜é‡ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ç¬¦å·è¡¨ä¸­ï¼Œä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œè¯¥æ–¹æ³•éœ€è¦å…ˆä»ç¬¦å·è¡¨ä¸­æŸ¥æ‰¾ç±»å‹ç¬¦å·æ˜¯å¦å·²å®šä¹‰ï¼ˆå¦‚æœæ²¡æœ‰å®šä¹‰çš„è¯ç†è®ºä¸Šåº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚é€šè¿‡ä»£ç çœ‹ä¸€ä¸‹å…¶å·¥ä½œè¿‡ç¨‹ï¼š  
```shell-session
$ python
>>> from spi import Lexer, Parser, SymbolTableBuilder
>>> text = """
... PROGRAM Part11;
... VAR
...    x : INTEGER;
...    y : REAL;
...
... BEGIN
...
... END.
... """
>>> lexer = Lexer(text)
>>> parser = Parser(lexer)
>>> tree = parser.parse()
>>> symtab_builder = SymbolTableBuilder()
Define: INTEGER
Define: REAL
>>> symtab_builder.visit(tree)
Lookup: INTEGER
Define: <x:INTEGER>
Lookup: REAL
Define: <y:REAL>
>>> # Letâ€™s examine the contents of our symbol table
â€¦
>>> symtab_builder.symtab
Symbols: [INTEGER, REAL, <x:INTEGER>, <y:REAL>]
```  

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»£ç è¾“å‡ºäº†ä¸€äº›`Define: ...` å’Œ`Lookup: ...` çš„åºåˆ—ã€‚è¿™äº›å°±æ˜¯æ„é€ ç¬¦å·è¡¨çš„é¡ºåºã€‚æœ€åç¨‹åºè¾“å‡ºäº†ç¬¦å·è¡¨çš„å†…å®¹ã€‚ä»¥ä¸Šå·¥ä½œéƒ½æ˜¯ç”±`SymbolTableBuilder` çš„æ–¹æ³•è‡ªåŠ¨å®Œæˆçš„ã€‚  

åŒæ ·çš„ï¼Œè¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•`visit_Assign` å’Œ`visit_Var` éœ€è¦å…ˆæŸ¥è¯¢ç¬¦å·è¡¨æ¥ç¡®å®šç¬¦å·æ˜¯å¦å·²å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨åˆ™åº”æŠ›å‡ºå¼‚å¸¸ï¼š  
```python
def visit_Assign(self, node):
    var_name = node.left.value
    var_symbol = self.symtab.lookup(var_name)
    if var_symbol is None:
        raise NameError(repr(var_name))

    self.visit(node.right)

def visit_Var(self, node):
    var_name = node.value
    var_symbol = self.symtab.lookup(var_name)

    if var_symbol is None:
        raise NameError(repr(var_name))
```  

ä¸‹é¢æ˜¯ä¸¤ä¸ªé”™è¯¯ç¨‹åºçš„ç¤ºä¾‹ï¼š  
```Pascal  
PROGRAM NameError1;
VAR
   a : INTEGER;

BEGIN
   a := 2 + b;
END.
```  

å¯ä»¥éªŒè¯ï¼Œé”™è¯¯çš„åœ°æ–¹åœ¨äºæ— æ³•æ‰¾åˆ°å˜é‡`b`ï¼š  
```shell-session
$ python
>>> from spi import Lexer, Parser, SymbolTableBuilder
>>> text = """
... PROGRAM NameError1;
... VAR
...    a : INTEGER;
...
... BEGIN
...    a := 2 + b;
... END.
... """
>>> lexer = Lexer(text)
>>> parser = Parser(lexer)
>>> tree = parser.parse()
>>> symtab_builder = SymbolTableBuilder()
Define: INTEGER
Define: REAL
>>> symtab_builder.visit(tree)
Lookup: INTEGER
Define: <a:INTEGER>
Lookup: a
Lookup: b
Traceback (most recent call last):
  ...
  File "spi.py", line 674, in visit_Var
    raise NameError(repr(var_name))
NameError: 'b'
```

ä¸å‡ºæ„å¤–ï¼Œå‘ç”Ÿäº†å¼‚å¸¸ï¼æ¥çœ‹ä¸‹ä¸€ä¸ªï¼Œæˆ‘ä»¬åœ¨æœªå®šä¹‰çš„æƒ…å†µä¸‹ä½¿ç”¨äº†å˜é‡`a`ï¼š  
```Pascal
PROGRAM NameError2;
VAR
   b : INTEGER;

BEGIN
   b := 1;
   a := b + 2;
END.
```  
éªŒè¯ï¼š  
```shell-session
>>> from spi import Lexer, Parser, SymbolTableBuilder
>>> text = """
... PROGRAM NameError2;
... VAR
...    b : INTEGER;
...
... BEGIN
...    b := 1;
...    a := b + 2;
... END.
... """
>>> lexer = Lexer(text)
>>> parser = Parser(lexer)
>>> tree = parser.parse()
>>> symtab_builder = SymbolTableBuilder()
Define: INTEGER
Define: REAL
>>> symtab_builder.visit(tree)
Lookup: INTEGER
Define: <b:INTEGER>
Lookup: b
Lookup: a
Traceback (most recent call last):
  ...
  File "spi.py", line 665, in visit_Assign
    raise NameError(repr(var_name))
NameError: 'a'
```  

éœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼šæˆ‘ä»¬æ„é€ ç¬¦å·è¡¨æ˜¯åœ¨ç¨‹åºè¿è¡Œä¹‹å‰æ‰§è¡Œçš„ã€‚å¦‚æœè¦æ‰§è¡Œä¸‹é¢çš„ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ï¼š  
```Pascal
PROGRAM Part11;
VAR
   x : INTEGER;
BEGIN
   x := 2;
END.
```

ç¬¦å·è¡¨å’Œè¿è¡Œæ—¶`run-time` çš„å…¨å±€å†…å­˜`GLOBAL_MEMORY` çš„å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![](../_resources/lsbasi_part11_symtab_vs_globmem.png)  

å‘ç°åŒºåˆ«äº†å§ã€‚ç¬¦å·è¡¨å¹¶ä¸å­˜å‚¨å˜é‡çš„å€¼ï¼Œå› ä¸ºè¿™æ˜¯è§£é‡Šå™¨çš„å·¥ä½œã€‚è®°å¾—æˆ‘ä»¬ç¬¬09 ç« é‡Œé¢çš„é»‘ç§‘æŠ€å—ï¼Ÿ  
![](../_resources/lsbasi_part9_ast_st02.png)  
æˆ‘ä»¬å†ä¹Ÿä¸éœ€è¦è®©ç¬¦å·è¡¨å»ç®¡ç†å˜é‡çš„å†…å­˜äº†ã€‚ï¼ˆè¿™æ ·åªè¦ç¨‹åºé€šè¿‡è¯­ä¹‰æ£€æŸ¥ä¸æŠ¥é”™ï¼Œè§£é‡Šå™¨å°±å¯ä»¥å®‰å¿ƒçš„è¿è¡Œäº†ã€‚ï¼‰  

ç»¼åˆä»¥ä¸Šå‡ ç‚¹ï¼Œçœ‹ä¸€ä¸‹æˆ‘ä»¬æ–°çš„è§£é‡Šå™¨èƒ½å¦æ­£å¸¸å·¥ä½œå§ï¼š  
```Pascal
PROGRAM Part11;
VAR
   number : INTEGER;
   a, b   : INTEGER;
   y      : REAL;

BEGIN {Part11}
   number := 2;
   a := number ;
   b := 10 * a + 10 * number DIV 4;
   y := 20 / 7 + 3.14
END.  {Part11}
```  

å°†ä¸Šé¢ä»£ç ä¿å­˜ä¸º`part11.pas` å¹¶å¯åŠ¨è§£é‡Šå™¨`spi.py`ï¼š  
```shell-session
$ python spi.py part11.pas
Define: INTEGER
Define: REAL
Lookup: INTEGER
Define: <number:INTEGER>
Lookup: INTEGER
Define: <a:INTEGER>
Lookup: INTEGER
Define: <b:INTEGER>
Lookup: REAL
Define: <y:REAL>
Lookup: number
Lookup: a
Lookup: number
Lookup: b
Lookup: a
Lookup: number
Lookup: y

Symbol Table contents:
Symbols: [INTEGER, REAL, <number:INTEGER>, <a:INTEGER>, <b:INTEGER>, <y:REAL>]

Run-time GLOBAL_MEMORY contents:
a = 2
b = 25
number = 2
y = 5.99714285714
```  

å†æ¬¡å¼ºè°ƒï¼šè§£é‡Šå™¨ä¸å‚ä¸ç¬¦å·è¡¨çš„æ„å»ºå·¥ä½œï¼Œä½†æ˜¯ä¾èµ–`SymbolTableBuilder` æ¥ç¡®ä¿ä»£ç ä¸­çš„ä»»ä½•å˜é‡éƒ½åœ¨ä½¿ç”¨ä¹‹å‰è¢«æ­£ç¡®åœ°å£°æ˜ã€‚  

**æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å­¦ä¼šäº†å§**  
- ä»€ä¹ˆæ˜¯ç¬¦å·  
- æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ç¬¦å·  
- ä»€ä¹ˆæ˜¯ç¬¦å·è¡¨  
- å®šä¹‰å’ŒæŸ¥æ‰¾ç¬¦å·æœ‰ä»€ä¹ˆä¸åŒ  
- ç»™å®šä¸‹é¢ç¨‹åºï¼Œæœ€ç»ˆè§£é‡Šå™¨çš„ç¬¦å·è¡¨å’Œå…¨å±€å†…å­˜çš„å†…å®¹ä¼šæ˜¯ä»€ä¹ˆ
    ```pascal
    PROGRAM Part11;
    VAR
        x, y : INTEGER;
    BEGIN
        x := 2;
        y := 3 + x;
    END.
    ```

ä»¥ä¸Šå°±æ˜¯ä»Šå¤©çš„å…¨éƒ¨å†…å®¹ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†ä¼šè®¨è®ºä½œç”¨åŸŸçš„å†…å®¹ï¼Œå¹¶ç€æ‰‹å¤„ç†åµŒå¥—è¿‡ç¨‹çš„é—®é¢˜ã€‚ç»§ç»­åŠ æ²¹ï¼Œå†è§ï¼  
![](../_resources/lsbasi_part11_keep_going.png)  


**P.S.:**å…³äºç¬¦å·å’Œç¬¦å·è¡¨çš„è§£é‡Šï¼Œæˆ‘ä¸»è¦å‚è€ƒäº†[Language Implementation Patterns - by Terence Parr](http://amzn.to/2cHsHT1) è¿™æœ¬ä¹¦ã€‚è¿™æ˜¯æˆ‘è§è¿‡æœ€æœ‰æ¡ç†çš„è¯´æ˜ï¼Œå¹¶ä¸”ä¹¦ä¸­ä¹Ÿæ¶µç›–äº†æˆ‘ä»¬ä¸ä¼šæ¶‰åŠçš„ç±»çš„ä½œç”¨åŸŸçš„å†…å®¹ã€‚  

**P.P.S.:**å¦‚æœä½ è¿«ä¸åŠå¾…åœ°æƒ³ç»§ç»­ç ”ç©¶ç¼–è¯‘å™¨ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ å»é˜…è¯»ä¸€ä¸‹Jack Crenshaw çš„ç»å…¸ç³»åˆ—[Letâ€™s Build a Compiler](http://compilers.iecc.com/crenshaw/)ã€‚  


-----  
2022-06-20 00:27