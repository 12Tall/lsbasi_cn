08_å•ç›®è¿ç®—ç¬¦

ğŸ“… 2016-01-08  

> ä»Šå¤©çš„å†…å®¹æ¯”è¾ƒç®€å•ï¼Œä½†éœ€è¦ä¸Šä¸€ç« çš„å†…å®¹åšé“ºå«  

ä»Šå¤©æˆ‘ä»¬å°†ä¼šè®¨è®ºå•ç›®è¿ç®—ç¬¦ï¼šæ­£å·å’Œè´Ÿå·ã€‚æˆ‘ä»¬ä»Šå¤©å†…å®¹å¤§éƒ¨åˆ†åŸºäºç¬¬7ç« ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³é‡æ–°å¤ä¹ ä¸€ä¸‹ï¼Œå°±åªéœ€è¦ç¿»åˆ°ç¬¬7ç« ï¼Œç„¶åå†é‡æ–°è¿‡ä¸€éå°±å¯ä»¥äº†ã€‚æ°¸è¿œè¦è®°ä½é‡å¤æ˜¯å­¦ä¹ å­—æ¯ã€‚  

å‰é¢æåˆ°è¿‡ï¼Œç„¶åä»Šå¤©æˆ‘ä»¬å°†è¦å­¦ä¹ çš„å†…å®¹å¦‚ä¸‹ï¼š  
1. æ‰©å±•æˆ‘ä»¬çš„è¯­æ³•ï¼Œä½¿å…¶æ”¯æŒå•ç›®è¿ç®—ï¼Œä¹Ÿå°±æ˜¯æ­£å·å’Œè´Ÿå·ï¼›  
2. å¢åŠ ä¸€ä¸ªæ–°çš„å•ç›®è¿ç®—ç¬¦ASTèŠ‚ç‚¹ï¼›  
3. æ‰©å±•æˆ‘ä»¬çš„è¯­æ³•åˆ†æå™¨ï¼Œæ”¯æŒç”Ÿæˆå¸¦æœ‰å•ç›®è¿ç®—ç¬¦çš„ASTï¼›
4. æ‰©å±•æˆ‘ä»¬çš„è§£é‡Šå™¨ï¼Œç„¶åæ–°å¢ä¸€ä¸ª`visit_UnaryOp`æ–¹æ³•æ¥è§£é‡Šå•ç›®è¿ç®—ç¬¦ã€‚

æ­¥å…¥æ­£é¢˜ï¼Œç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªä¸åŒç›®è¿ç®—ç¬¦æ‰“äº¤é“ã€‚é¡¾åæ€ä¹‰ï¼ŒåŒç›®è¿ç®—ç¬¦å°±æ˜¯å…·æœ‰ä¸¤ä¸ªæ“ä½œæ•°çš„è¿ç®—ç¬¦ã€‚ é‚£ä»€ä¹ˆæ˜¯å•ç›®è¿ç®—ç¬¦ï¼Ÿå•ç›®è¿ç®—ç¬¦æ˜¯åªæœ‰ä¸€ä¸ªæ“ä½œæ•°çš„è¿ç®—ç¬¦ã€‚  
ä¸‹é¢å°±æ˜¯å•ç›®æ­£å’Œå•ç›®è´Ÿçš„è¯­æ³•è§„åˆ™ï¼š  
- `-`å°†å¯¹å…¶æ“ä½œæ•°å–è´Ÿå€¼ï¼›  
- `+`ä¸æ”¹å˜æ“ä½œæ•°ç¬¦å·ï¼›  
- å•ç›®è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§è¦é«˜äºåŠ å‡ä¹˜é™¤ç­‰åŒç›®è¿ç®—ï¼Œå³ä½¿ç¬¦å·çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ã€‚  

åœ¨è¡¨è¾¾å¼`+-3`ä¸­ï¼Œç¬¬ä¸€ä¸ª`+`å°±è¡¨ç¤ºå•ç›®è¿ç®—ç¬¦æ­£ï¼Œ`-`è¡¨ç¤ºè´Ÿã€‚`+-3`ç­‰åŒäº`+(-(3))`ï¼Œä¹Ÿç­‰äº`-3`ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬æ­£å€¾å‘äºå°†å…¶ç†è§£ä¸ºï¼šå•ç›®è´Ÿå’Œæ­£æ•´æ•°ä¸‰ï¼Œè€Œä¸æ˜¯è´Ÿä¸‰ä½œä¸ºä¸€ä¸ªæ•´ä½“ã€‚  
![lsbasi_part8_exp1.png](../_resources/lsbasi_part8_exp1.png)

è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸ªè¡¨è¾¾å¼çš„ä¾‹å­ï¼Œ`5--2`ï¼š  
![lsbasi_part8_exp2.png](../_resources/lsbasi_part8_exp2.png)  

åœ¨è¡¨è¾¾å¼ä¸­ç¬¬ä¸€ä¸ª`-`è¡¨ç¤ºåŒç›®è¿ç®—å‡ï¼Œç„¶åç¬¬äºŒä¸ª`-`è¡¨ç¤ºå•ç›®è¿ç®—ç¬¦è´Ÿã€‚æ¥çœ‹æ›´å¤šçš„ä¾‹å­ï¼š  
![lsbasi_part8_exp3.png](../_resources/lsbasi_part8_exp3.png)    
![lsbasi_part8_exp4.png](../_resources/lsbasi_part8_exp4.png)  

ç°åœ¨æˆ‘ä»¬å°†ä¼šæ›´æ–°ä¸€ä¸‹æˆ‘ä»¬çš„è¯­æ³•ï¼Œä½¿å…¶æ”¯æŒæ­£è´Ÿè¿ç®—ç¬¦ã€‚æˆ‘ä»¬å°†ä¼šä¿®æ”¹`factor`è§„åˆ™ï¼Œå› ä¸ºå•ç›®è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§è¦æ¯”åŒç›®è¿ç®—ç¬¦æ›´é«˜ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨`factor`è§„åˆ™ä¸ŠåŠ¨æ‰‹ã€‚  

è¿™æ˜¯æˆ‘ä»¬ä¹‹å‰çš„`factor`è§„åˆ™ï¼š    
![lsbasi_part8_factor_before.png](../_resources/lsbasi_part8_factor_before.png)  

ä¸‹é¢æ˜¯æˆ‘ä»¬ä¿®æ”¹åçš„`factor`è§„åˆ™ï¼š  
![lsbasi_part8_factor_after.png](../_resources/lsbasi_part8_factor_after.png) 

å¦‚ä½ æ‰€è§æˆ‘æ‰©å±•äº†`factor`è§„åˆ™ï¼Œä½¿å…¶å¯ä»¥å¼•ç”¨è‡ªèº«ï¼Œè¿™æ ·çš„è¯å®ƒå°±å…è®¸æˆ‘ä»¬å»æ´¾ç”Ÿæ›´å¤æ‚çš„è¡¨è¾¾å¼ï¼šåƒ`- - - + - 3`è¿™æ ·ï¼Œè™½ç„¶æœ‰å¾ˆå¤šå•ç›®è¿ç®—ç¬¦ï¼Œä½†ä»æ˜¯ä¸€ä¸ªåˆæ³•çš„è¡¨è¾¾å¼ã€‚  
ä¸‹é¢å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯­æ³•å›¾ï¼š  
![lsbasi_part8_grammar.png](../_resources/lsbasi_part8_grammar.png) 

ä¸‹ä¸€æ­¥å¢åŠ ä¸€ä¸ªASTèŠ‚ç‚¹ç±»ï¼Œæ¥è¡¨ç¤ºå•ç›®è¿ç®—ç¬¦ï¼š  
```python
class UnaryOp(AST):
    def __init__(self, op, expr):
        self.token = self.op = op
        self.expr = expr
```

æ„é€ å‡½æ•°çš„è¯åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯`op`ä»£è¡¨å•ç›®è¿ç®—ç¬¦çš„`token`ï¼›ç¬¬äºŒä¸ªæ˜¯`expr`è¡¨è¾¾å¼ï¼Œä»£è¡¨ç€ä¸€ä¸ªASTèŠ‚ç‚¹ã€‚  
æˆ‘ä»¬æ›´æ–°äº†è¯­æ³•ä¸­çš„`factor`è§„åˆ™ï¼Œç›¸åº”åœ°æˆ‘ä»¬éœ€è¦ä¿®æ”¹è¯­æ³•åˆ†æä¸­çš„`factor`çš„æ–¹æ³•ï¼šåœ¨`factor`ä¸­æ·»åŠ å¤„ç†`Â±factor`çš„å­è§„åˆ™ã€‚  
```python
def factor(self):
    """factor : (PLUS | MINUS) factor | INTEGER | LPAREN expr RPAREN"""
    token = self.current_token
    if token.type == PLUS:
        self.eat(PLUS)
        node = UnaryOp(token, self.factor())
        return node
    elif token.type == MINUS:
        self.eat(MINUS)
        node = UnaryOp(token, self.factor())
        return node
    elif token.type == INTEGER:
        self.eat(INTEGER)
        return Num(token)
    elif token.type == LPAREN:
        self.eat(LPAREN)
        node = self.expr()
        self.eat(RPAREN)
        return node
```

æœ€åæˆ‘ä»¬éœ€è¦æ‰©å±•æˆ‘ä»¬çš„è§£é‡Šå™¨ï¼Œæ·»åŠ `visit_UnaryOp`æ–¹æ³•ï¼Œä»¥è§£é‡Šå•ç›®è¿ç®—ï¼š  
```python
def visit_UnaryOp(self, node):
    op = node.op.type
    if op == PLUS:
        return +self.visit(node.expr)
    elif op == MINUS:
        return -self.visit(node.expr)
```

æˆ‘ä»¬å…ˆæ‰‹å·¥æ„é€ ä¸€ä¸ª`5---2`çš„ASTï¼Œå¹¶ä¼ å…¥æˆ‘ä»¬çš„è§£é‡Šå™¨ï¼Œæ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„æ–°æ–¹æ³•æ˜¯ä¸æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œï¼š  
```bash
>>> from spi import BinOp, UnaryOp, Num, MINUS, INTEGER, Token
>>> five_tok = Token(INTEGER, 5)
>>> two_tok = Token(INTEGER, 2)
>>> minus_tok = Token(MINUS, '-')
>>> expr_node = BinOp(
...     Num(five_tok),
...     minus_tok,
...     UnaryOp(minus_token, UnaryOp(minus_token, Num(two_tok)))
... )
>>> from spi import Interpreter
>>> inter = Interpreter(None)
>>> inter.visit(expr_node)
3
```  
ç»“æœåº”å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![lsbasi_part8_ast.png](../_resources/lsbasi_part8_ast.png) 

ä»[Github](https://github.com/rspivak/lsbasi/blob/master/part8/python/spi.py)ä¸‹è½½å®Œæ•´ä»£ç ï¼Œç„¶åå°è¯•è¿è¡Œ,çœ‹ä¸€ä¸‹æˆ‘ä»¬æ›´æ–°åçš„è§£é‡Šå™¨èƒ½ä¸èƒ½æ­£ç¡®çš„è®¡ç®—åŒ…å«å•ç›®è¿ç®—çš„è¡¨è¾¾å¼ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š  
```bash
$ python spi.py
spi> - 3
-3
spi> + 3
3
spi> 5 - - - + - 3
8
spi> 5 - - - + - (3 + 4) - +2
10
```

æˆ‘è¿˜æ›´æ–°äº†ç”Ÿæˆä¸­ASTçš„[å·¥å…·](https://github.com/rspivak/lsbasi/blob/master/part8/python/genastdot.py)ï¼Œç°åœ¨å¯ä»¥æ”¯æŒå•ç›®è¿ç®—ç¬¦ï¼Œä¸‹é¢å°±æ˜¯ä¸€äº›ç®€å•çš„ä¾‹å­ï¼š 
```bash
$ python genastdot.py "- 3" > ast.dot && dot -Tpng -o ast.png ast.dot
``` 
![lsbasi_part8_genastdot_01.png](../_resources/lsbasi_part8_genastdot_01.png)   


```bash
$ python genastdot.py "+ 3" > ast.dot && dot -Tpng -o ast.png ast.dot
``` 
![lsbasi_part8_genastdot_02.png](../_resources/lsbasi_part8_genastdot_02.png) 


```bash
$ python genastdot.py "5---+-3" > ast.dot && dot -Tpng -o ast.png ast.dot
``` 
![lsbasi_part8_genastdot_03.png](../_resources/lsbasi_part8_genastdot_03.png) 


```bash
$ python genastdot.py "5 - - - + - (3 + 4) - +2" > ast.dot && dot -Tpng -o ast.png ast.dot
``` 
![lsbasi_part8_genastdot_04.png](../_resources/lsbasi_part8_genastdot_04.png) 

ä¸‹é¢å°±æ˜¯æ–°çš„è¯¾å¤–ä½œä¸šï¼š  
![lsbasi_part8_exercises.png](../_resources/lsbasi_part8_exercises.png) 

- å®‰è£…ä¸€ä¸ª`Free Pascal`çš„ç¼–è¯‘å™¨ï¼Œç„¶åç¼–è¯‘è¿è¡Œ[testunary.pas](https://github.com/rspivak/lsbasi/blob/master/part8/python/testunary.pas)ï¼Œå»éªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„ç»“æœæ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬ä»£ç äº§ç”Ÿçš„ä»£ç ä¸€æ ·ã€‚  

ä»¥ä¸Šå°±æ˜¯ä»Šå¤©çš„æ‰€æœ‰å†…å®¹ï¼Œä¸‹èŠ‚çš„è¯æˆ‘ä»¬å°†ä¼šä»‹ç»èµ‹å€¼è¡¨è¾¾å¼ï¼Œæ•¬è¯·å…³æ³¨ã€‚


ä»¥ä¸‹ä¹¦ç±å¯èƒ½ä¼šå¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼š  

1. [Language Implementation Patterns: Create Your Own Domain-Specific and General Programming Languages (Pragmatic Programmers)](http://www.amazon.com/gp/product/193435645X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=193435645X&linkCode=as2&tag=russblo0b-20&linkId=MP4DCXDV6DJMEJBL)  
2. [Writing Compilers and Interpreters: A Software Engineering Approach](http://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0470177071&linkCode=as2&tag=russblo0b-20&linkId=UCLGQTPIYSWYKRRM)  
3. [Modern Compiler Implementation in Java](http://www.amazon.com/gp/product/052182060X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=052182060X&linkCode=as2&tag=russblo0b-20&linkId=ZSKKZMV7YWR22NMW)  
4. [Modern Compiler Design](http://www.amazon.com/gp/product/1461446988/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1461446988&linkCode=as2&tag=russblo0b-20&linkId=PAXWJP5WCPZ7RKRD)  
5. [Compilers: Principles, Techniques, and Tools (2nd Edition)](http://www.amazon.com/gp/product/0321486811/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0321486811&linkCode=as2&tag=russblo0b-20&linkId=GOEGDQG4HIHU56FQ)   

-----  
2021-01-10 11:21