14_åµŒå¥—çš„ä½œç”¨åŸŸä¸æºåˆ°æºçš„ç¼–è¯‘å™¨     

ğŸ“… 2017-05-08  

> åªæœ‰æ­»é±¼æ‰ä¼šéšæ³¢é€æµã€‚  

æ­£å¦‚ä¸Šæ¬¡æ‰€è¯´ï¼Œä»Šå¤©æˆ‘ä»¬å°†æ·±å…¥è®¨è®ºä½œç”¨åŸŸï¼ˆscopeï¼‰çš„è¯é¢˜ï¼š  
![](../_resources/lsbasi_part14_img01.png)  

ä»¥ä¸‹æ˜¯æˆ‘ä»¬ä»Šå¤©å°†ä¼šå­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼š  
- å­¦ä¹ ä½œç”¨åŸŸã€‚ä½œç”¨åŸŸä¸ºä»€ä¹ˆæœ‰ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨ä»£ç ä¸­é€šè¿‡ç¬¦å·è¡¨å®ç°ä½œç”¨åŸŸï¼›  
- å­¦ä¹ åµŒå¥—çš„ä½œç”¨åŸŸã€‚å¦‚ä½•é€šè¿‡é“¾å¼ä½œç”¨åŸŸç¬¦å·è¡¨å®ç°åµŒå¥—çš„ä½œç”¨åŸŸï¼›  
- å­¦ä¹ å¦‚ä½•è§£æå¸¦å½¢å‚çš„è¿‡ç¨‹å£°æ˜ï¼Œå¦‚ä½•ç”¨ä»£ç ä¸­è¡¨ç¤ºè¿‡ç¨‹çš„ç¬¦å·ï¼›  
- å­¦ä¹ é€šè¿‡æ‰©å±•è¯­ä¹‰åˆ†æå™¨å¯¹åµŒå¥—çš„ä½œç”¨åŸŸåšè¯­ä¹‰æ£€æŸ¥ï¼›  
- å­¦ä¹ æ›´å¤šçš„ç¬¦å·åè§£æï¼Œä»¥åŠåœ¨åµŒå¥—çš„ä½œç”¨åŸŸä¸­è¯­ä¹‰åˆ†æå™¨æ˜¯å¦‚ä½•è§£æç¬¦å·çš„å£°æ˜çš„ï¼›  
- å­¦ä¹ æ„å»ºä½œç”¨åŸŸæ ‘ï¼›  
- å­¦ä¹ ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„æºåˆ°æºï¼ˆsource-to-source, S2Sï¼‰ç¼–è¯‘å™¨ï¼Œç¨åä¼šçœ‹åˆ°å®ƒè·Ÿæˆ‘ä»¬ä½œç”¨åŸŸè¯é¢˜ä¹‹é—´çš„å…³ç³»ã€‚  

æ‰€ä»¥ï¼Œç°åœ¨ï¼Œå¼€å§‹ï¼ˆä¸‹æ½œï¼‰ï¼  

> ## ç›®å½•  
> - [ä½œç”¨åŸŸä¸ä½œç”¨åŸŸç¬¦å·è¡¨](#ä½œç”¨åŸŸä¸ä½œç”¨åŸŸç¬¦å·è¡¨)  
> - [å¸¦æœ‰å½¢å‚çš„è¿‡ç¨‹å£°æ˜](#å¸¦æœ‰å½¢å‚çš„è¿‡ç¨‹å£°æ˜)  
> - [è¿‡ç¨‹çš„ç¬¦å·](#è¿‡ç¨‹çš„ç¬¦å·)  
> - [åµŒå¥—çš„ä½œç”¨åŸŸ](#åµŒå¥—çš„ä½œç”¨åŸŸ)  
> - [ä½œç”¨åŸŸæ ‘ï¼šé“¾å¼çš„ä½œç”¨åŸŸç¬¦å·è¡¨](#ä½œç”¨åŸŸæ ‘é“¾å¼çš„ä½œç”¨åŸŸç¬¦å·è¡¨) 
> - [åµŒå¥—çš„ä½œç”¨åŸŸä¸ç¬¦å·åè§£æ](#åµŒå¥—çš„ä½œç”¨åŸŸä¸ç¬¦å·åè§£æ)  
> - [æºåˆ°æºçš„ç¼–è¯‘å™¨](#æºåˆ°æºçš„ç¼–è¯‘å™¨)  
> - [æ€»ç»“](#æ€»ç»“)  
> - [ç»ƒä¹ ](#ç»ƒä¹ )

## ä½œç”¨åŸŸä¸ä½œç”¨åŸŸç¬¦å·è¡¨  
ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸï¼Ÿä½œç”¨åŸŸæ˜¯ä¸€æ®µæ–‡æœ¬åŒºåŸŸï¼Œå…¶ä¸­å¯ä»¥ä½¿ç”¨æŸä¸ªç¬¦å·åï¼Œä»¥ä¸‹é¢ç¨‹åºä»£ç ä¸ºä¾‹ï¼š  
```pascal
program Main;
   var x, y: integer;
begin
   x := x + y;
end.
```

åœ¨Pascal è¯­è¨€ä¸­ï¼Œ`PROGRAM` å…³é”®å­—ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰ä¼šå¼•å…¥ä¸€ä¸ªå…¨å±€ä½œç”¨åŸŸ`global`ï¼Œæ‰€ä»¥ä¸Šé¢çš„ç¨‹åºä¸­æœ‰ä¸€ä¸ªglobal ä½œç”¨åŸŸï¼Œä½œç”¨åŸŸä¸­å£°æ˜äº†å˜é‡x å’Œå˜é‡yã€‚è¿™ä¸¤ä¸ªå˜é‡åœ¨æ•´ä¸ªç¨‹åºä¸­éƒ½å¯ä»¥è®¿é—®ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä»`program` å…³é”®å­—å¼€å§‹ï¼Œåˆ°`end.` ç»“æŸçš„æ–‡æœ¬åŒºåŸŸä¸­ï¼Œå˜é‡x å’Œå˜é‡y éƒ½èƒ½è¢«åˆæ³•ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå˜é‡ï¼ˆå£°æ˜ï¼‰çš„ä½œç”¨åŸŸå°±æ˜¯æ•´ä¸ªç¨‹åºï¼š  
![](../_resources/lsbasi_part14_img02.png)  

å½“ä½ çœ‹ä¸Šé¢æºç ï¼Œå°¤å…¶æ˜¯èµ‹å€¼è¡¨è¾¾å¼`x := x+y` æ—¶ï¼Œèƒ½å¤Ÿç›´è§‚åœ°æ„è¯†åˆ°ä»£ç èƒ½å¤Ÿé¡ºåˆ©é€šè¿‡ç¼–è¯‘ã€‚å› ä¸ºè¡¨è¾¾å¼åœ¨å…¨å±€ä½œç”¨åŸŸä¸­ï¼Œå˜é‡xã€y éƒ½èƒ½æ‰¾åˆ°è‡ªå·±çš„å£°æ˜ã€‚è¿™åœ¨ä¸»æµçš„ç¼–ç¨‹è¯­è¨€ä¸­å¾ˆå¸¸è§ã€‚  
åœ¨æˆ‘ä»¬è®¨è®ºå˜é‡çš„ä½œç”¨åŸŸæ—¶ï¼Œæ€»æ˜¯åœ¨è®¨è®ºå…¶å£°æ˜è¯­å¥çš„ä½œç”¨èŒƒå›´ï¼š  
![](../_resources/lsbasi_part14_img03.png)  

ä¸Šå›¾ä¸­çš„ç«–çº¿ä»£è¡¨äº†å˜é‡çš„ä½œç”¨åŸŸï¼Œå˜é‡xã€y å¯ä»¥è¢«åˆæ³•ä½¿ç”¨çš„æ–‡æœ¬åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªç¨‹åºã€‚  

Pascal ç¨‹åºå±äºè¯æ³•ä½œç”¨åŸŸï¼ˆä¹Ÿå«é™æ€ä½œç”¨åŸŸï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä»…å‡­æºç ï¼Œè€Œä¸éœ€è¦å®é™…æ‰§è¡Œç¨‹åºå°±èƒ½ç¡®å®šå£°æ˜çš„ç¬¦å·çš„ä½œç”¨åŒºåŸŸã€‚åœ¨Pascal ä¸­ï¼Œè¯¸å¦‚`program` å’Œ`end` å…³é”®å­—ä¸€èˆ¬ç”¨æ¥ç¡®å®šä½œç”¨åŸŸçš„è¾¹ç•Œï¼š  
![](../_resources/lsbasi_part14_img04.png)  

ä¸ºä»€ä¹ˆä½œç”¨åŸŸä¼šæœ‰ç”¨å‘¢ï¼Ÿ  
- æ¯ä¸ªä½œç”¨åŸŸéƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œå†…éƒ¨å£°æ˜çš„å˜é‡æ— æ³•ä»å¤–éƒ¨è®¿é—®åˆ°ï¼›  
- åœ¨ä¸åŒçš„ä½œç”¨åŸŸä¸­ï¼Œå¯ä»¥é‡ç”¨ç¬¦å·åï¼›  
- åœ¨åµŒå¥—çš„ä½œç”¨åŸŸä¸­å¯ä»¥é‡æ–°å£°æ˜ç¬¦å·ï¼Œè¿™æ ·ä¼šé®è”½æ‰å¤–éƒ¨ä½œç”¨åŸŸçš„ç¬¦å·å£°æ˜ã€‚è®©æˆ‘ä»¬æœ‰æ•ˆåœ°æ§åˆ¶å¯¹æ¥è‡ªä¸åŒä½œç”¨åŸŸçš„å˜é‡çš„è®¿é—®ã€‚  

é™¤äº†å…¨å±€ä½œç”¨åŸŸglobal ä¹‹å¤–ï¼ŒPascal è¿˜æ”¯æŒåµŒå¥—çš„è¿‡ç¨‹å£°æ˜ï¼Œæ¯ä¸ªè¿‡ç¨‹éƒ½ä¼šå¼•å…¥ä¸€ä¸ªä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯è¯´Pascal æ”¯æŒåµŒå¥—çš„ä½œç”¨åŸŸã€‚  

å½“æˆ‘ä»¬è®¨è®ºä½œç”¨åŸŸæ—¶ï¼Œè®¨è®ºä½œç”¨äºçš„åµŒå¥—æ·±åº¦è¦æ¯”å±•ç¤ºå®ƒä»¬çš„åµŒå¥—å…³ç³»æ›´æ–¹ä¾¿ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ä½œç”¨åŸŸçš„åå­—å’ŒåµŒå¥—æ·±åº¦æ¥è®¨è®ºåµŒå¥—çš„ä½œç”¨åŸŸã€‚  

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„ç¤ºä¾‹ç¨‹åºï¼Œä¸ºäº†æ¸…æ™°èµ·è§ï¼Œæ¯ä¸ªç¬¦å·éƒ½è¢«æ‰“äº†ä¸‹æ ‡ï¼š  
1. ä¸‹æ ‡è¡¨ç¤ºç¬¦å·è¢«å£°æ˜çš„ä½œç”¨åŸŸçš„åµŒå¥—æ·±åº¦ï¼›  
2. å˜é‡çš„å¼•ç”¨æŒ‡å‘å“ªä¸ªå£°æ˜ã€åœ¨å“ªä¸ªåµŒå¥—æ·±åº¦ã€‚  

![](../_resources/lsbasi_part14_img05.png)

ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š  
- é€šè¿‡PROGRAM å…³é”®å­—ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªå…¨å±€ä½œç”¨åŸŸglobalï¼›  
- å…¨å±€ä½œç”¨åŸŸglobal çš„åµŒå¥—æ·±åº¦æ˜¯1ï¼›  
- å˜é‡xã€y å£°æ˜åœ¨lv1ï¼Œä¹Ÿå°±æ˜¯global ä½œç”¨åŸŸä¸­ï¼›  
- å†…ç½®çš„æ•´æ•°ç±»å‹ä¹Ÿåœ¨lv1 è¢«å£°æ˜ï¼›  
- ç¨‹åºåMain çš„ä¸‹æ ‡æ˜¯0ã€‚ä½ ä¹Ÿè®¸ä¼šå¥½å¥‡ä¸ºå•¥æ˜¯0ï¼Ÿåªæ˜¯ä¸ºäº†æ˜ç¡®ä¸€ä¸ªæ¦‚å¿µï¼šç¨‹åºåä¸åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œè€Œæ˜¯åœ¨æ¯”å…¨å±€ä½œç”¨åŸŸæ›´å¤–å±‚ï¼›  
- é€šè¿‡ç«–çº¿å¯ä»¥çœ‹åˆ°ï¼Œå˜é‡xã€y çš„ä½œç”¨åŸŸæ˜¯æ•´ä¸ªç¨‹åºï¼›  
- ä½œç”¨åŸŸä¿¡æ¯è¡¨å±•ç¤ºäº†æ¯ä¸ªä½œç”¨åŸŸçš„åå­—ã€åµŒå¥—æ·±åº¦ä»¥åŠå†…éƒ¨å£°æ˜çš„ç¬¦å·ã€‚è¯¥è¡¨å¯ä»¥ç›´è§‚åœ°å±•ç¤ºç¨‹åºä¸­çš„å„ç§ä½œç”¨åŸŸä¿¡æ¯ã€‚  

å¦‚ä½•åœ¨ä»£ç ä¸­å®ç°è¿™äº›æ¦‚å¿µå‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä½œç”¨åŸŸç¬¦å·è¡¨ï¼ˆscoped symbol tableï¼‰å®ç°ã€‚æˆ‘ä»¬åªéœ€å¯¹æ™®é€šçš„ç¬¦å·è¡¨åšå°‘è®¸æ”¹å˜å°±èƒ½å®ç°ä½œç”¨åŸŸç¬¦å·è¡¨ã€‚  

> ä»ç°åœ¨å¼€å§‹ï¼Œä½œè€…ä½¿ç”¨ä½œç”¨åŸŸï¼ˆscopeï¼‰è¡¨ç¤ºä½œç”¨åŸŸå’Œä½œç”¨åŸŸç¬¦å·è¡¨çš„çš„æ¦‚å¿µã€‚å°½ç®¡åœ¨ä»£ç ä¸­scope è¡¨ç¤ºä¸€ä¸ªä½œç”¨åŸŸç¬¦å·è¡¨ï¼ˆScopedSymbolTableï¼‰çš„å®ä¾‹å¯¹è±¡ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä½œè€…ä»ç„¶ä¼šä½¿ç”¨scope çš„ç®€ç§°ï¼Œè€Œä¸æ˜¯scope symble table å¯¹è±¡ã€‚ä½†æ˜¯åœ¨è¯‘æ–‡ä¸­æˆ‘ä¼šå°½é‡å°†å®ƒä»¬åˆ†å¼€çš„ã€‚  

Okayï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é‡å‘½å`SymbolTable` ç±»ä¸º`ScopedSymbolTable`ï¼Œå¹¶ä¸”æ·»åŠ `scope_level`ã€`scope_name` çš„å±æ€§ï¼Œæ›´æ–°æ„é€ å‡½æ•°ã€`__str__` æ–¹æ³•ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬æ–°ç‰ˆçš„ç¬¦å·è¡¨â€”â€”ä½œç”¨åŸŸç¬¦å·è¡¨çš„æºç ï¼š  
```python
class ScopedSymbolTable(object):
    def __init__(self, scope_name, scope_level):
        """
        æ„é€ å‡½æ•°æ¥æ”¶æ›´å¤šçš„å‚æ•°
        """
        self._symbols = OrderedDict()
        self.scope_name = scope_name
        self.scope_level = scope_level
        self._init_builtins()

    def _init_builtins(self):
        self.insert(BuiltinTypeSymbol('INTEGER'))
        self.insert(BuiltinTypeSymbol('REAL'))

    def __str__(self):
        """
        ç”¨äºæ‰“å°æ›´å¤šçš„ä¿¡æ¯ï¼ŒåŒæ—¶ä½¿è¾“å‡ºæ›´åŠ ç¾è§‚
        """
        h1 = 'SCOPE (SCOPED SYMBOL TABLE)'
        lines = ['\n', h1, '=' * len(h1)]  # æ‹¼æ¥å­—ç¬¦ä¸²çš„é£æ ¼å¥½å¥½ç©ï¼š'=' * len(h1)
        for header_name, header_value in (
            ('Scope name', self.scope_name),
            ('Scope level', self.scope_level),
        ):
            lines.append('%-15s: %s' % (header_name, header_value))
        h2 = 'Scope (Scoped symbol table) contents'
        lines.extend([h2, '-' * len(h2)])
        lines.extend(
            ('%7s: %r' % (key, value))
            for key, value in self._symbols.items()
        )
        lines.append('\n')
        s = '\n'.join(lines)
        return s

    __repr__ = __str__

    def insert(self, symbol):
        print('Insert: %s' % symbol.name)
        self._symbols[symbol.name] = symbol

    def lookup(self, name):
        print('Lookup: %s' % name)
        symbol = self._symbols.get(name)
        # 'symbol' is either an instance of the Symbol class or None
        return symbol
```  

åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°æˆ‘ä»¬çš„è¯­ä¹‰åˆ†æå™¨ï¼Œä½¿ç”¨æ›´æ–°åçš„ScopedSymbolTable ä½œç”¨åŸŸç¬¦å·è¡¨ï¼Œå¹¶ä¸”æš‚æ—¶ç§»é™¤é‡å¤å˜é‡å£°æ˜çš„é”™è¯¯æ£€æŸ¥ä»¥ä¾¿äºè°ƒè¯•ï¼Œåé¢ä¼šå†æ¢å¤çš„ã€‚  

ä¸‹é¢æ˜¯åœ¨è¯­ä¹‰åˆ†æå™¨ä¸­åˆå§‹åŒ–ScopedSymbolTable ä½œç”¨åŸŸç¬¦å·è¡¨çš„éƒ¨åˆ†ä»£ç ï¼š  
```python
class SemanticAnalyzer(NodeVisitor):
    def __init__(self):
        self.scope = ScopedSymbolTable(scope_name='global', scope_level=1)

    ...
```

ä½ å¯ä»¥åœ¨[scope01.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope01.py) ä¸­æ‰¾åˆ°å…¨éƒ¨æºç ï¼Œä¹Ÿå¯ä»¥ä¸‹è½½ååœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œå¹¶æ£€æŸ¥è¾“å‡ºï¼š  
```shell-session
$ python scope01.py
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: x
Lookup: INTEGER
Insert: y
Lookup: x
Lookup: y
Lookup: x


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : global
Scope level    : 1
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>
```

çœ‹èµ·æ¥å¾ˆç†Ÿæ‚‰å¯¹ä¸å¯¹ï¼Ÿç°åœ¨ä½ çŸ¥é“äº†ä½œç”¨åŸŸçš„æ¦‚å¿µï¼Œä»¥åŠæ€ä¹ˆé€šè¿‡ä½œç”¨åŸŸç¬¦å·è¡¨åœ¨ä»£ç ä¸­å®ç°ä½œç”¨åŸŸã€‚ä¸‹é¢æˆ‘ä»¬ä¼šè®¨è®ºåµŒå¥—çš„ä½œç”¨åŸŸï¼Œä»¥åŠå¯¹ä½œç”¨åŸŸç¬¦å·è¡¨æ›´å¤šçš„ä¿®æ”¹å’Œæ‰©å±•ã€‚


## å¸¦æœ‰å½¢å‚çš„è¿‡ç¨‹å£°æ˜  
ä¸‹é¢çš„ç¤ºä¾‹ç¨‹åº[nestedscopes02.pas](https://github.com/rspivak/lsbasi/blob/master/part14/nestedscopes02.pas) åŒ…å«ä¸€ä¸ªè¿‡ç¨‹çš„å£°æ˜ï¼š  
```pascal
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
   begin
      x := a + x + y;
   end;

begin { Main }

end.  { Main }
```  

é¦–å…ˆå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™æ¬¡å£°æ˜çš„è¿‡ç¨‹åŒ…å«ä¸€ä¸ªå‚æ•°ã€‚åœ¨ç»§ç»­è®¨è®ºä½œç”¨åŸŸä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ å¦‚ä½•å¤„ç†/è§£æå¸¦å½¢å‚çš„è¿‡ç¨‹çš„å£°æ˜ã€‚  

> æ³¨ï¼š  
> å½¢å‚Formal Parameter è¡¨ç¤ºè¿‡ç¨‹/å‡½æ•°åœ¨å®šä¹‰æ—¶çš„å‚æ•°  
> å®å‚Argument è¡¨ç¤ºè¿‡ç¨‹/å‡½æ•°åœ¨è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„å˜é‡æˆ–è¡¨è¾¾å¼  

äºæ˜¯æˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬è§£é‡Šå™¨çš„ä»£ç åšå‡ºä¸€äº›æ”¹å˜ï¼š  
1. æ–°å¢`Param` èŠ‚ç‚¹ç±»å‹ï¼š  
    ```python
    class Param(AST):
        def __init__(self, var_node, type_node):
            self.var_node = var_node
            self.type_node = type_node
    ```  
2. æ›´æ–°`ProcedureDecl` ç»“ç‚¹çš„æ„é€ å‡½æ•°ï¼Œä»¥æ¥æ”¶å‚æ•°ï¼š  
    ```python
    class ProcedureDecl(AST):
        def __init__(self, proc_name, params, block_node):
            self.proc_name = proc_name
            self.params = params  # a list of Param nodes
            self.block_node = block_node
    ```  
3. æ›´æ–°è¯­æ³•åˆ†æå™¨ä¸­ç›¸åº”çš„`declarations` è§„åˆ™ï¼Œæ·»åŠ è§£æå‚æ•°çš„éƒ¨åˆ†ï¼š 
    ```python
    def declarations(self):
        """declarations : (VAR (variable_declaration SEMI)+)*
                        | (PROCEDURE ID (LPAREN formal_parameter_list RPAREN)? SEMI block SEMI)*
                        | empty
        """
    ```
4. æ·»åŠ `formal_parameter_list` è§„åˆ™ï¼Œå› ä¸ºå¯èƒ½ä¸æ­¢ä¸€æ¡å½¢å‚å£°æ˜è¯­å¥ï¼š  
    ```python
    def formal_parameter_list(self):
        """ formal_parameter_list : formal_parameters
                                | formal_parameters SEMI formal_parameter_list
        """
    ```
5. æ·»åŠ `formal_parameters` è§„åˆ™ï¼Œå› ä¸ºåŒä¸€ç§ç±»å‹çš„å½¢å‚å¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼š  
    ```python
    def formal_parameters(self):
        """ formal_parameters : ID (COMMA ID)* COLON type_spec """
        param_nodes = []
    ```

é€šè¿‡ä¸Šé¢æ–°å¢çš„èŠ‚ç‚¹å’Œæ–¹æ³•ï¼Œæˆ‘ä»¬çš„è¯­æ³•åˆ†æå™¨å¯ä»¥è§£æä¸‹é¢çš„çš„è¿‡ç¨‹å£°æ˜äº†ã€‚ï¼ˆç®€å•èµ·è§ï¼Œåªå†™äº†è¿‡ç¨‹å¤´ï¼Œè€Œæ²¡å†™è¿‡ç¨‹ä½“ï¼‰  
```pascal
procedure Foo;

procedure Foo(a : INTEGER);

procedure Foo(a, b : INTEGER);

procedure Foo(a, b : INTEGER; c : REAL);
```

å¯ä»¥é€šè¿‡[genastdot.py](https://github.com/rspivak/lsbasi/blob/master/part14/genastdot.py) ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘çš„å¯è§†åŒ–æ•°æ®ç»“æ„å›¾ï¼š  
```shell-session
$ python genastdot.py nestedscopes02.pas > ast.dot && dot -Tpng -o ast.png ast.dot
```  

ç»“æœå¦‚ä¸‹ï¼š  
![](../_resources/lsbasi_part14_img06.png)  

å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨æˆ‘ä»¬çš„ProcedureDecl èŠ‚ç‚¹åŒ…å«ä¸€ä¸ªParam å­èŠ‚ç‚¹ã€‚å¯ä»¥åœ¨[spi.py](https://github.com/rspivak/lsbasi/blob/master/part14/spi.py) ä¸­æ‰¾åˆ°æ‰€æœ‰æ”¹å˜ã€‚å¯ä»¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰ä¹Ÿåšè¿‡ç±»ä¼¼çš„äº‹æƒ…ï¼Œç›¸ä¿¡è‡ªå·±åŠ¨æ‰‹å»å®ç°ä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹ã€‚  

## è¿‡ç¨‹çš„ç¬¦å·  
æ—¢ç„¶æˆ‘ä»¬åœ¨è®¨è®ºè¿‡ç¨‹å£°æ˜ï¼Œé‚£ä¹ˆä¹Ÿæ¥çœ‹ä¸€ä¸‹è¿‡ç¨‹çš„ç¬¦å·å§ã€‚ä¸å˜é‡çš„å£°æ˜ã€å†…ç½®ç±»å‹çš„å£°æ˜ä¸€è‡´ã€‚æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Symbol ç±»ï¼š  
```python
class ProcedureSymbol(Symbol):
    def __init__(self, name, params=None):
        super(ProcedureSymbol, self).__init__(name)
        # a list of formal parameters
        self.params = params if params is not None else []

    def __str__(self):
        return '<{class_name}(name={name}, parameters={params})>'.format(
            class_name=self.__class__.__name__,
            name=self.name,
            params=self.params,
        )

    __repr__ = __str__
```

è¿‡ç¨‹ç¬¦å·çš„ç±»åˆ«æ˜¯procedureï¼Œæ¥æ”¶è¿‡ç¨‹åä½œä¸ºç¬¦å·åï¼Œç±»å‹åŒæ ·æ˜¯Noneã€‚å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç”¨åˆ°type å±æ€§ã€‚è¿‡ç¨‹ç¬¦å·ä¹Ÿå¯ä»¥é™„å¸¦æ›´æ‰€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨ä¸Šé¢ä»£ç ä¸­åŒ…å«æœ‰å½¢å‚çš„ä¿¡æ¯ã€‚ç°åœ¨æˆ‘ä»¬çš„ç¬¦å·å±‚çº§å…³å¿ƒå¦‚ä¸‹ï¼š  
![](../_resources/lsbasi_part14_img07.png)  

## åµŒå¥—çš„ä½œç”¨åŸŸ  
ç°åœ¨æˆ‘ä»¬å›åˆ°åµŒå¥—çš„ä½œç”¨åŸŸçš„è¯é¢˜ä¸Šæ¥ï¼š  
```pascal
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
   begin
      x := a + x + y;
   end;

begin { Main }

end.  { Main }
```  

äº‹æƒ…åˆ°è¿™é‡Œå°±æœ‰æ„æ€èµ·æ¥äº†ã€‚é€šè¿‡å£°æ˜è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªä½œç”¨åŸŸã€‚è¿™ä¸ªä½œç”¨äºè¢«åµŒå¥—åœ¨global ä½œç”¨åŸŸå†…éƒ¨ã€‚è€Œglobal æ˜¯ç”±PROGRAM å…³é”®å­—å¼•å…¥çš„ã€‚  

è¿‡ç¨‹ï¼ˆæ‰€å¼•å…¥çš„ï¼‰ä½œç”¨åŸŸæ˜¯æ•´ä¸ªè¿‡ç¨‹ä½“ï¼Œä»`procedure` å…³é”®å­—å¼€å§‹ï¼Œåˆ°æœ€è¿‘çš„ã€åŒ¹é…çš„`end;` å…³é”®å­—ç»“æŸã€‚å¦‚ä¸‹å›¾æˆ‘ä»¬å¯ä»¥ç»™ç¨‹åºä¸­çš„ç¬¦å·åæ‰“ä¸Šä¸‹æ ‡ï¼š   
![](../_resources/lsbasi_part14_img08.png)  
![](../_resources/lsbasi_part14_img09.png)  

ä»ä¸Šå›¾ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼š  
- è¿™æ®µç¨‹åºæœ‰ä¸¤ä¸ªä½œç”¨åŸŸï¼šlv1 å’Œlv2ï¼›  
- åµŒå¥—å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼šä½œç”¨åŸŸAlpha çš„æ·±åº¦æ˜¯lv2ï¼ŒåµŒå¥—åœ¨æ·±åº¦ä¸ºlv1 çš„global ä½œç”¨åŸŸä¸­ï¼›  
- è¿‡ç¨‹åçš„ä¸‹æ ‡æ¯”å…¶å†…éƒ¨çš„å˜é‡çš„ä¸‹æ ‡å°‘1ã€‚å³Alpha æ‰€åœ¨çš„æ·±åº¦ä¸ºlv2ï¼Œa çš„æ·±åº¦ç¡®å®lv2ï¼›  
- Alpha ä½œç”¨åŸŸå†…éƒ¨å£°æ˜çš„å˜é‡y é®è”½äº†å¤–éƒ¨çš„y å˜é‡ã€‚åœ¨å›¾ä¸­çœ‹å°±æ˜¯y2 æ›¿æ¢äº†y1 çš„æŸä¸€éƒ¨åˆ†ï¼›  
- ä½œç”¨åŸŸä¿¡å·è¡¨åŒ…æ‹¬äº†ä½œç”¨åŸŸçš„åå­—ã€æ·±åº¦å’Œå†…éƒ¨å˜é‡ç­‰ä¿¡æ¯ï¼›  
- åœ¨å›¾ä¸­ï¼Œä½ å¯èƒ½æ„è¯†åˆ°æˆ‘å¿½ç•¥çš„å†…ç½®ç±»å‹çš„ç¬¦å·ï¼Œå…¶å®å®ƒä»¬æ˜¯åœ¨lv1 ä¹Ÿå°±æ˜¯global ä½œç”¨åŸŸçš„ã€‚å› ä¸ºæ€»æ˜¯åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸å†™äº†ï¼Œä½†æ˜¯ä½ èƒ½åœ¨global ä½œç”¨åŸŸä¸­çœ‹åˆ°å®ƒä»¬ã€‚  

æ¥ä¸‹æ¥æ˜¯å®ç°çš„ç»†èŠ‚ã€‚é¦–å…ˆæˆ‘ä»¬çœ‹å˜é‡å’Œè¿‡ç¨‹çš„å£°æ˜ï¼Œç„¶åæˆ‘ä»¬è®¨è®ºå­˜åœ¨åµŒå¥—ä½œç”¨åŸŸæ—¶å˜é‡å¼•ç”¨å’Œç¬¦å·åè§£æçš„å®ç°ã€‚  

ç”±äºæš‚æ—¶ç”¨ä¸åˆ°å˜é‡çš„å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥ç®€åŒ–çš„Pascal æºç ä¸ºä¾‹ï¼š  
```pascal
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
   begin

   end;

begin { Main }

end.  { Main }
```

æˆ‘ä»¬å·²ç»çŸ¥é“å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨ä½œç”¨åŸŸç¬¦å·è¡¨è¡¨ç¤ºä¸€ä¸ªä½œç”¨åŸŸï¼Œç°åœ¨æˆ‘ä»¬æœ‰ä¸¤ä¸ªä½œç”¨åŸŸï¼šglobal å’Œalphaã€‚äºæ˜¯æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªä½œç”¨åŸŸç¬¦å·è¡¨ã€‚è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦æ‰©å±•è¯­ä¹‰åˆ†æå™¨ï¼Œåœ¨æ¯ä¸ªä½œç”¨åŸŸé®è”½global ä½œç”¨äºçš„æ—¶å€™å°±åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸç¬¦å·è¡¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šåœ¨éå†AST æ—¶è¿›è¡Œã€‚  

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šåœ¨ä»€ä¹ˆåœ°æ–¹åˆ›å»ºä½œç”¨åŸŸç¬¦å·è¡¨ã€‚å›æƒ³ä¸€ä¸‹PROGRAM å’ŒPROCEDURE å…³é”®å­—ä¼šå¼•å…¥æ–°çš„ä½œç”¨åŸŸã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨visit_Program å’Œvisit_Procedure æ–¹æ³•ä¸­åˆ›å»ºä½œç”¨åŸŸç¬¦å·è¡¨ã€‚ä»¥visit_Program æ–¹æ³•ä¸ºä¾‹ï¼š  
```python
def visit_Program(self, node):
    print('ENTER scope: global')
    global_scope = ScopedSymbolTable(
        scope_name='global',
        scope_level=1,
    )
    self.current_scope = global_scope

    # visit subtree
    self.visit(node.block)

    print(global_scope)
    print('LEAVE scope: global')
```  

æ–¹æ³•çš„æ”¹åŠ¨ä¸å¤šï¼š  
1. å½“è®¿é—®Program èŠ‚ç‚¹æ—¶ï¼Œæ‰“å°è¿›å…¥global ä½œç”¨åŸŸçš„ä¿¡æ¯  
2. åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„global ä½œç”¨åŸŸç¬¦å·è¡¨ï¼Œåå­—å’Œæ·±åº¦éƒ½æ˜¯å›ºå®šçš„  
3. å°†æ–°åˆ›å»ºçš„ä½œç”¨åŸŸç¬¦å·è¡¨è®¾ç½®ä¸ºå½“å‰ç¬¦å·è¡¨  
4. ç»§ç»­éå†å­èŠ‚ç‚¹
5. æ‰“å°global ä½œç”¨åŸŸç¬¦å·è¡¨çš„å†…å®¹  
6. åœ¨é€€å‡ºè¯¥æ–¹æ³•ä¹‹å‰æ‰“å°é€€å‡ºglobal ä½œç”¨åŸŸçš„ä¿¡æ¯  

> è¯‘æ³¨ï¼šè¿™é‡Œç¼ºå°‘äº†æ¢å¤å½“å‰ä½œç”¨åŸŸçš„æ­¥éª¤ï¼Œæœ€åé¢æ–‡ç« ä¼šè¡¥ä¸Šã€‚  

ä¸‹é¢æ˜¯å®Œæ•´çš„visit_Procedure æ–¹æ³•çš„ä»£ç ï¼š  
```python
def visit_ProcedureDecl(self, node):
    proc_name = node.proc_name
    proc_symbol = ProcedureSymbol(proc_name)
    self.current_scope.insert(proc_symbol)

    print('ENTER scope: %s' %  proc_name)
    # Scope for parameters and local variables
    procedure_scope = ScopedSymbolTable(
        scope_name=proc_name,
        scope_level=2,
    )
    self.current_scope = procedure_scope

    # Insert parameters into the procedure scope
    for param in node.params:
        param_type = self.current_scope.lookup(param.type_node.value)
        param_name = param.var_node.value
        var_symbol = VarSymbol(param_name, param_type)
        self.current_scope.insert(var_symbol)
        proc_symbol.params.append(var_symbol)

    self.visit(node.block_node)

    print(procedure_scope)
    print('LEAVE scope: %s' %  proc_name)
```  

é€æ­¥åˆ†æè¯¥æ–¹æ³•ï¼š  
1. åœ¨è¿›å…¥æ–¹æ³•æ—¶ä¼šåˆ›å»ºä½œç”¨åŸŸç¬¦å·ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°å½“å‰ä½œç”¨åŸŸç¬¦å·è¡¨ï¼ˆæ­¤ä¾‹ä¸­æ˜¯globalï¼‰  
2. æ‰“å°è¿›å…¥ä½œç”¨åŸŸçš„ä¿¡æ¯  
3. åˆ›å»ºæ–°çš„ä½œç”¨åŸŸç¬¦å·è¡¨  
4. å°†æ–°åˆ›å»ºçš„ä½œç”¨äºç¬¦å·è¡¨è®¾ç½®ä¸ºå½“å‰ç¬¦å·è¡¨  
5. ä¾æ¬¡å‘ç¬¦å·è¡¨ä¸­æ·»åŠ å½¢å‚ç¬¦å·  
6. ç»§ç»­éå†å­èŠ‚ç‚¹  
7. æœ€ç»ˆé€€å‡ºå‰æ‰“å°æ–°åˆ›å»ºçš„ä½œç”¨åŸŸç¬¦å·è¡¨çš„å†…å®¹å’Œé€€å‡ºä¿¡æ¯  

> è¯‘æ³¨ï¼šè¿™é‡ŒåŒæ ·ç¼ºå°‘äº†é€€å‡ºå‰æ¢å¤å½“å‰ç¬¦å·è¡¨çš„æ“ä½œ   

ç°åœ¨æˆ‘ä»¬éœ€è¦æ›´æ–°è¯­ä¹‰åˆ†æå™¨ï¼Œä½¿ç”¨`self.current_scope` ä½œç”¨åŸŸç¬¦å·è¡¨æ’å…¥å’Œæ£€ç´¢ç¬¦å·äº†ï¼š  
```python
def visit_VarDecl(self, node):
    type_name = node.type_node.value
    type_symbol = self.current_scope.lookup(type_name)

    # We have all the information we need to create a variable symbol.
    # Create the symbol and insert it into the symbol table.
    var_name = node.var_node.value
    var_symbol = VarSymbol(var_name, type_symbol)

    self.current_scope.insert(var_symbol)

def visit_Var(self, node):
    var_name = node.value
    var_symbol = self.current_scope.lookup(var_name)
    if var_symbol is None:
        raise Exception(
            "Error: Symbol(identifier) not found '%s'" % var_name
        )
```

ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šåœ¨å½“å‰ä½œç”¨åŸŸç¬¦å·è¡¨ä¸­æ£€ç´¢ç¬¦å·çš„å®šä¹‰æˆ–è€…æ’å…¥ç¬¦å·ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ç¨‹åºä¸­ï¼Œå½“å‰ä½œç”¨åŸŸç¬¦å·è¡¨æŒ‡å‘global æˆ–Alpha å…¶ä¸­çš„ä¸€ä¸ªã€‚åœ¨è¯­ä¹‰åˆ†æå™¨çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†`current_scope` å½“å‰ä½œç”¨åŸŸç¬¦å·è¡¨è®¾ä¸ºNoneï¼š  
```python
class SemanticAnalyzer(NodeVisitor):
    def __init__(self):
        self.current_scope = None
```

å…‹éš†æœ¬æ–‡çš„[ä»£ç ä»“åº“](https://github.com/rspivak/lsbasi)ï¼Œè¿è¡Œ[scope02.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope02.py)ï¼Œæ£€æŸ¥è¾“å‡ºæ˜¯å¦ç¬¦åˆé¢„æœŸï¼š   
```hell-session
$ python scope02.py
ENTER scope: global
Insert: INTEGER     # å†…ç½®ç±»å‹
Insert: REAL        # å†…ç½®ç±»å‹
Lookup: REAL
Insert: x
Lookup: REAL
Insert: y
Insert: Alpha
ENTER scope: Alpha
Insert: INTEGER     # å†…ç½®ç±»å‹è¢«é‡å¤æ·»åŠ 
Insert: REAL        # å†…ç½®ç±»å‹è¢«é‡å¤æ·»åŠ   
Lookup: INTEGER
Insert: a
Lookup: INTEGER
Insert: y


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : Alpha
Scope level    : 2
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      a: <VarSymbol(name='a', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>


LEAVE scope: Alpha


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : global
Scope level    : 1
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='REAL')>
      y: <VarSymbol(name='y', type='REAL')>
  Alpha: <ProcedureSymbol(name=Alpha, parameters=[<VarSymbol(name='a', type='INTEGER')>])>


LEAVE scope: global
```  

å…³äºä¸Šé¢çš„è¾“å‡ºï¼Œæœ‰äº›åœ°æ–¹å€¼å¾—ç€é‡å¼ºè°ƒä¸€ä¸‹ï¼š  
1. æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤æ¡è®°å½•ï¼š` Insert: INTEGER` å’Œ`nsert: REAL` é‡å¤å‡ºç°ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬åœ¨global å’ŒAlpha ä½œç”¨åŸŸç¬¦å·è¡¨è¢«åˆ›å»ºæ—¶éƒ½è¢«åˆ›å»ºå¹¶æ·»åŠ è¿›å½“å‰ç¬¦å·è¡¨ã€‚åé¢æˆ‘ä»¬ä¼šä¿®å¤å®ƒï¼Œå¹¶ä¸”å­¦ä¹ å¦‚ä½•åœ¨é“¾å¼åµŒå¥—çš„ç¬¦å·è¡¨ä¸­è¡¨ç¤ºã€‚  
2. `Insert: Alpha` æ¯”`ENTER scope: Alpha` æ›´æ—©æ‰§è¡Œï¼Œæ˜¯ä¸ºäº†è¯´æ˜ç¬¦å·è¡¨çš„ç¬¦å·ä¼šå…ˆè¢«æ·»åŠ åˆ°ä¸Šä¸€çº§çš„ç¬¦å·è¡¨ä¸­ã€‚  
3. ä½œç”¨åŸŸç¬¦å·è¡¨çš„æ‰“å°å†…å®¹ä¸­åŒ…å«å®ƒä»¬å†…éƒ¨å£°æ˜çš„å˜é‡ï¼ˆåŒ…æ‹¬å½¢å‚ï¼‰ã€‚  
4. å…¨å±€ç¬¦å·è¡¨ä¸­çš„Alpha ç¬¦å·è¿˜åŒ…å«æœ‰å…¶å‚æ•°ä¿¡æ¯ã€‚  

ç¨‹åºè¿è¡Œåï¼Œæˆ‘ä»¬çš„ä½œç”¨åŸŸç¬¦å·è¡¨åœ¨å†…å­˜ä¸­å¤§æ¦‚ä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼š  
![](../_resources/lsbasi_part14_img10.png)


## ä½œç”¨åŸŸæ ‘ï¼šé“¾å¼çš„ä½œç”¨åŸŸç¬¦å·è¡¨    

Okayï¼Œç°åœ¨æˆ‘ä»¬å¯¹äºæ¯ä¸ªä½œç”¨åŸŸéƒ½åˆ›å»ºäº†å•ç‹¬çš„ä½œç”¨åŸŸç¬¦å·è¡¨ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¡¨ç¤ºglobal ä½œç”¨åŸŸå’ŒAlpha ä½œç”¨åŸŸé—´çš„åµŒå¥—å…³ç³»å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­åº”è¯¥æ€ä¹ˆå°†Alpha ä½œç”¨åŸŸåµŒå¥—è¿›global ä½œç”¨åŸŸå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å°†å®ƒä»¬é“¾æ¥åˆ°ä¸€èµ·ã€‚æƒ³è±¡ä¸€ä¸‹é“¾è¡¨çš„é“¾ã€‚  

æˆ‘ä»¬å°†ä¼šé€šè¿‡åˆ›å»ºé“¾æ¥ï¼ˆlinkï¼‰æ¥è¿æ¥ä¸åŒçš„ä½œç”¨åŸŸç¬¦å·è¡¨ã€‚åœ¨æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œæœ€ç»ˆçš„å½¢å¼ä¼šåƒä¸€æ£µæ ‘ï¼Œåªä¸è¿‡æ˜¯ä»å­èŠ‚ç‚¹æŒ‡å‘æ ¹èŠ‚ç‚¹ã€‚ä¸‹é¢å°±æ˜¯ä½œç”¨åŸŸç¬¦å·è¡¨æ ‘ï¼ˆscope treeï¼‰çš„å›¾ç¤ºï¼š  
![](../_resources/lsbasi_part14_img11.png)  

æˆ‘ä»¬è¯¥å¦‚ä½•å®ç°ä½œç”¨åŸŸç¬¦å·è¡¨çš„é“¾æ¥å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤æ­¥ï¼š  
1. æˆ‘ä»¬éœ€è¦æ›´æ–°`ScopedSymbolTable` ç±»ï¼Œæ·»åŠ ä¸€ä¸ªå¤–éƒ¨ä½œç”¨åŸŸçš„å­—æ®µ`enclosing_scope` ç”¨äºæŒ‡å‘æ›´å¤–å±‚çš„ä½œç”¨åŸŸã€‚é€šè¿‡è¯¥å­—æ®µï¼Œå°±èƒ½å°†ä¸åŒçš„ä½œç”¨åŸŸï¼ˆç¬¦å·è¡¨ï¼‰è¿æ¥èµ·æ¥ã€‚  
2. æˆ‘ä»¬éœ€è¦æ›´æ–°`visit_Program` å’Œ`visit_Procedure` æ–¹æ³•å»å°†ç¬¦å·è¡¨çš„`enclosing_scope` çœŸæ­£åœ°æŒ‡å‘å¤–éƒ¨ä½œç”¨åŸŸã€‚  

ä¸‹é¢å°±å¼€å§‹æ›´æ–°`ScopedSymbolTable` ç±»ï¼ŒåŒæ—¶ä¹Ÿæ›´æ–°`__init__` æ„é€ æ–¹æ³•æ¥æ”¶å¤–éƒ¨çš„ä½œç”¨åŸŸä¿¡æ¯ï¼Œé»˜è®¤æ˜¯Noneï¼›ä»¥åŠ`__str__` æ–¹æ³•æ¥æ‰“å°å®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ï¼š  
```python
class ScopedSymbolTable(object):
    def __init__(self, scope_name, scope_level, enclosing_scope=None):
        self._symbols = OrderedDict()
        self.scope_name = scope_name
        self.scope_level = scope_level
        self.enclosing_scope = enclosing_scope
        self._init_builtins()

    def _init_builtins(self):
        self.insert(BuiltinTypeSymbol('INTEGER'))
        self.insert(BuiltinTypeSymbol('REAL'))

    def __str__(self):
        h1 = 'SCOPE (SCOPED SYMBOL TABLE)'
        lines = ['\n', h1, '=' * len(h1)]
        for header_name, header_value in (
            ('Scope name', self.scope_name),
            ('Scope level', self.scope_level),
            ('Enclosing scope',
             self.enclosing_scope.scope_name if self.enclosing_scope else None
            )
            # çœ‹è¿™é‡Œï¼Œç±»ä¼¼äºä¸‰ç›®è¿ç®—ç¬¦'?:' çš„è¿ç®—
            # var = sth IF condition ELSE other
        ):
            lines.append('%-15s: %s' % (header_name, header_value))
        h2 = 'Scope (Scoped symbol table) contents'
        lines.extend([h2, '-' * len(h2)])
        lines.extend(
            ('%7s: %r' % (key, value))
            for key, value in self._symbols.items()
        )
        lines.append('\n')
        s = '\n'.join(lines)
        return s

    __repr__ = __str__

    def insert(self, symbol):
        print('Insert: %s' % symbol.name)
        self._symbols[symbol.name] = symbol

    def lookup(self, name):
        print('Lookup: %s' % name)
        symbol = self._symbols.get(name)
        # 'symbol' is either an instance of the Symbol class or None
        return symbol
```  

æ¥ä¸‹æ¥è¿›è¡Œç¬¬äºŒæ­¥ï¼Œä¿®æ”¹`visit_Program` æ–¹æ³•ï¼š  
```python
def visit_Program(self, node):
    print('ENTER scope: global')
    global_scope = ScopedSymbolTable(
        scope_name='global',
        scope_level=1,
        enclosing_scope=self.current_scope, # None
    )
    self.current_scope = global_scope

    # visit subtree
    self.visit(node.block)

    print(global_scope)

    self.current_scope = self.current_scope.enclosing_scope
    # æ³¨æ„è¿™é‡Œæ¢å¤äº†å½“å‰çš„ä½œç”¨åŸŸæŒ‡å‘  
    print('LEAVE scope: global')
```  

ä»¥ä¸‹å‡ ç‚¹éœ€è¦å°¤å…¶æ³¨æ„ï¼š  
1. åœ¨åˆšè¿›å…¥æ–¹æ³•æ—¶ï¼Œè¯­ä¹‰åˆ†æå™¨çš„`self.current_scope` ä»ç„¶æŒ‡å‘å¤–éƒ¨çš„ä½œç”¨åŸŸï¼›  
2. éšåæˆ‘ä»¬åˆ›å»ºæ–°çš„ä½œç”¨åŸŸå¹¶èµ‹å€¼ç»™å½“å‰ä½œç”¨åŸŸ`self.current_scope`ï¼›  
3. åœ¨ç¦»å¼€è¯¥æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¢å¤`self.current_scope` é‡æ–°æŒ‡å‘å¤–éƒ¨ä½œç”¨åŸŸã€‚å¦åˆ™æˆ‘ä»¬çš„ä½œç”¨åŸŸæ ‘çš„ç»“æ„å°†ä¼šè¢«ç ´åï¼ˆåœ¨å¤šä¸ä¸¤ä¸ªä½œç”¨åŸŸå­˜åœ¨çš„æƒ…å†µï¼‰ï¼Œç¨åå°±ä¼šçœ‹åˆ°ã€‚  

æœ€åï¼Œæ›´æ–°ä¸‹`visit_Procedure` æ–¹æ³•ï¼š  
```python
def visit_ProcedureDecl(self, node):
    proc_name = node.proc_name
    proc_symbol = ProcedureSymbol(proc_name)
    self.current_scope.insert(proc_symbol)

    print('ENTER scope: %s' %  proc_name)
    # Scope for parameters and local variables
    procedure_scope = ScopedSymbolTable(
        scope_name=proc_name,
        scope_level=self.current_scope.scope_level + 1,
        enclosing_scope=self.current_scope
    )
    self.current_scope = procedure_scope

    # Insert parameters into the procedure scope
    for param in node.params:
        param_type = self.current_scope.lookup(param.type_node.value)
        param_name = param.var_node.value
        var_symbol = VarSymbol(param_name, param_type)
        self.current_scope.insert(var_symbol)
        proc_symbol.params.append(var_symbol)

    self.visit(node.block_node)

    print(procedure_scope)

    self.current_scope = self.current_scope.enclosing_scope
    print('LEAVE scope: %s' %  proc_name)
```  

å†æ¬¡è¯´æ˜ï¼Œå¯¹æ¯”äº[scope02.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope02.py) æˆ‘ä»¬çš„python ä»£ç ä¸»è¦æœ‰ä»¥ä¸‹æ”¹åŠ¨ï¼š  
1. åœ¨åˆ›å»ºä½œç”¨åŸŸæ—¶ï¼Œè¯­ä¹‰åˆ†æå™¨çš„`self.current_scope` ä»ç„¶æŒ‡å‘å¤–éƒ¨çš„ä½œç”¨åŸŸï¼›  
2. æˆ‘ä»¬ä¸å†ç¡¬ç¼–ç ä½œç”¨åŸŸçš„åµŒå¥—æ·±åº¦ï¼Œè€Œæ˜¯è®©å…¶æ ¹æ®å¤–å±‚ä½œç”¨åŸŸçš„æ·±åº¦è‡ªå¢ï¼›  
3. åœ¨ç¦»å¼€`visit_Procedure` æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¢å¤`self.current_scope` çš„æŒ‡å‘ã€‚  

Okayï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡[scope03a.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope03a.py) è¿è¡Œä¸‹é¢Pascal ç¨‹åºï¼Œä½ å¯ä»¥çœ‹åˆ°ç¬¦å·è¡¨ä¸­çš„å†…å®¹ï¼š  
```pascal
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
   begin

   end;

begin { Main }

end.  { Main }
```  

æ£€æŸ¥è¾“å‡ºæ˜¯å¦ç¬¦åˆé¢„æœŸï¼š  
```shell-session
$ python scope03a.py
ENTER scope: global
Insert: INTEGER
Insert: REAL
Lookup: REAL
Insert: x
Lookup: REAL
Insert: y
Insert: Alpha
ENTER scope: Alpha
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: a
Lookup: INTEGER
Insert: y


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : Alpha
Scope level    : 2
Enclosing scope: global
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      a: <VarSymbol(name='a', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>


LEAVE scope: Alpha


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : global
Scope level    : 1
Enclosing scope: None
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='REAL')>
      y: <VarSymbol(name='y', type='REAL')>
  Alpha: <ProcedureSymbol(name=Alpha, parameters=[<VarSymbol(name='a', type='INTEGER')>])>


LEAVE scope: global
```  

å¯ä»¥çœ‹åˆ°global ä½œç”¨åŸŸæ²¡æœ‰æ›´å¤–å±‚çš„ä½œç”¨åŸŸï¼Œè€ŒAlpha ä½œç”¨åŸŸå¤–é¢æ˜¯globalï¼Œä¹Ÿæ˜¯æˆ‘ä»¬é¢„æœŸçš„æ ·å­ã€‚ç°åœ¨çœ‹ï¼Œä¸ºä»€ä¹ˆéœ€è¦åœ¨ç¦»å¼€`visit_Program` å’Œ`visit_Procedure` å‰è¦æ¢å¤è¯­ä¹‰åˆ†æå™¨`self.current_scope` çš„æŒ‡å‘å§ï¼š  
```pascal
program Main;
   var x, y : real;

   procedure AlphaA(a : integer);
      var y : integer;
   begin { AlphaA }

   end;  { AlphaA }

   procedure AlphaB(a : integer);
      var b : integer;
   begin { AlphaB }

   end;  { AlphaB }

begin { Main }

end.  { Main }
```

åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œä½œç”¨åŸŸçš„åµŒå¥—å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![](../_resources/lsbasi_part14_img12.png)  

è¯­æ³•åˆ†æå™¨ç”Ÿæˆçš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆåªä¿ç•™äº†èŠ‚ç‚¹ä¿¡æ¯ï¼‰åº”å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![](../_resources/lsbasi_part14_img13.png)  

å¦‚æœåœ¨ç¦»å¼€ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•ä¹‹å‰æ²¡æœ‰æ¢å¤`self.current_scope` çš„æŒ‡å‘ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ  

é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œæˆ‘ä»¬çš„è¯­ä¹‰åˆ†æå™¨åœ¨éå†AST æŠ½è±¡è¯­æ³•æ ‘æ—¶é‡‡ç”¨çš„æ˜¯ä»å·¦è‡³å³ã€æ·±åº¦ä¼˜å…ˆçš„ç­–ç•¥ï¼Œæ‰€ä»¥å®ƒä¼šé¦–å…ˆä¾¿åˆ©AlphaAï¼Œè¿›è€Œéå†AlphaB èŠ‚ç‚¹ã€‚é—®é¢˜åœ¨äºï¼Œå¦‚æœæˆ‘ä»¬åœ¨é€€å‡ºAlphaA ä¹‹å‰å¦‚æœä¸è®²current_scope æ¢å¤è‡³å¤–å±‚ä½œç”¨åŸŸglobalï¼Œé‚£ä¹ˆè¯­ä¹‰åˆ†æå™¨å°†ä¼šæŠŠAlphaB çš„ä½œç”¨åŸŸåµŒå¥—è¿›AlphaA çš„ï¼Œå½¢æˆä¸‰å±‚çš„ç»“æ„ï¼Œä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯AlphaA ä¸AlphaB åœ¨ç›¸åŒçš„æ·±åº¦ã€‚æ‰€ä»¥è¿™æ ·æ˜¯ä¸å¯¹çš„ã€‚  

æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç¦ç”¨äº†æ¢å¤å½“å‰ä½œç”¨åŸŸçš„[scope03b.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope03b.py) æ¥çœ‹ä¸€ä¸‹è¯­ä¹‰åˆ†æå™¨çš„è¡Œä¸ºï¼š  
```shell-session
$ python scope03b.py
ENTER scope: global
Insert: INTEGER
Insert: REAL
Lookup: REAL
Insert: x
Lookup: REAL
Insert: y
Insert: AlphaA
ENTER scope: AlphaA
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: a
Lookup: INTEGER
Insert: y


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : AlphaA
Scope level    : 2
Enclosing scope: global
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      a: <VarSymbol(name='a', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>


LEAVE scope: AlphaA
Insert: AlphaB
ENTER scope: AlphaB
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: a
Lookup: INTEGER
Insert: b


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : AlphaB
Scope level    : 3
Enclosing scope: AlphaA
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      a: <VarSymbol(name='a', type='INTEGER')>
      b: <VarSymbol(name='b', type='INTEGER')>


LEAVE scope: AlphaB


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : global
Scope level    : 1
Enclosing scope: None
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='REAL')>
      y: <VarSymbol(name='y', type='REAL')>
 AlphaA: <ProcedureSymbol(name=AlphaA, parameters=[<VarSymbol(name='a', type='INTEGER')>])>


LEAVE scope: global
```  

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å‡ºç°ä¸¤ä¸ªä»¥ä¸Šçš„ä½œç”¨åŸŸæ—¶ï¼Œä½œç”¨åŸŸæ ‘çš„ç»“æ„å®Œå…¨è¢«ç ´ç¯æ‰äº†ï¼š  
> è¯‘æ³¨ï¼šæ›´ç¡®åˆ‡åœ°è¯´ï¼Œæ˜¯å‡ºç°å¹¶åˆ—çš„ä½œç”¨åŸŸæ—¶ï¼Œå¦‚æœä¸æ¢å¤current_scope åˆ°å¤–éƒ¨ä½œç”¨åŸŸï¼Œå°±ä¼šç ´åä½œç”¨åŸŸçš„å¹¶åˆ—å…³ç³»ã€‚  

1. æˆ‘ä»¬ç°åœ¨æœ‰ä¸‰å±‚æ·±åº¦çš„åµŒå¥—å…³ç³»ï¼Œè€Œä¸æ˜¯ä¸¤å±‚ï¼›  
2. Global ä½œç”¨åŸŸå†…éƒ¨åªåŒ…å«AlphaA è€Œæ²¡æœ‰AlphaBã€‚  

ä¸ºäº†æ­£ç¡®åœ°æ„é€ ä½œç”¨åŸŸæ ‘ï¼Œæˆ‘ä»¬éœ€è¦åœ¨éå†è¿‡ç¨‹å£°æ˜æ—¶ï¼š  
1. è¿›å…¥æ–¹æ³•æ—¶åˆ›å»ºä½œç”¨åŸŸï¼Œå¹¶èµ‹å€¼ç»™å½“å‰ä½œç”¨åŸŸ`self.current_scope`  
2. åœ¨é€€å‡ºæ–¹æ³•ä¹‹å‰ï¼Œæ¢å¤`self.curren_scope` æŒ‡å‘åŸå…ˆçš„ä½œç”¨åŸŸã€‚  

çœ‹åˆ°è¿™é‡Œæœ‰æ²¡æœ‰æƒ³åˆ°è®¡ç®—æœºé‡Œé¢çš„ä¸€ç§å¸¸ç”¨æ•°æ®ç»“æ„ï¼šæ ˆï¼š  
1. éå†Program å’ŒProcedureDecl èŠ‚ç‚¹æ—¶ï¼Œå°†`self.current_scope` å‹æ ˆï¼Œå¹¶åˆ›å»ºæ–°çš„ä½œç”¨åŸŸèµ‹å€¼ç»™å®ƒï¼›  
2. åœ¨ç¦»å¼€èŠ‚ç‚¹æ—¶ï¼Œå¼¹å‡ºæœ€è¿‘çš„ä½œç”¨åŸŸå¹¶é‡æ–°èµ‹å€¼ç»™`self.current_scope`ã€‚  

é€šè¿‡è¿è¡Œ[scope03c.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope03c.py) å¯ä»¥çœ‹åˆ°è¯­ä¹‰åˆ†æå™¨æ­£ç¡®çš„è¡Œä¸ºï¼š  
```shel-session
$ python scope03c.py
ENTER scope: global
Insert: INTEGER
Insert: REAL
Lookup: REAL
Insert: x
Lookup: REAL
Insert: y
Insert: AlphaA
ENTER scope: AlphaA
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: a
Lookup: INTEGER
Insert: y


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : AlphaA
Scope level    : 2
Enclosing scope: global
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      a: <VarSymbol(name='a', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>


LEAVE scope: AlphaA
Insert: AlphaB
ENTER scope: AlphaB
Insert: INTEGER
Insert: REAL
Lookup: INTEGER
Insert: a
Lookup: INTEGER
Insert: b


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : AlphaB
Scope level    : 2
Enclosing scope: global
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      a: <VarSymbol(name='a', type='INTEGER')>
      b: <VarSymbol(name='b', type='INTEGER')>


LEAVE scope: AlphaB


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : global
Scope level    : 1
Enclosing scope: None
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='REAL')>
      y: <VarSymbol(name='y', type='REAL')>
 AlphaA: <ProcedureSymbol(name=AlphaA, parameters=[<VarSymbol(name='a', type='INTEGER')>])>
 AlphaB: <ProcedureSymbol(name=AlphaB, parameters=[<VarSymbol(name='a', type='INTEGER')>])>


LEAVE scope: global
```

åœ¨è¿è¡Œè„šæœ¬åï¼Œæ­£ç¡®çš„ä½œç”¨åŸŸçš„ç»“æ„åº”å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![](../_resources/lsbasi_part14_img14.png)  

å°±æ˜¯ï¼Œå¯ä»¥æŠŠå½“å‰ä½œç”¨åŸŸçš„åˆ‡æ¢è¿‡ç¨‹ç±»æ¯”ä¸ºæ ˆæ“ä½œã€‚ä¸‹é¢ç»§ç»­çœ‹åµŒå¥—çš„ä½œç”¨åŸŸä¸å…¶ä¸­ç¬¦å·åçš„è§£æéƒ¨åˆ†ã€‚

## åµŒå¥—çš„ä½œç”¨åŸŸä¸ç¬¦å·åè§£æ  
åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€ç›´å…³æ³¨å˜é‡å’Œè¿‡ç¨‹çš„å£°æ˜ï¼Œç°åœ¨æˆ‘ä»¬ä¸€å¹¶è®¨è®ºå˜é‡çš„å¼•ç”¨ã€‚ä»¥ä¸‹é¢ç¨‹åºä¸ºä¾‹ï¼š  
```pascall
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
   begin
      x := a + x + y;
   end;

begin { Main }

end.  { Main }
```  

ç›´è§‚çš„ï¼Œä½œç”¨åŸŸç›¸å…³ä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  
![](../_resources/lsbasi_part14_img08.png)  
![](../_resources/lsbasi_part14_img09.png)  

é‡ç‚¹å…³æ³¨èµ‹å€¼è¡¨è¾¾å¼`x:=a+x+y;`ï¼Œä¸‹å›¾ä¸­æœ‰å¸¦ä¸‹æ ‡æ ‡æ³¨ï¼š  
![](../_resources/lsbasi_part14_img15.png)  

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œx è¢«å£°æ˜çš„ä½œç”¨åŸŸçš„æ·±åº¦æ˜¯lv1ï¼Œè€Œa å’Œy è¢«å£°æ˜çš„ä½œç”¨åŸŸçš„æ·±åº¦æ˜¯lv2ã€‚è¯¥å¦‚ä½•è§£æå‘¢ï¼Ÿ  

è¯æ³•ä½œç”¨åŸŸï¼ˆä¹Ÿå«é™æ€ä½œç”¨åŸŸï¼‰åœ¨è§£æç¬¦å·æ—¶éµå¾ªå°±è¿‘åŸåˆ™ï¼šå¦‚æœåœ¨å½“å‰ä½œç”¨åŸŸæ²¡å‘ç°ç¬¦å·çš„å£°æ˜ï¼Œå°±ä¼šå»ä¸Šä¸€å±‚ä½œç”¨åŸŸå¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°äº†å®šä¹‰æˆ–è€…åˆ°è¾¾æœ€å¤–å±‚çš„ä½œç”¨åŸŸã€‚ä¸‹é¢è¯·çœ‹å…·ä½“æ˜¯å¦‚ä½•æ“ä½œçš„ï¼š  
1. è¯­ä¹‰åˆ†æå™¨é¦–å…ˆä¼šéå†èµ‹å€¼è¯­å¥çš„å³è¾¹è¡¨è¾¾å¼`a+x+y`ã€‚é¦–å…ˆåœ¨æœ€è¿‘çš„Alpha ä½œç”¨åŸŸå¯»æ‰¾a çš„å®šä¹‰ã€‚ç”±äºa æ˜¯å½¢å‚ï¼Œåœ¨Alpha ä¸­æœ‰å£°æ˜ï¼Œæ‰€ä»¥è‡ªç„¶èƒ½æ‰¾å¾—åˆ°ã€‚ç»“æŸã€‚  
    ![](../_resources/lsbasi_part14_img16.png)
2. ç»§ç»­å¯»æ‰¾xã€‚å› ä¸ºx æ˜¯åœ¨Program ä¸­å®šä¹‰çš„ï¼Œåœ¨å½“å‰Alpha ä½œç”¨åŸŸä¸­æ‰¾ä¸åˆ°å®šä¹‰ï¼Œå°±ä¼šå‘ä¸Šå¯»æ‰¾global ä½œç”¨åŸŸã€‚æœ€ç»ˆåœ¨global ä½œç”¨åŸŸæˆåŠŸæ‰¾åˆ°ã€‚ç»“æŸã€‚  
    ![](../_resources/lsbasi_part14_img17.png)
3. æ¥ä¸‹æ¥æ˜¯yã€‚å› ä¸ºy å±äºAlpha ä¸­å£°æ˜çš„å˜é‡ï¼Œæ‰€ä»¥å¯ä»¥æ‰¾åˆ°å®šä¹‰ï¼Œæ‰€åœ¨çš„ä½œç”¨åŸŸåŒa ä¸€æ ·æ˜¯Alphaï¼Œæ·±åº¦æ˜¯2ã€‚  
    ![](../_resources/lsbasi_part14_img18.png)
4. æœ€åï¼Œè§£æèµ‹å€¼è¡¨è¾¾å¼å·¦è¾¹çš„å˜é‡xã€‚åŒæ­¥éª¤2 ä¸€æ ·ï¼Œæœ€åæˆ‘ä»¬åœ¨global ä½œç”¨åŸŸä¸­æ‰¾åˆ°äº†å®ƒçš„å£°æ˜ã€‚  
    ![](../_resources/lsbasi_part14_img19.png)

æˆ‘ä»¬è¯¥å¦‚ä½•å®ç°è¿™ç§é€’å½’å¼åœ°å‘ä¸ŠæŸ¥æ‰¾ï¼Ÿåªéœ€è¦åœ¨lookup æ–¹æ³•ä¸­åšä¸€äº›æ”¹åŠ¨ï¼Œè®©å®ƒåœ¨æŸ¥æ‰¾ä¸åˆ°è®°å½•æ—¶è¿”å›å¤–å±‚ä½œç”¨åŸŸæŸ¥æ‰¾çš„å¾·å›½å°±å¥½äº†ã€‚  
```python
def lookup(self, name):
    print('Lookup: %s. (Scope name: %s)' % (name, self.scope_name))
    # 'symbol' is either an instance of the Symbol class or None
    symbol = self._symbols.get(name)

    if symbol is not None:
        return symbol

    # recursively go up the chain and lookup the name
    if self.enclosing_scope is not None:
        return self.enclosing_scope.lookup(name)

    # ä¸¥æ ¼æ¥è¯´æœ€åè¿˜åº”è¯¥return None çš„
```  

lookup æ–¹æ³•å·¥ä½œçš„æœºåˆ¶ï¼š  
1. åœ¨å½“å‰ä½œç”¨åŸŸæŸ¥æ‰¾ç¬¦å·ï¼Œèƒ½æ‰¾åˆ°å°±è¿”å›ï¼›  
2. å¦åˆ™ï¼Œè°ƒç”¨å¤–å±‚ä½œç”¨åŸŸçš„lookup æ–¹æ³•è¿›è¡ŒæŸ¥è¯¢ã€‚è™½ç„¶æ²¡æœ‰æ˜ç¡®å†™ï¼Œä½†è¿™ç¡®æ˜¯é€’å½’åœ°æŸ¥è¯¢ï¼ŒçŸ¥é“é‡åˆ°å¯¹åº”çš„å®šä¹‰æˆ–è€…çŸ¥é“ä½œç”¨åŸŸçš„æ ‘é¡¶ä¹Ÿæ— æ³•æ‰¾åˆ°å®šä¹‰ï¼›  
3. lookup æ–¹æ³•ä¼šæ‰“å°å½“å‰ä½œç”¨åŸŸçš„åå­—ï¼Œæ¥æ¸…æ™°åœ°æ˜¾ç¤ºå½“å‰å®ƒæŸ¥æ‰¾åˆ°é‚£ä¸ªä½œç”¨åŸŸäº†ã€‚  


ä¸‹è½½å¹¶è¿è¡Œ[scope04a.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope04a.py)ï¼ŒæŸ¥çœ‹ä¿®æ”¹åçš„lookup æ–¹æ³•æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼š  
```shell-session
$ python scope04a.py
ENTER scope: global
Insert: INTEGER
Insert: REAL
Lookup: REAL. (Scope name: global)
Insert: x
Lookup: REAL. (Scope name: global)
Insert: y
Insert: Alpha
ENTER scope: Alpha
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Insert: a
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Insert: y
Lookup: a. (Scope name: Alpha)
Lookup: x. (Scope name: Alpha)
Lookup: x. (Scope name: global)
Lookup: y. (Scope name: Alpha)
Lookup: x. (Scope name: Alpha)
Lookup: x. (Scope name: global)


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : Alpha
Scope level    : 2
Enclosing scope: global
Scope (Scoped symbol table) contents
------------------------------------
      a: <VarSymbol(name='a', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>


LEAVE scope: Alpha


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : global
Scope level    : 1
Enclosing scope: None
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='REAL')>
      y: <VarSymbol(name='y', type='REAL')>
  Alpha: <ProcedureSymbol(name=Alpha, parameters=[<VarSymbol(name='a', type='INTEGER')>])>


LEAVE scope: global
```

æ£€æŸ¥ä¸Šé¢çš„è¾“å‡ºï¼Œå¹¶é‡ç‚¹å…³æ³¨ä¸€ä¸‹`ENTER` å’Œ`Lookup` çš„æ¶ˆæ¯ï¼š  
1. æ³¨æ„è¯­ä¹‰åˆ†æå™¨æ˜¯å¦‚ä½•æŸ¥æ‰¾å†…ç½®ç±»å‹`INTEGER` çš„ã€‚å› ä¸ºä½œè€…å·²ç»æ‚„æ‚„åœ°å°†å†…ç½®ç±»å‹çš„ç”Ÿå‘½è½¬ç§»åˆ°global ä½œç”¨åŸŸäº†ã€‚  
    ```shell-session
    ENTER scope: Alpha
    Lookup: INTEGER. (Scope name: Alpha)
    Lookup: INTEGER. (Scope name: global)
    Insert: a
    ```
2. æ³¨æ„è§£æèµ‹å€¼è¯­å¥`x:=a+x+y;` æ—¶çš„é¡ºåºï¼š  
    ```shell-session
    Lookup: a. (Scope name: Alpha)
    Lookup: x. (Scope name: Alpha)
    Lookup: x. (Scope name: global)
    Lookup: y. (Scope name: Alpha)
    Lookup: x. (Scope name: Alpha)
    Lookup: x. (Scope name: global)
    ```  
    è¯­ä¹‰åˆ†æå™¨é‡è§†ä»å½“å‰ä½œç”¨åŸŸå¼€å§‹æ£€ç´¢ï¼Œä¸€ç›´åˆ°global ä¸ºæ­¢ï¼ˆæˆ–è€…æå‰æ‰¾åˆ°å®šä¹‰ï¼‰ã€‚  

å¦‚æœPascal ä»£ç ä¸­å¼•ç”¨äº†æœªå®šä¹‰çš„å˜é‡ï¼Œåˆ™è¯­ä¹‰åˆ†æå™¨ä¸èƒ½è§£æè¯¥å˜é‡ï¼š  
```pascal
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
   begin
      x := b + x + y; { ERROR here! }
   end;

begin { Main }

end.  { Main }
```  

ä¸‹è½½[scope04b.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope04b.py) å¹¶è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š  
```shell-session
$ python scope04b.py
ENTER scope: global
Insert: INTEGER
Insert: REAL
Lookup: REAL. (Scope name: global)
Insert: x
Lookup: REAL. (Scope name: global)
Insert: y
Insert: Alpha
ENTER scope: Alpha
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Insert: a
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Insert: y
Lookup: b. (Scope name: Alpha)
Lookup: b. (Scope name: global)
Error: Symbol(identifier) not found 'b'
```  

å¯ä»¥çœ‹åˆ°ï¼Œè¯­ä¹‰åˆ†æå™¨è¯•å›¾åœ¨Alpha ä½œç”¨åŸŸä¸­æ£€ç´¢å˜é‡bï¼Œå¤±è´¥åè¿›å…¥global ä½œç”¨åŸŸç»§ç»­æ£€ç´¢ï¼Œæœ€ç»ˆæ²¡æœ‰æ‰¾åˆ°ï¼Œäºæ˜¯æŠ›å‡ºä¸€ä¸ªè¯­ä¹‰é”™è¯¯ã€‚

Greatï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æŒæ¡äº†å¦‚ä½•è®©è¯­ä¹‰åˆ†æå™¨åˆ†æåµŒå¥—ä½œç”¨åŸŸä¸­çš„è¯­ä¹‰é”™è¯¯äº†ï¼  


## æºåˆ°æºçš„ç¼–è¯‘å™¨  
ä¸‹é¢æ¥ç‚¹æ–°ä¸œè¥¿ï¼Œå†™ä¸€ä¸ªæºåˆ°æºçš„ç¼–è¯‘å™¨ï¼æˆ‘ä»¬ä¸æ˜¯åœ¨è®²åµŒå¥—ä½œç”¨åŸŸå—ï¼Ÿæ€ä¹ˆçªç„¶å¼€å§‹å†™ç¼–è¯‘å™¨äº†ï¼Ÿæ˜¯çš„ï¼Œä½†æ˜¯ç°åœ¨å¼€å§‹å†™S2S ç¼–è¯‘å™¨æ˜¯æœ‰å¥½å¤„çš„ã€‚

é¦–å…ˆæˆ‘ä»¬çœ‹ä»€ä¹ˆæ˜¯S2S ç¼–è¯‘å™¨ã€‚å®ƒæ˜¯ä¸€ç§å¯ä»¥å°†ä¸€ç§è¯­è¨€çš„æºä»£ç ç¿»è¯‘æˆå¦ä¸€ç§è¯­è¨€çš„æºä»£ç çš„å·¥å…·ã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ªå·¥å…·å®ƒèƒ½å°†Pascal ä»£ç ç¿»è¯‘æˆä¸€ç§æ›´åŠ è§„èŒƒçš„å½¢å¼ï¼Œé‚£å®ƒä¹Ÿæ˜¯ä¸€ç§æºåˆ°æºçš„ç¼–è¯‘å™¨ã€‚  

å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œç›®å‰åªè¦èƒ½åšåˆ°å°†Pascal è¯­è¨€æºç ç¿»è¯‘æˆç±»Pascal é£æ ¼å°±å¥½äº†ã€‚ä¾‹å¦‚ï¼šç»™å˜é‡ç¬¦å·åŠ ä¸Šä½œç”¨åŸŸçš„ä¸‹æ ‡ï¼Œåœ¨å¼•ç”¨å˜é‡æ—¶æ³¨æ˜å˜é‡çš„ç±»å‹ã€‚ä»¥ä¸‹é¢Pascal æºç ä¸ºä¾‹ï¼š  
```pascal
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
   begin
      x := a + x + y;
   end;

begin { Main }

end.  { Main }
```  
å¯ä»¥è¢«ç¿»è¯‘ä¸ºï¼š  
```pascal
program Main0;
   var x1 : REAL;
   var y1 : REAL;
   procedure Alpha1(a2 : INTEGER);
      var y2 : INTEGER;

   begin
      <x1:REAL> := <a2:INTEGER> + <x1:REAL> + <y2:INTEGER>;
   end; {END OF Alpha}

begin

end. {END OF Main}
```  

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„S2S ç¼–è¯‘å™¨å°†è¦å¯¹Pascal æºä»£ç åšçš„ä¿®æ”¹ï¼š  
1. æ¯ä¸€ä¸ªå˜é‡çš„å£°æ˜éƒ½è¢«æ‹†æˆä¸€è¡Œã€‚å¦‚æœä¸€æ¡å£°æ˜è¯­å¥å£°æ˜äº†å¤šä¸ªå˜é‡ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šè¢«æ‹†åˆ†ä¸ºå¤šæ¡å£°æ˜è¯­å¥ï¼›  
2. æ¯ä¸€ä¸ªç¬¦å·éƒ½ä¼šè¢«æ‰“ä¸Šå½“å‰ä½œç”¨åŸŸçš„ä¸‹æ ‡ï¼›  
3. æ¯ä¸€ä¸ªå˜é‡çš„å¼•ç”¨éƒ½ä¼šåœ¨åé¢æ³¨æ˜å˜é‡çš„ç±»å‹ï¼›  
4. ç¼–è¯‘å™¨è¿˜ä¼šåœ¨ä»£ç å—ç»“æŸæ—¶ï¼Œæ·»åŠ æ³¨é‡Šï¼Œè¡¨æ˜è¿‡ç¨‹çš„è¾¹ç•Œã€‚  

ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„S2S ç¼–è¯‘å™¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£ç¬¦å·è§£æçš„è¿‡ç¨‹ï¼Œå°¤å…¶æ˜¯å­˜åœ¨åµŒå¥—ä½œç”¨åŸŸçš„æƒ…å†µä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡å˜é‡åçš„ä¸‹æ ‡å°±å¯ä»¥çœ‹åˆ°å˜é‡åœ¨å“ªä¸ªä½œç”¨åŸŸå£°æ˜çš„ã€‚  

å¦‚ä½•å®ç°ä¸€ä¸ªS2S çš„ç¼–è¯‘å™¨å‘¢ï¼Ÿå…¶å®æˆ‘ä»¬å·²ç»å­¦è¿‡æ‰€æœ‰å¿…è¦çš„ç»„ä»¶äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰©å±•æˆ‘ä»¬çš„è¯­ä¹‰åˆ†æå™¨æ¥ç”Ÿæˆè¿™æ ·ä¸€ä¸ªè¾“å‡ºã€‚æˆ‘ä»¬æˆ‘ä»¬å¯ä»¥ä¸‹è½½å…¨éƒ¨çš„[æºç ](https://github.com/rspivak/lsbasi/blob/master/part14/src2srccompiler.py)ï¼Œé€šè¿‡AST èŠ‚ç‚¹ç”Ÿæˆå¹¶ä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¿”å›è¾“å‡ºä»£ç ã€‚  

ä¸‹è½½[src2srccompiler.py](https://github.com/rspivak/lsbasi/blob/master/part14/src2srccompiler.py)ï¼Œå­¦ä¹ å¹¶å°è¯•ç¿»è¯‘ä¸åŒçš„Pascal æºç ã€‚ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹ï¼š  
```pascal
program Main;
   var x, y : real;
   var z : integer;

   procedure AlphaA(a : integer);
      var y : integer;
   begin { AlphaA }
      x := a + x + y;
   end;  { AlphaA }

   procedure AlphaB(a : integer);
      var b : integer;
   begin { AlphaB }
   end;  { AlphaB }

begin { Main }
end.  { Main }
```  

æˆ‘ä»¬çš„ç¼–è¯‘å™¨å°†ä¼šäº§ç”Ÿå¦‚ä¸‹çš„è¾“å‡ºï¼š  
```shell-session
$ python src2srccompiler.py nestedscopes03.pas
program Main0;
   var x1 : REAL;
   var y1 : REAL;
   var z1 : INTEGER;
   procedure AlphaA1(a2 : INTEGER);
      var y2 : INTEGER;

   begin
      <x1:REAL> := <a2:INTEGER> + <x1:REAL> + <y2:INTEGER>;
   end; {END OF AlphaA}
   procedure AlphaB1(a2 : INTEGER);
      var b2 : INTEGER;

   begin

   end; {END OF AlphaB}

begin

end. {END OF Main}
```  

æ­å–œä½ ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å†™å‡ºäº†ä¸€ä¸ªåŸºæœ¬çš„S2S ç¼–è¯‘å™¨äº†ã€‚é€šè¿‡å®ƒå¯ä»¥åŠ æ·±å¯¹åµŒå¥—ä½œç”¨åŸŸã€ç¬¦å·è§£æçš„ç†è§£ï¼Œä»¥åŠåˆ©ç”¨AST å’Œç¬¦å·è¡¨ä¿¡æ¯æˆ‘ä»¬å¯ä»¥åšå“ªäº›äº‹æƒ…ã€‚  

æ—¢ç„¶æœ‰äº†å·¥å…·ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç¨å¾®å¤æ‚ç‚¹çš„ç¨‹åº[nextedscopes04.pas](https://github.com/rspivak/lsbasi/blob/master/part14/nestedscopes04.pas) æ¥åšä¸‹æµ‹è¯•ï¼š  
```pascal
program Main;
   var b, x, y : real;
   var z : integer;

   procedure AlphaA(a : integer);
      var b : integer;

      procedure Beta(c : integer);
         var y : integer;

         procedure Gamma(c : integer);
            var x : integer;
         begin { Gamma }
            x := a + b + c + x + y + z;
         end;  { Gamma }

      begin { Beta }

      end;  { Beta }

   begin { AlphaA }

   end;  { AlphaA }

   procedure AlphaB(a : integer);
      var c : real;
   begin { AlphaB }
      c := a + b;
   end;  { AlphaB }

begin { Main }
end.  { Main }
```

ä¸‹é¢å¯ä»¥çœ‹åˆ°å£°æ˜çš„ä½œç”¨åŸŸä»¥åŠä»–ä»¬åµŒå¥—çš„å…³ç³»å›¾ï¼š  
![](../_resources/lsbasi_part14_img20.png)
![](../_resources/lsbasi_part14_img21.png)  

é€šè¿‡æˆ‘ä»¬çš„S2S ç¼–è¯‘å™¨ç¼–è¯‘ä»£ç ï¼Œå¯ä»¥æ£€æŸ¥è¾“å‡ºæ˜¯å¦å¦‚é¢„æœŸä¸€è‡´ï¼š  
```shell-session
$ python src2srccompiler.py nestedscopes04.pas
```
```pascal
program Main0;
   var b1 : REAL;
   var x1 : REAL;
   var y1 : REAL;
   var z1 : INTEGER;
   procedure AlphaA1(a2 : INTEGER);
      var b2 : INTEGER;
      procedure Beta2(c3 : INTEGER);
         var y3 : INTEGER;
         procedure Gamma3(c4 : INTEGER);
            var x4 : INTEGER;

         begin
            <x4:INTEGER> := <a2:INTEGER> + <b2:INTEGER> + <c4:INTEGER> + <x4:INTEGER> + <y3:INTEGER> + <z1:INTEGER>;
         end; {END OF Gamma}

      begin

      end; {END OF Beta}

   begin

   end; {END OF AlphaA}
   procedure AlphaB1(a2 : INTEGER);
      var c2 : REAL;

   begin
      <c2:REAL> := <a2:INTEGER> + <b1:REAL>;
   end; {END OF AlphaB}

begin

end. {END OF Main}
```

ä»”ç»†çœ‹ä»¥ä¸‹ä¸Šé¢çš„å›¾ç‰‡å’Œè¾“å‡ºï¼Œç¡®ä¿è‡ªå·±ç†è§£äº†ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š  
- å›¾ç‰‡ä¸­å³è¾¹çš„ç«–çº¿è¡¨ç¤ºä½œç”¨åŸŸèŒƒå›´ï¼›  
- ç«–çº¿å¦‚æœä¸­æ–­ï¼Œåˆ™è¡¨æ˜è¿™æ®µä½œç”¨åŸŸè¢«åŒåçš„å˜é‡æ‰€é®è”½ï¼›  
- AlphaA å’ŒAlphaB å¹¶åˆ—å­˜åœ¨äºglobal å…¨å±€ä½œç”¨åŸŸä¸­ï¼›  
- AlphaA å’ŒAlphaB åˆ†åˆ«å¼•å…¥äº†æ–°çš„ä½œç”¨åŸŸï¼›  
- ä½œç”¨åŸŸä¹‹é—´åº”è¯¥å¦‚ä½•åµŒå¥—ä»¥åŠå®ƒä»¬çš„åµŒå¥—å…³ç³»ï¼›  
- ä¸ºä»€ä¹ˆä¸åŒçš„ç¬¦å·åä¼šè¢«æ‰“ä¸Šä¸é€šçš„ä¸‹æ ‡ã€‚lookup æ–¹æ³•æ˜¯å¦‚ä½•æ£€ç´¢ç¬¦å·çš„ã€‚  

ä¹Ÿå¯ä»¥è¿è¡Œ[ä¸‹é¢ç¨‹åº](https://github.com/rspivak/lsbasi/blob/master/part14/scope05.py)  
```shell-session
$ python scope05.py nestedscopes04.pas
```  

æ£€æŸ¥ä½œç”¨åŸŸç¬¦å·è¡¨ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸ä¸Šé¢ä½œç”¨åŸŸä¿¡æ¯è¡¨çš„å†…å®¹æ¯”è¾ƒã€‚ä¸è¦å¿˜è®°ä½¿ç”¨[genastdot.py](https://github.com/rspivak/lsbasi/blob/master/part14/genastdot.py) ç”Ÿæˆå¯è§†åŒ–çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œçœ‹æˆ‘ä»¬çš„è¿‡ç¨‹å£°æ˜æ˜¯å¦‚ä½•åµŒå¥—çš„ã€‚  

åœ¨ç»“æŸä»Šå¤©çš„è¯é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜è¦å†å¤„ç†ä¸€ä¸‹åˆšå¼€å§‹ç¦ç”¨æ‰çš„é‡å¤å£°æ˜çš„è¯­ä¹‰æ£€æŸ¥ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å†lookup æ–¹æ³•ä¸­å°†å®ƒé‡æ–°å¯ç”¨ï¼Œéœ€è¦ç»™æ–¹æ³•æ–°å¢ä¸€ä¸ªå‚æ•°ä»¥ç¡®å®šæ˜¯å¦éœ€è¦åªåœ¨å½“å‰ä½œç”¨åŸŸä¸­æŸ¥æ‰¾ï¼š  
```python
def lookup(self, name, current_scope_only=False):
    print('Lookup: %s. (Scope name: %s)' % (name, self.scope_name))
    # 'symbol' is either an instance of the Symbol class or None
    symbol = self._symbols.get(name)

    if symbol is not None:
        return symbol

    if current_scope_only:
        return None

    # recursively go up the chain and lookup the name
    if self.enclosing_scope is not None:
        return self.enclosing_scope.lookup(name)
```

ç„¶åå°±æ˜¯éœ€è¦ä¿®æ”¹`visit_VarDecl` æ–¹æ³•ï¼Œåœ¨åˆ›å»ºç¬¦å·å‰å…ˆæ£€æŸ¥ç¬¦å·æ˜¯å¦åœ¨å½“å‰ä½œç”¨åŸŸå·²ç»å­˜åœ¨ï¼š  
```python
def visit_VarDecl(self, node):
    type_name = node.type_node.value
    type_symbol = self.current_scope.lookup(type_name)

    # We have all the information we need to create a variable symbol.
    # Create the symbol and insert it into the symbol table.
    var_name = node.var_node.value
    var_symbol = VarSymbol(var_name, type_symbol)

    # Signal an error if the table alrady has a symbol
    # with the same name
    if self.current_scope.lookup(var_name, current_scope_only=True):
        raise Exception(
            "Error: Duplicate identifier '%s' found" % var_name
        )

    self.current_scope.insert(var_symbol)
```  

å¦‚æœæˆ‘ä»¬ä¸é™åˆ¶åªåœ¨å½“å‰ä½œç”¨åŸŸæŸ¥æ‰¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„lookup å¦‚æœåœ¨å¤–å›´çš„ä½œç”¨åŸŸæŸ¥æ‰¾åˆ°åŒåçš„ç¬¦å·ä¹Ÿä¼šæŠ¥é”™ã€‚è¿™æ ·æ˜¯ä¸è¡Œçš„ã€‚  

é€šè¿‡è¿è¡Œ[scope05.py](https://github.com/rspivak/lsbasi/blob/master/part14/scope05.py) æ£€æŸ¥æ²¡æœ‰é‡å¤å£°æ˜çš„Pascal è¯­è¨€æºç èƒ½å¤Ÿå¾—åˆ°ä»€ä¹ˆè¾“å‡ºï¼š
```shell-session
$ python scope05.py nestedscopes02.pas
ENTER scope: global
Insert: INTEGER
Insert: REAL
Lookup: REAL. (Scope name: global)
Lookup: x. (Scope name: global)
Insert: x
Lookup: REAL. (Scope name: global)
Lookup: y. (Scope name: global)
Insert: y
Insert: Alpha
ENTER scope: Alpha
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Insert: a
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Lookup: y. (Scope name: Alpha)
Insert: y
Lookup: a. (Scope name: Alpha)
Lookup: x. (Scope name: Alpha)
Lookup: x. (Scope name: global)
Lookup: y. (Scope name: Alpha)
Lookup: x. (Scope name: Alpha)
Lookup: x. (Scope name: global)


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : Alpha
Scope level    : 2
Enclosing scope: global
Scope (Scoped symbol table) contents
------------------------------------
      a: <VarSymbol(name='a', type='INTEGER')>
      y: <VarSymbol(name='y', type='INTEGER')>


LEAVE scope: Alpha


SCOPE (SCOPED SYMBOL TABLE)
===========================
Scope name     : global
Scope level    : 1
Enclosing scope: None
Scope (Scoped symbol table) contents
------------------------------------
INTEGER: <BuiltinTypeSymbol(name='INTEGER')>
   REAL: <BuiltinTypeSymbol(name='REAL')>
      x: <VarSymbol(name='x', type='REAL')>
      y: <VarSymbol(name='y', type='REAL')>
  Alpha: <ProcedureSymbol(name=Alpha, parameters=[<VarSymbol(name='a', type='INTEGER')>])>


LEAVE scope: global
```

è¿›ä¸€æ­¥ï¼Œå¯ä»¥å†æµ‹è¯•ä¸€ä¸‹å…·æœ‰é‡å¤å£°æ˜é”™è¯¯çš„Pascal ç¨‹åº[dupiderror.pas](https://github.com/rspivak/lsbasi/blob/master/part14/dupiderror.pas)ï¼Œæ£€æŸ¥ä¸‹è¾“å‡ºï¼š  
```pascal
program Main;
   var x, y: real;

   procedure Alpha(a : integer);
      var y : integer;
      var a : real;  { ERROR here! }
   begin
      x := a + x + y;
   end;

begin { Main }

end.  { Main }
```

ä¸‹é¢æ˜¯ç¨‹åºçš„è¾“å‡ºï¼š  
```shell-session
$ python scope05.py dupiderror.pas
ENTER scope: global
Insert: INTEGER
Insert: REAL
Lookup: REAL. (Scope name: global)
Lookup: x. (Scope name: global)
Insert: x
Lookup: REAL. (Scope name: global)
Lookup: y. (Scope name: global)
Insert: y
Insert: Alpha
ENTER scope: Alpha
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Insert: a
Lookup: INTEGER. (Scope name: Alpha)
Lookup: INTEGER. (Scope name: global)
Lookup: y. (Scope name: Alpha)
Insert: y
Lookup: REAL. (Scope name: Alpha)
Lookup: REAL. (Scope name: global)
Lookup: a. (Scope name: Alpha)
Error: Duplicate identifier 'a' found
```  

æˆåŠŸæ•è·åˆ°é”™è¯¯ï¼ä»Šå¤©çš„æ–°å†…å®¹å°±åˆ°æ­¤ç»“æŸäº†ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹ä»Šå¤©å­¦åˆ°çš„å†…å®¹ã€‚  

## æ€»ç»“  
ä»Šå¤©æˆ‘ä»¬å­¦åˆ°äº†å¾ˆå¤šï¼Œå¿«é€Ÿå›å¿†ä¸€ä¸‹ï¼š  
- å­¦ä¹ äº†ä½œç”¨åŸŸï¼Œä»¥åŠä¸ºå•¥ä½œç”¨åŸŸä¼šæœ‰ç”¨å¦‚ä½•åœ¨ä»£ç ä¸­å®ç°ï¼›  
- å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ä½œç”¨åŸŸç¬¦å·è¡¨å»å®ç°åµŒå¥—çš„ä½œç”¨åŸŸï¼›  
- å¦‚ä½•åˆ©ç”¨è¯­ä¹‰åˆ†æå™¨æ„å»ºé“¾å¼çš„ä½œç”¨åŸŸç¬¦å·è¡¨ï¼›  
- å¦‚ä½•é€’å½’åœ°åœ¨ä¸åŒä½œç”¨åŸŸä¸­è§£æç¬¦å·åï¼›  
- å¦‚ä½•ä»¥ç±»ä¼¼æ ˆæ“ä½œçš„å½¢å¼ä¿®æ”¹å’Œæ¢å¤å½“å‰çš„ä½œç”¨åŸŸï¼›  
- å¦‚ä½•ç¼–å†™æºåˆ°æºçš„ç¼–è¯‘å™¨ï¼Œç”¨äºå¸®åŠ©æˆ‘ä»¬å­¦ä¹ ä½œç”¨åŸŸåµŒå¥—ç›¸å…³çš„çŸ¥è¯†ã€‚

## ç»ƒä¹ 
è¯¾åæ´»åŠ¨æ—¶é—´ï¼Œoh yeahï¼  
![](../_resources/lsbasi_part14_img22.png)  

1. æ–‡ç« ä¸­çš„`Main` ç¬¦å·çš„ä¸‹æ ‡éƒ½æ˜¯0ï¼Œæˆ‘ä»¬ä¹Ÿæ›¾æåˆ°è¿‡ç¨‹åºåä¸åœ¨globa ä½œç”¨åŸŸå†…ï¼Œè€Œæ˜¯åœ¨æœ€æœ€å¤–å±‚lv0 çš„ä½œç”¨åŸŸä¸­ã€‚è¯·æ‰©å±•[spi.py](https://github.com/rspivak/lsbasi/blob/master/part14/spi.py)åˆ›å»ºä¸€ä¸ªå†…ç½®ä½œç”¨åŸŸ`builtin`ï¼Œæ·±åº¦ä¸º0ã€‚å¹¶ä¸”å°†å†…ç½®ç±»å‹å’Œç¨‹åºåç§»åˆ°å…¶ä¸­ã€‚  
2. å¯¹Pascal ä»£ç [nestedscopes04.pas](https://github.com/rspivak/lsbasi/blob/master/part14/nestedscopes04.pas) åšå¦‚ä¸‹ä¿®æ”¹ï¼š  
   1. æŠŠPascal æºç å†™åœ¨çº¸ä¸Š  
   2. ç»™å…¶ä¸­æ‰€æœ‰çš„ç¬¦å·æ‰“ä¸Šä¸‹æ ‡  
   3. ç”»å‡ºä»£è¡¨ä½œç”¨åŸŸèŒƒå›´çš„ç«–çº¿ï¼Œåˆ«å¿˜äº†å˜é‡è¢«é®è”½æ—¶ç«–çº¿åº”è¯¥æœ‰ç¼ºå£  
   4. ç¼–å†™ä¸€ä¸ªæºåˆ°æºçš„ç¿»è¯‘å™¨  
   5. ç”¨[src2srccompiler.py](https://github.com/rspivak/lsbasi/blob/master/part14/src2srccompiler.py) æ£€æŸ¥ä½ çš„ç¼–è¯‘å™¨å’Œä¸Šé¢çš„å…¶ä»–æ“ä½œæ˜¯å¦æ­£ç¡®  
3. ä¿®æ”¹æºåˆ°æºçš„ç¼–è¯‘å™¨ï¼Œä½¿å…¶å¯ä»¥ç»™å†…ç½®ç±»å‹æ‰“ä¸Šä½œç”¨åŸŸçš„ä¸‹æ ‡  
4. å–æ¶ˆ[spi.py](https://github.com/rspivak/lsbasi/blob/master/part14/spi.py) ä¸­ä¸‹é¢çš„æ³¨é‡Šï¼š
    ```python
    # interpreter = Interpreter(tree)
    # result = interpreter.interpret()
    # print('')
    # print('Run-time GLOBAL_MEMORY contents:')
    # for k, v in sorted(interpreter.GLOBAL_MEMORY.items()):
    #     print('%s = %s' % (k, v))
    ```
    
    ç„¶åè®©å®ƒæ‰§è¡Œ[part10.pas](https://github.com/rspivak/lsbasi/blob/master/part10/python/part10.pas)ï¼š 
    ```shell-session
    $ python spi.py part10.pas
    ```  
    
    å‘ç°é—®é¢˜ï¼Œå¹¶åœ¨è¯­ä¹‰åˆ†æå™¨ä¸­è¡¥å…¨ç¼ºå¤±çš„æ–¹æ³•ã€‚  

ä»¥ä¸Šå°±æ˜¯ä»Šå¤©çš„å…¨éƒ¨å†…å®¹ã€‚åç»­æˆ‘ä»¬å°†ä¼šå­¦ä¹ è¿è¡Œæ—¶ï¼ˆruntimeï¼‰ï¼Œè°ƒç”¨æ ˆï¼Œè¿‡ç¨‹è°ƒç”¨çš„æ¦‚å¿µï¼Œå¹¶ä¸”ä¼šç¼–å†™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ±‚é˜¶ä¹˜çš„æ–¹æ³•ã€‚æ•¬è¯·å…³æ³¨ï¼Œå†è§ï¼  

## å‚è€ƒèµ„æ–™  
æœ‰å…´è¶£çš„è¯å¯ä»¥é˜…è¯»ä»¥ä¸‹ä¹¦ç±ï¼Œæ–‡ä¸­æœ‰å¤šå¤„å¯¹å®ƒä»¬çš„å¼•ç”¨ä¸å‚è€ƒï¼š  
1. [Language Implementation Patterns: Create Your Own Domain-Specific and General Programming Languages (Pragmatic Programmers)](http://www.amazon.com/gp/product/193435645X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=193435645X&linkCode=as2&tag=russblo0b-20&linkId=MP4DCXDV6DJMEJBL)  
2. [Engineering a Compiler, Second Edition](https://www.amazon.com/gp/product/012088478X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=012088478X&linkCode=as2&tag=russblo0b-20&linkId=74578959d7d04bee4050c7bff1b7d02e)  
3. [Programming Language Pragmatics, Fourth Edition](https://www.amazon.com/gp/product/0124104096/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0124104096&linkCode=as2&tag=russblo0b-20&linkId=8db1da254b12fe6da1379957dda717fc)  
4. [Compilers: Principles, Techniques, and Tools (2nd Edition)](http://www.amazon.com/gp/product/0321486811/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0321486811&linkCode=as2&tag=russblo0b-20&linkId=GOEGDQG4HIHU56FQ)   
5. [Writing Compilers and Interpreters: A Software Engineering Approach](https://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0470177071&linkCode=as2&tag=russblo0b-20&linkId=542d1267e34a529e0f69027af20e27f3)  


-----  
2022-07-07 21:01